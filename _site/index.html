<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>JY</title>
	
	<meta name="author" content="JY">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/liujingyu">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:jingyu525@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
                <img src="/assets/media/dragon.jpeg" class="img-circle" />
				JY
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="background: url(/assets/media/sky.png) no-repeat !important;">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
        <img src="/assets/media/dragon.jpeg" class="img-circle"  height="150" width="150" />
	</a>
	<h3 class="title">
        <a href="/">JY</a>
    </h3>
</header>



<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/liujingyu">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:jingyu525@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
	<ul class="list-unstyled list-inline">
		<li>
            <a class="btn btn-default btn-sm" href="/about">
                关于
			</a>
		</li>
		<li>
            <a class="btn btn-default btn-sm" href="/elasticsearch">
                elasticsearch
			</a>
		</li>
		<li>
            <a class="btn btn-default btn-sm" href="/open-source">
                开源项目
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>JY </h1>
</div>



<article class="home">

  <span class="post-date">
    
    July
    15th,
    
    2020
  </span>

  <h2>
    <a href="/io/2020/07/15/io.html">IO</a>
  </h2>

  <div>
    
    <h2 id="定义">定义</h2>

<p>I/O（英语：Input/Output），即输入／输出，通常指数据在存储器（内部和外部）或其他周边设备之间的输入和输出，是信息处理系统（例如计算机）与外部世界（可能是人类或另一信息处理系统）之间的通信。输入是系统接收的信号或数据，输出则是从其发送的信号或数据。</p>

<p>冯•诺伊曼计算机的基本思想中有提到计算机硬件组成应为五大部分：控制器，运算器，存储器，输入和输出。这里的输入和输出就指IO。</p>

<h2 id="输入设备">输入设备</h2>
<ul>
  <li>键盘</li>
  <li>定点设备</li>
  <li>指点杆</li>
  <li>鼠标</li>
  <li>触控板</li>
  <li>轨迹球</li>
  <li>扫描仪</li>
  <li>麦克风</li>
  <li>相机</li>
</ul>

<h2 id="输出设备">输出设备</h2>
<ul>
  <li>屏幕、投影机</li>
  <li>打印机、</li>
  <li>扬声器、耳机</li>
  <li>闪光灯</li>
</ul>

<h2 id="双向设备">双向设备</h2>

<ul>
  <li>存储设备，如RAM</li>
  <li>一部分USB和火线设备</li>
  <li>触摸屏</li>
  <li>刻录机</li>
  <li>ADSL</li>
  <li>ATM</li>
  <li>USB</li>
</ul>

<h2 id="应用程序角度分析">应用程序角度分析</h2>

<p>换句话说应用程序发起的一次IO操作实际包含两个阶段：</p>
<ol>
  <li>IO调用阶段：应用程序进程向内核发起系统调用</li>
  <li>
    <p>IO执行阶段：内核执行IO操作并返回</p>

    <p>a. 准备数据阶段：内核等待I/O设备准备好数据</p>

    <p>b. 拷贝数据阶段：将数据从内核缓冲区拷贝到用户空间缓冲区</p>
  </li>
</ol>

<p><img src="/assets/media/cVOJvNOsAX-compress.jpg" alt="IO-1" /></p>

<p>内核空间角度图示</p>

<p><img src="/assets/media/JWgHKpW5xX-compress.jpg" alt="IO-2" /></p>

<p>应用程序中进程在发起IO调用后至内核执行IO操作返回结果之前，若发起系统调用的线程一直处于等待状态，则此次IO操作为阻塞IO。阻塞IO简称BIO，Blocking IO。</p>

<p>BIO带来了一个问题：如果内核数据需要耗时很久才能准备好，那么用户进程将被阻塞，浪费性能。</p>

<p>那解决方案自然也容易想到，将阻塞变为非阻塞，那就是用户进程在发起系统调用时指定为非阻塞，内核接收到请求后，就会立即返回，然后用户进程通过轮询的方式来拉取处理结果。非阻塞IO简称NIO，Non-Blocking IO。
<img src="/assets/media/RPXNofb2wC-compress.jpg" alt="IO-3" /></p>

<p>NIO带来了一个问题：就是频繁轮询导致的无效系统调用。</p>

<p>解决NIO的思路就是降解无效的系统调用。</p>

<ul>
  <li>IO多路复用之select/poll</li>
</ul>

<p>select是内核提供的系统调用，它支持一次查询多个系统调用的可用状态，当任意一个结果状态可用时就会返回，用户进程再发起一次系统调用进行数据读取。换句话说，就是NIO中N次的系统调用，借助select，只需要发起一次系统调用就够了。</p>

<p><img src="/assets/media/suSYRFwAhA-compress.jpg" alt="IO-4" /></p>

<p>select/poll 虽然解决了NIO重复无效系统调用用的问题，但同时又引入了新的问题。问题是：</p>
<ol>
  <li>用户空间和内核空间之间，大量的数据拷贝</li>
  <li>内核循环遍历IO状态，浪费CPU时间。</li>
</ol>

<p>针对select/poll引入的问题，我们把解决问题的思路转回到内核上，如何减少内核重复无效的循环遍历呢？变主动为被动，基于事件驱动来实现。</p>

<p><img src="/assets/media/yhNnMCuNCs-compress.jpg" alt="IO-6" /></p>

<p>epoll，已经大大优化了IO的执行效率，但在IO执行的第一阶段：数据准备阶段都还是被阻塞的。所以这是一个可以继续优化的点。</p>

<p>异步IO真正实现了IO全流程的非阻塞。用户进程发出系统调用后立即返回，内核等待数据准备完成，然后将数据拷贝到用户进程缓冲区，然后发送信号告诉用户进程IO操作执行完毕。
<img src="/assets/media/MCsqfcaP1E-compress.jpg" alt="IO-5" /></p>

<p>所以，之所以称为异步IO，取决于IO执行的第二阶段是否阻塞。因此前面讲的BIO，NIO均为同步IO。</p>

<h2 id="参考">参考</h2>
<ul>
  <li>https://zh.wikipedia.org/wiki/I/O</li>
</ul>


    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    June
    9th,
    
    2020
  </span>

  <h2>
    <a href="/system%20design/2020/06/09/Queuing-system.html">排队系统设计</a>
  </h2>

  <div>
    
    <h2 id="问题描述">问题描述</h2>

<p>请设计一个排队系统，能够让每个进入队伍的用户都能看到自己在队列中所处的位置和变化，队伍可能随时有人加入和退出；当有人退出影响到用户的位置排名时需要及时反馈到用户。</p>

<p>这是一道系统设计题。</p>

<p>我们先分析一下题干。就是我们平常去吃饭，前面排老长队，取一个号等着叫号类似。</p>

<p>假设用户ID为数字：<code class="highlighter-rouge">1，3，4，8， 10。</code>
模拟题干的排队行为。
一开始排队系统为空。
此时，第一个用户1进入，排队系统1
第二个用户进入，排队系统1，3</p>

<p>以此类推，<code class="highlighter-rouge">1，3，4，8，10</code>已进入排队系统。
我们需要知道排队系统的长度，也就是下一个加入用户的位置。
需要通过用户ID查到该用户的位置，此时，我们很容易想到<code class="highlighter-rouge">hashtable</code>，用户ID当做key，位置当做值。</p>

<p>用户8退出，此时，查询用户8所在的位置，需要清空<code class="highlighter-rouge">hashtable</code>中用户8的记录，一次遍历用户8以后的节点，并更新对应的<code class="highlighter-rouge">hashtable</code>中位置信息，最后删除用户8节点。这个队列非常像我们平常使用的链表。</p>

<p>结论就是利用<code class="highlighter-rouge">hashtable+linked list</code>两个主要数据结构实现。</p>

<p>解决此类问题，与我们分析数学证明题的思路相似。</p>

<p>该问题的引申，比如我们去银行办理业务，一般分为普通用户和贵宾用户，普通用户排队时，一会来了一个贵宾用户，就插队了。</p>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    June
    5th,
    
    2020
  </span>

  <h2>
    <a href="/data%20structure/2020/06/05/dp.html">动态规划学习笔记</a>
  </h2>

  <div>
    
    <h2 id="介绍">介绍</h2>

<p>动态规划(dynamic programming)是运筹学的一个分支，是求解决策过程(decision process)最优化的数学方法。 [1]  20世纪50年代初美国数学家R.E.Bellman等人在研究多阶段决策过程(multistep decision process)的优化问题时，提出了著名的最优化原理(principle of optimality)，把多阶段过程转化为一系列单阶段问题，利用各阶段之间的关系，逐个求解，创立了解决这类过程优化问题的新方法——动态规划。1957年出版了他的名著《Dynamic Programming》，这是该领域的第一本著作。</p>

<h2 id="分类">分类</h2>

<p>动态规划一般可分为线性动规，区域动规，树形动规，背包动规四类。</p>

<p>举例：</p>

<ul>
  <li>线性动规：拦截导弹，合唱队形，挖地雷，建学校，剑客决斗等；</li>
  <li>区域动规：石子合并， 加分二叉树，统计单词个数，炮兵布阵等；</li>
  <li>树形动规：贪吃的九头龙，二分查找树，聚会的欢乐，数字三角形等；</li>
  <li>背包问题：01背包问题，完全背包问题，分组背包问题，二维背包，装箱问题，挤牛奶（同济ACM第1132题）等；</li>
</ul>

<h2 id="概念的意义">概念的意义</h2>

<p>动态规划问世以来，在经济管理、生产调度、工程技术和最优控制等方面得到了广泛的应用。例如最短路线、库存管理、资源分配、设备更新、排序、装载等问题，用动态规划方法比用其它方法求解更为方便。</p>

<h2 id="思想与性质">思想与性质</h2>

<p>动态规划最重要的是掌握他的思想，动态规划的核心思想是把原问题分解成子问题进行求解，也就是分治的思想。</p>

<h2 id="实现套路">实现套路</h2>

<p>我们实现动态规划算法，常用的是2个实现套路，一个是自底向上，另外一个是自顶向下。无论是何种方式，我们都要明确动态规划的过程，把状态表示、状态转移、边界都考虑好。</p>

<h2 id="问题">问题</h2>

<h3 id="换硬币问题">换硬币问题</h3>
<p><code class="highlighter-rouge">想兑换100元钱，有1,2,5,10四种钱，问总共有多少兑换方法。 </code></p>

<p>解:
推到过程,也可以用于写完代码将其当成测试用例。</p>
<ul>
  <li>f(0) = 1 设置一个初始值</li>
  <li>f(1) = f(0)</li>
  <li>f(2) = f(1) + f(0)</li>
  <li>f(3) = f(2) + f(1)</li>
  <li>……</li>
  <li>f(n) = f(n-1) + f(n-2) + f(n-5) + f(n-10)</li>
  <li>f(n)，n &gt;= 0</li>
</ul>

<p>边界 <code class="highlighter-rouge">n &gt;= 0</code></p>

<p>状态表示 <code class="highlighter-rouge">f(n)</code></p>

<p>状态转移方程 <code class="highlighter-rouge">f(n) = f(n-1) + f(n-2) + f(n-5) + f(n-10)</code></p>

<p>转化成代码:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">coin</span><span class="p">(</span><span class="nv">$inputValue</span><span class="p">,</span> <span class="nv">$coins</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$middle</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$len</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$coins</span><span class="p">);</span>
    <span class="nv">$middle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nv">$n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$n</span> <span class="o">&lt;=</span> <span class="nv">$inputValue</span><span class="p">;</span> <span class="nv">$n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$len</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$middle</span><span class="p">[</span><span class="nv">$n</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$middle</span><span class="p">[</span><span class="nv">$n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$n</span> <span class="o">-</span> <span class="nv">$coins</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$middle</span><span class="p">[</span><span class="nv">$n</span><span class="p">]</span> <span class="o">+=</span> <span class="nv">$middle</span><span class="p">[</span><span class="nv">$n</span><span class="o">-</span><span class="nv">$coins</span><span class="p">[</span><span class="nv">$i</span><span class="p">]];</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$middle</span><span class="p">[</span><span class="nv">$inputValue</span><span class="p">];</span>
<span class="p">}</span>

<span class="nv">$coins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">];</span>
<span class="nv">$inputValue</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

<span class="k">echo</span> <span class="nx">coin</span><span class="p">(</span><span class="nv">$inputValue</span><span class="p">,</span> <span class="nv">$coins</span><span class="p">);</span>

</code></pre></div></div>

<h3 id="最大连续子数组和"><code class="highlighter-rouge">最大连续子数组和</code></h3>

<p>输入一个整形数组，数组里有正数也有负数。数组中连续的一个或多个整数组成一个子数组，每个子数组都有一个和。 求所有子数组的和的最大值，要求时间复杂度为O(n)。</p>

<p>例如输入的数组为<code class="highlighter-rouge">1, -2, 3, 10, -4, 7, 2, -5，</code>和最大的子数组为<code class="highlighter-rouge">3, 10, -4, 7, 2，</code> 因此输出为该子数组的和18。</p>

<p>推到过程：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g(1) = g(0) + 1
f(1) = max(g(1), f(0)) = 1

g(2) = max(g(1) + (-2), 0) = 0
f(2) = max(g(2), f(1)) = 1

g(3) = max(g(2) + 3, 0) = 3
f(3) = max(g(3), f(2)) = 3

g(4) = max(g(3) + 10, 0) = 13
f(4) = max(g(4), f(3)) = 13

g(5) = max(g(4) + (-4), 0) = 9
f(5) = max(g(5), f(4)) = 13

g(6) = max(g(5) + 7, 0) = 16
f(6) = max(g(6), f(5)) = 16

g(7) = max(g(6) + 2, 0) = 18
f(7) = max(g(7), f(6)) = 18

g(8) = max(g(7) + (-5), 0) = 13
f(8) = max(g(8), f(7)) = 18

...

g(n) = max(g(n-1) + arr[n], 0)
f(n) = max(g(n), f(n-1))
</code></pre></div></div>

<p>边界：</p>

<p><code class="highlighter-rouge">n &gt; 0</code></p>

<p>初始值定义:</p>

<p><code class="highlighter-rouge">g(0) = 0; f(0) = -0xFFFFFFFF;</code></p>

<p>状态表示
g(n) 表示累积到当前的和，和小于0，从下一个数字重新计算
f(n) 表示当前和最大值</p>

<p>状态转移方程
g(n) = max(g(n-1) + arr[n], 0)
f(n) = max(g(n), f(n-1))</p>

<p>代码如下:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">maxSum</span><span class="p">(</span><span class="nv">$arr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$f</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0xFFFFFFFF</span><span class="p">;</span>
    <span class="nv">$l</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$l</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$g</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$g</span> <span class="o">=</span> <span class="nv">$arr</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$g</span> <span class="o">+=</span> <span class="nv">$arr</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$f</span> <span class="o">&lt;</span> <span class="nv">$g</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$f</span> <span class="o">=</span> <span class="nv">$g</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$f</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nx">maxSum</span><span class="p">([</span>
    <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span>
<span class="p">]);</span>

</code></pre></div></div>

<h3 id="交替字符串"><code class="highlighter-rouge">交替字符串</code></h3>

<p>输入三个字符串s1、s2和s3，判断第三个字符串s3是否由前两个字符串s1和s2交错而成，即不改变s1和s2中各个字符原有的相对顺序，例如当s1 = “aabcc”，s2 = “dbbca”，s3 = “aadbbcbcac”时，则输出true，但如果s3=“accabdbbca”，则输出false。</p>

<p>推到过程:
s1字符索引用i表示,s2字符索引用j表示，s3字符索引用k表示。</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>i = 1, j = 0, k = 1;
i = 2, j = 0, k = 2;
i = 2, j = 1, k = 3;
i = 3, j = 1, k = 4;
i = 3, j = 2, k = 5;
i = 4, j = 2, k = 6;
i = 4, j = 3, k = 7;
&lt;组成k的情况可能有两种，可能来自s1，也能可能来自于s2&gt;
i = 4, j = 4, k = 8; i = 5, j = 3, k = 8;
i = 4, j = 5, k = 9;
i = 5, j = 5, k = 10;
</code></pre></div></div>

<p>由此可以知：<code class="highlighter-rouge">k=i+j-1</code> 进而用<code class="highlighter-rouge">dp[i][j]</code>表示状态,用一维数组无法表示两个状态，因为s3字符来源由s1或s2，所以是两种状态。</p>

<p>状态表示:
<code class="highlighter-rouge">dp[i][j] </code>代表<code class="highlighter-rouge">s3[0...i+j-1]</code>是否由<code class="highlighter-rouge">s1[0..i-1]</code>和<code class="highlighter-rouge">s2[0...j-1]</code>的字符组成</p>

<p>状态转移方程：
<code class="highlighter-rouge">dp[i][j] = ((s1[i-1] == s3[i+j-1]) &amp;&amp; dp[i-1][j] || (s2[j-1] == s3[i+j-1]) &amp;&amp; dp[i][j-1])</code></p>

<p>边界:</p>

<p>空串可以由空串组成</p>

<p>代码如下:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">alternate_str</span><span class="p">(</span><span class="nv">$s1</span><span class="p">,</span> <span class="nv">$s2</span><span class="p">,</span> <span class="nv">$s3</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$l1</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$s1</span><span class="p">);</span>
    <span class="nv">$l2</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$s2</span><span class="p">);</span>
    <span class="nv">$l3</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$s3</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$l1</span> <span class="o">+</span> <span class="nv">$l2</span> <span class="o">!==</span> <span class="nv">$l3</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$dp</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$dp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="nv">$l1</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;=</span> <span class="nv">$l2</span><span class="p">;</span> <span class="nv">$j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$dp</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">||</span>
                <span class="p">(</span><span class="nv">$i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$dp</span><span class="p">[</span><span class="nv">$i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">==</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nv">$s1</span><span class="p">[</span><span class="nv">$i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$s3</span><span class="p">[</span><span class="nv">$i</span><span class="o">+</span><span class="nv">$j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">||</span>
                <span class="p">(</span><span class="nv">$j</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$dp</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nv">$s2</span><span class="p">[</span><span class="nv">$j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$s3</span><span class="p">[</span><span class="nv">$i</span><span class="o">+</span><span class="nv">$j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$dp</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$dp</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$dp</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$dp</span><span class="p">[</span><span class="nv">$l1</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="nv">$l2</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="nv">$s1</span> <span class="o">=</span> <span class="s1">'aabcc'</span><span class="p">;</span>
<span class="nv">$s2</span> <span class="o">=</span> <span class="s1">'dbbca'</span><span class="p">;</span>
<span class="nv">$s3</span> <span class="o">=</span> <span class="s1">'aadbbcbcac'</span><span class="p">;</span>

<span class="k">echo</span> <span class="nx">alternate_str</span><span class="p">(</span><span class="nv">$s1</span><span class="p">,</span> <span class="nv">$s2</span><span class="p">,</span> <span class="nv">$s3</span><span class="p">);</span>

</code></pre></div></div>

<h2 id="参考">参考</h2>

<ul>
  <li>https://baike.baidu.com/item/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/529408?fr=aladdin</li>
  <li>https://baijiahao.baidu.com/s?id=1631319141857419948&amp;wfr=spider&amp;for=pc</li>
  <li>https://github.com/julycoding/The-Art-Of-Programming-By-July/blob/master/ebook/zh/02.05.md</li>
  <li>https://github.com/julycoding/The-Art-Of-Programming-By-July/blob/master/ebook/zh/05.04.md</li>
</ul>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    May
    26th,
    
    2020
  </span>

  <h2>
    <a href="/encapsulation/2020/05/26/ctrip-client-sdk.html">携程酒店SDK封装</a>
  </h2>

  <div>
    
    <p>最近做的分销业务，携程只提供了HTTP API，没有提供php sdk。这方面，淘宝做的不错（飞猪）直接点击下载sdk。</p>

<p>虽然提供了两个客户端sdk，跟现有框架融合是一个问题。淘宝的sdk直接利用<code class="highlighter-rouge">composer</code>包的方式加载:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╰─$ ls -lh .
total 744
-rw-r--r--   1 martin  staff   6.3K  5 23 16:48 README.md
....
-rw-r--r--   1 martin  staff   229B  5  8 12:02 codeception.yml
-rw-r--r--   1 martin  staff   3.0K  5 26 17:33 composer.json
-rw-r--r--   1 martin  staff   327K  5 26 17:33 composer.lock
-rw-r--r--   1 martin  staff    15K  5 26 17:33 symfony.lock
lrwxr-xr-x   1 martin  staff    43B  5  8 12:02 taobao-sdk -&gt; taobao-sdk-PHP-auto_1568088312300-20191114/
drwxr-xr-x  11 martin  staff   352B  5  8 12:02 taobao-sdk-PHP-auto_1568088312300-20191114
drwxr-xr-x  53 martin  staff   1.7K  5 26 17:33 vendor
</code></pre></div></div>

<p>composer.json再加入仓库引入源:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    },
    "repositories": [
        {
            "type": "path",
            "url": "./taobao-sdk"
        }
    ],
    "minimum-stability":"dev"
}
</code></pre></div></div>
<p>这样就纳入了包管理。</p>

<p>淘宝的sdk，需要增加一个<code class="highlighter-rouge">composer.json</code>文件。</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "name": "martin/taobao-sdk",
    "authors": [
        {
            "name": "liujingyu",
            "email": "liujingyu@xiaozhu.com"
        }
    ],
    "require": {},
    "autoload":{
        "classmap": [
            "top/",
            "aliyun/",
            "dingtalk/",
            "QimenCloud/"
        ]
    },
    "minimum-stability":"dev"
}
</code></pre></div></div>

<p>安装可。</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer install martin/taobao-sdk
</code></pre></div></div>

<p>接下来聊聊，携程sdk<code class="highlighter-rouge">https://dev.ctrip.com/#/document?id=83</code>。
基于携程接口特点设计如下:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">class</span> <span class="nc">CtripConfig</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">SOURCE</span> <span class="o">=</span> <span class="nx">CommonSetting</span><span class="o">::</span><span class="na">CTRIP</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">MODE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">FORMAT</span> <span class="o">=</span> <span class="s1">'json'</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">REFRESH_TOKEN_EXPIRE</span> <span class="o">=</span> <span class="mi">900</span><span class="p">;</span> <span class="c1">// expire 15min</span>

    <span class="c1">// 携程API列表</span>
    <span class="k">const</span> <span class="no">API_LIST</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1">// api_name</span>
        <span class="c1">// @see ....</span>
        <span class="c1">//'api_name' =&gt; [</span>
            <span class="c1">//'path' =&gt; [</span>
                <span class="c1">//'prod' =&gt; '',</span>
                <span class="c1">//'test' =&gt; '',</span>
                <span class="c1">//'dev' =&gt; '',</span>
                <span class="c1">//'*' =&gt; '',</span>
            <span class="c1">//],</span>
        <span class="c1">//],</span>

        <span class="c1">// 获取全量城市信息</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=121</span>
        <span class="s1">'getAllCityInfo'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'f321ca3356b643ec8e32db0aec6a4b70'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'da97859659134aab9bfea1afbfa96d83'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'da97859659134aab9bfea1afbfa96d83'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'da97859659134aab9bfea1afbfa96d83'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span> <span class="c1">// 每分钟200次</span>
        <span class="p">],</span>

        <span class="c1">// 获取酒店清单</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=144</span>
        <span class="s1">'getHotelList'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'3a46e1d3100d46d8a46f52c3dc6b0273'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'4c81467f1e5843fbb0a5eaba23906d70'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'4c81467f1e5843fbb0a5eaba23906d70'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'4c81467f1e5843fbb0a5eaba23906d70'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span> <span class="c1">// 每分钟200次</span>
        <span class="p">],</span>

        <span class="c1">// 获取酒店静态信息</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=145</span>
        <span class="s1">'getHotelStaticInfo'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'becf5b5008064a26be77cac065688ca7'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'62a8bb573582435bbe8b361334efe36f'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'62a8bb573582435bbe8b361334efe36f'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'62a8bb573582435bbe8b361334efe36f'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span> <span class="c1">//每分钟600</span>
        <span class="p">],</span>

        <span class="c1">// 获取房型静态信息</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=146</span>
        <span class="s1">'getRoomTypeStaticInfo'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'39122604bf0e4b33a9569658cf273161'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'c04d1d7b7af449999dba88896fcc0811'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'c04d1d7b7af449999dba88896fcc0811'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'c04d1d7b7af449999dba88896fcc0811'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span> <span class="c1">//每分钟600</span>
        <span class="p">],</span>

        <span class="c1">// 监测静态信息变化</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=56</span>
        <span class="s1">'listenStaticInfo'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'66fd1e3089fb448e912808cccbe017c0'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'d0e65061aef24f88854031c60cabfd91'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'d0e65061aef24f88854031c60cabfd91'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'d0e65061aef24f88854031c60cabfd91'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'filter'</span> <span class="o">=&gt;</span> <span class="s1">'ChangeInfos'</span><span class="p">,</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">1000</span><span class="p">,</span> <span class="c1">// 每分钟1000次</span>
        <span class="p">],</span>

        <span class="c1">// 监测房价、房量、房态增量变化接口</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=98</span>
        <span class="s1">'listenRoomPriceNumberStatus'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'a8f721b9716a41ca9df8b326f10655df'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'68c959f3d5a94d7ca4ddd97cbe97d424'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'68c959f3d5a94d7ca4ddd97cbe97d424'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'68c959f3d5a94d7ca4ddd97cbe97d424'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'filter'</span> <span class="o">=&gt;</span> <span class="s1">'ChangeInfos'</span><span class="p">,</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">1000</span><span class="p">,</span> <span class="c1">// 每分钟1000次</span>
        <span class="p">],</span>

        <span class="c1">// 监测房型上下线</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=161</span>
        <span class="s1">'listenRoomTypeOnAndOffLine'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'4536a4178961443a937423c1eb8fa2ba'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'ef89b1f6ec8e49d39d5debac065a9a4a'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'ef89b1f6ec8e49d39d5debac065a9a4a'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'ef89b1f6ec8e49d39d5debac065a9a4a'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'filter'</span> <span class="o">=&gt;</span> <span class="s1">'RoomStatusChangeItems'</span><span class="p">,</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="c1">// 每分钟100次</span>
        <span class="p">],</span>

        <span class="c1">// 每日价格拉取接口（仅国内酒店）&lt;落地价&gt;</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=95</span>
        <span class="s1">'fetchLandPrice'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'99503c56b9fa4417a8bc77b92ea56d41'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'99503c56b9fa4417a8bc77b92ea56d41'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'99503c56b9fa4417a8bc77b92ea56d41'</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">],</span>

        <span class="c1">// 报价实时查询接口（国内酒店+海外酒店） &lt;直连价&gt;</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=94</span>
        <span class="s1">'fetchDirectPrice'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'4c15cadb05f14aa9836260c53ab74526'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'14a14763194648f5b9d2427f00b3ca04'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'14a14763194648f5b9d2427f00b3ca04'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'14a14763194648f5b9d2427f00b3ca04'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">6000</span><span class="p">,</span> <span class="c1">//每分钟6000次</span>
        <span class="p">],</span>

        <span class="c1">// 可预订检查</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=62</span>
        <span class="s1">'checkBookAble'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'419f7a688e3c45f481d295708b870323'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'d67d24cfdc2940cd858f506c708cf0d4'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'d67d24cfdc2940cd858f506c708cf0d4'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'d67d24cfdc2940cd858f506c708cf0d4'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">// 订单保存</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=63</span>
        <span class="s1">'saveOrderBook'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'2b0c7e0eebe2467a97be3d284313a129'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'acf5c44749234668ba3c539cc1d26c87'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'acf5c44749234668ba3c539cc1d26c87'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'acf5c44749234668ba3c539cc1d26c87'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">// 订单提交</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=64</span>
        <span class="s1">'submitOrderBook'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'f40c5c71f84745cbbc73238252d9d43c'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'5f3c81bc0c90458ba94bfe2dafea8459'</span><span class="p">,</span>
                <span class="s1">'dev'</span>  <span class="o">=&gt;</span> <span class="s1">'5f3c81bc0c90458ba94bfe2dafea8459'</span><span class="p">,</span>
                <span class="s1">'*'</span>    <span class="o">=&gt;</span> <span class="s1">'5f3c81bc0c90458ba94bfe2dafea8459'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">// 获取订单详情</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=67</span>
        <span class="s1">'getOrderBookDetail'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'e4a2a8ac057f4b378c9e153ef3f35249'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'5db9d7e805ef4b36a8cf0e57900e118a'</span><span class="p">,</span>
                <span class="s1">'dev'</span>  <span class="o">=&gt;</span> <span class="s1">'5db9d7e805ef4b36a8cf0e57900e118a'</span><span class="p">,</span>
                <span class="s1">'*'</span>    <span class="o">=&gt;</span> <span class="s1">'5db9d7e805ef4b36a8cf0e57900e118a'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">// 取消订单</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=68</span>
        <span class="s1">'cancelBookOrder'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'f40a36ac2dfe42518fb883d33fa33391'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'519114d791b94babba31f32eb5d559eb'</span><span class="p">,</span>
                <span class="s1">'dev'</span>  <span class="o">=&gt;</span> <span class="s1">'519114d791b94babba31f32eb5d559eb'</span><span class="p">,</span>
                <span class="s1">'*'</span>    <span class="o">=&gt;</span> <span class="s1">'519114d791b94babba31f32eb5d559eb'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">// 检测订单状态变化</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=66</span>
        <span class="s1">'listenOrderStatusChange'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'e5e981e2cf9340f99f9cbf79c82668ac'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'61aebb32ae1347c5a274fc9fb4b4f962'</span><span class="p">,</span>
                <span class="s1">'dev'</span>  <span class="o">=&gt;</span> <span class="s1">'61aebb32ae1347c5a274fc9fb4b4f962'</span><span class="p">,</span>
                <span class="s1">'*'</span>    <span class="o">=&gt;</span> <span class="s1">'61aebb32ae1347c5a274fc9fb4b4f962'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">//查询某城市下各酒店的起价</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=93</span>
        <span class="s1">'fetchLowerPrice'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'4c6f5dcc4663443b8d8ae044ad8bee10'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'c659a717bf23422b907ff7f9c75022ed'</span><span class="p">,</span>
                <span class="s1">'dev'</span>  <span class="o">=&gt;</span> <span class="s1">'c659a717bf23422b907ff7f9c75022ed'</span><span class="p">,</span>
                <span class="s1">'*'</span>    <span class="o">=&gt;</span> <span class="s1">'c659a717bf23422b907ff7f9c75022ed'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span> <span class="c1">// 每分钟200次</span>
        <span class="p">]</span>
    <span class="p">];</span>

    <span class="cd">/**
     * 根据key获取携程api icode
     *
     * @param $api
     * @return bool|string
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getCtripIcode</span><span class="p">(</span><span class="nv">$api</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$env</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'APP_ENV'</span><span class="p">);</span>
        <span class="nv">$default</span> <span class="o">=</span> <span class="s1">'*'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'path'</span><span class="p">][</span><span class="nv">$env</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'path'</span><span class="p">][</span><span class="nv">$env</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'path'</span><span class="p">][</span><span class="nv">$default</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cd">/**
     * 获取结果过滤器
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getApiFilter</span><span class="p">(</span><span class="nv">$api</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'filter'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'filter'</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">CtripToken</span>
<span class="p">{</span>

    <span class="k">private</span> <span class="nv">$aid</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$sid</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$redis</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$client</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span>
        <span class="nx">ContainerInterface</span> <span class="nv">$container</span><span class="p">,</span>
        <span class="nx">ClientInterface</span> <span class="nv">$redis</span><span class="p">,</span>
        <span class="nx">LoggerInterface</span> <span class="nv">$logger</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span> <span class="o">=</span> <span class="nv">$redis</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'bl_guzzle.client.ctrip'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aid</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_AID'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sid</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_SID'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_KEY'</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="cd">/**
     * (支持分布式获取Token)获取 token.
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">getToken</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SOURCE</span><span class="o">.</span><span class="s2">"_token"</span><span class="p">);</span>
        <span class="nv">$refreshToken</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SOURCE</span><span class="o">.</span><span class="s2">"_refresh_token"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$token</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$token</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 加锁，避免重复刷新token</span>
        <span class="nv">$lock</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s2">"ctrip:lock"</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="s2">"nx"</span><span class="p">,</span> <span class="s2">"ex"</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="nv">$unlock</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$script</span> <span class="o">=</span> <span class="sh">&lt;&lt;&lt;LUA
if redis.call("get",KEYS[1]) == ARGV[1]
then
    return redis.call("del",KEYS[1])
else
    return 0
end
LUA;</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">eval</span><span class="p">(</span><span class="nv">$script</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"ctrip:lock"</span><span class="p">,</span> <span class="nv">$key</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="nv">$key</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>

        <span class="nx">token</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$lock</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$refreshToken</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// token 初始化</span>
                <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
                    <span class="s1">'/openserviceauth/authorize.ashx?'</span> <span class="o">.</span>
                    <span class="nb">http_build_query</span><span class="p">([</span>
                        <span class="s1">'AID'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aid</span><span class="p">,</span>
                        <span class="s1">'SID'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sid</span><span class="p">,</span>
                        <span class="s1">'KEY'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span>
                    <span class="p">])</span>
                <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// token 更新</span>
                <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
                    <span class="s1">'/openserviceauth/refresh.ashx?'</span><span class="o">.</span>
                    <span class="nb">http_build_query</span><span class="p">([</span>
                        <span class="s1">'AID'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aid</span><span class="p">,</span>
                        <span class="s1">'SID'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sid</span><span class="p">,</span>
                        <span class="s1">'refresh_token'</span> <span class="o">=&gt;</span> <span class="nv">$refreshToken</span><span class="p">,</span>
                    <span class="p">])</span>
                <span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// 解锁失败，说明锁超时，返回null，上层进行重试</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$unlock</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span><span class="s1">'unlock failure'</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span><span class="s1">'lock failure'</span><span class="p">);</span>
            <span class="c1">// 未取得锁，上层进行重试</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// 加锁结束</span>

        <span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">!=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">getStatusCode</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">'CTRIP GET Token Http Client error'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'ErrCode'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'ErrCode'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1005</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 重置刷新Token</span>
            <span class="nv">$refreshToken</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">goto</span> <span class="nx">token</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'Expires_In'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'Access_Token'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'Refresh_Token'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">'CTRIP GET TOKNE Http Client error, response data format error:'</span><span class="o">.</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">setex</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SOURCE</span><span class="o">.</span><span class="s2">"_token"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Expires_In'</span><span class="p">],</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Access_Token'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">setex</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SOURCE</span><span class="o">.</span><span class="s2">"_refresh_token"</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">REFRESH_TOKEN_EXPIRE</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Refresh_Token'</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Access_Token'</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">removeCtripAccessToken</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">del</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SOURCE</span><span class="o">.</span><span class="s2">"_token"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">CtripClient</span>
<span class="p">{</span>

    <span class="k">private</span> <span class="nv">$aid</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$sid</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$redis</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$client</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$messageControl</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$apiRateControl</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span>
        <span class="nx">ContainerInterface</span> <span class="nv">$container</span><span class="p">,</span>
        <span class="nx">ClientInterface</span> <span class="nv">$redis</span><span class="p">,</span>
        <span class="nx">MessageControl</span> <span class="nv">$messageControl</span><span class="p">,</span>
        <span class="nx">LoggerInterface</span> <span class="nv">$logger</span><span class="p">,</span>
        <span class="nx">APIRateControl</span> <span class="nv">$apiRateControl</span><span class="p">,</span>
        <span class="nx">Token</span> <span class="nv">$token</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span> <span class="o">=</span> <span class="nv">$redis</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'bl_guzzle.client.ctrip'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">messageControl</span> <span class="o">=</span> <span class="nv">$messageControl</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">apiRateControl</span> <span class="o">=</span> <span class="nv">$apiRateControl</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">token</span> <span class="o">=</span> <span class="nv">$token</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aid</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_AID'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sid</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_SID'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_KEY'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * 支持 API_LIST 里面的所有接口.
     *
     * @param $name
     * @param $arguments
     * @return array
     * @throws FatalException
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__call</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$name</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nx">instanceof</span> <span class="nx">HotelRequest</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDetailData</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">toArray</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\BadMethodCallException</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @param $response
     * @return array|mixed
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">getContent</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">==</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">getStatusCode</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">\GuzzleHttp\json_decode</span><span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">[];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cd">/**
     * 获取数据接口.
     *
     * @param string $api
     * @param array $dataParam
     *
     * @return array
     **/</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">getDetailData</span><span class="p">(</span><span class="nv">$api</span><span class="p">,</span> <span class="nv">$dataParam</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$icode</span> <span class="o">=</span> <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">getCtripIcode</span><span class="p">(</span><span class="nv">$api</span><span class="p">)))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s2">"icode find by api, not found the api:%s"</span><span class="p">,</span> <span class="nv">$api</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="c1">// api 接口测试限制</span>
            <span class="k">if</span> <span class="p">((</span><span class="nv">$coolingSecond</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">apiRateControl</span><span class="o">-&gt;</span><span class="na">getCoolingSecondForAPI</span><span class="p">(</span><span class="nv">$api</span><span class="p">)))</span> <span class="p">{</span>
                <span class="nb">sleep</span><span class="p">(</span><span class="nv">$coolingSecond</span><span class="p">);</span>
            <span class="p">}</span>

<span class="nx">token</span><span class="o">:</span>
            <span class="nv">$token</span> <span class="o">=</span> <span class="nx">Util</span><span class="o">::</span><span class="na">try</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">token</span><span class="o">-&gt;</span><span class="na">getToken</span><span class="p">();</span>
                    <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nv">$token</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'get token retry 3 failure'</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nv">$params</span> <span class="o">=</span> <span class="nb">http_build_query</span><span class="p">([</span>
                    <span class="s1">'AID'</span>   <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aid</span><span class="p">,</span>
                    <span class="s1">'SID'</span>   <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sid</span><span class="p">,</span>
                    <span class="s1">'ICODE'</span> <span class="o">=&gt;</span> <span class="nv">$icode</span><span class="p">,</span>
                    <span class="s1">'UUID'</span>  <span class="o">=&gt;</span> <span class="nx">Util</span><span class="o">::</span><span class="na">getUUID</span><span class="p">(),</span>
                    <span class="s1">'Token'</span> <span class="o">=&gt;</span> <span class="nv">$token</span><span class="p">,</span>
                    <span class="s1">'Mode'</span>  <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">MODE</span><span class="p">,</span>
                    <span class="s1">'Format'</span><span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">FORMAT</span>
            <span class="p">]);</span>

            <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span>
                    <span class="s1">'/openservice/serviceproxy.ashx?'</span><span class="o">.</span><span class="nv">$params</span><span class="p">,</span>
                    <span class="p">[</span>
                    <span class="s1">'json'</span> <span class="o">=&gt;</span> <span class="nv">$dataParam</span>
                    <span class="p">]</span>
                    <span class="p">);</span>

            <span class="nv">$content</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$content</span><span class="p">[</span><span class="s1">'ErrCode'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$content</span><span class="p">[</span><span class="s1">'ErrCode'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">232</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// clear store redis token and retry</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">token</span><span class="o">-&gt;</span><span class="na">removeCtripAccessToken</span><span class="p">();</span>
                <span class="nx">goto</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">((</span><span class="nv">$field</span> <span class="o">=</span> <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">getApiFilter</span><span class="p">(</span><span class="nv">$api</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$content</span><span class="p">[</span><span class="nv">$field</span><span class="p">]))</span> <span class="p">{</span>
                <span class="c1">// 去除重复调用的数据</span>
                <span class="nv">$content</span><span class="p">[</span><span class="nv">$field</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">messageControl</span><span class="o">-&gt;</span><span class="na">filterMessage</span><span class="p">(</span><span class="nv">$content</span><span class="p">[</span><span class="nv">$field</span><span class="p">]);</span>
                <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Throwable</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">'CtripClient Throwable'</span><span class="p">,</span> <span class="p">[</span>
                    <span class="s1">'api'</span> <span class="o">=&gt;</span> <span class="nv">$api</span><span class="p">,</span>
                    <span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nv">$dataParam</span><span class="p">,</span>
                    <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span>
            <span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">successAndReturnLastRecordId</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$successAndReturnLastRecordId</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">success</span><span class="p">(</span><span class="nv">$response</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">'PagingInfo'</span><span class="p">][</span><span class="s1">'LastRecordID'</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">'PagingInfo'</span><span class="p">][</span><span class="s1">'LastRecordID'</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nv">$successAndReturnLastRecordId</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">success</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$success</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">'ResponseStatus'</span><span class="p">][</span><span class="s1">'Ack'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">'ResponseStatus'</span><span class="p">][</span><span class="s1">'Ack'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Success'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nv">$success</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 工具类封装</span>
<span class="kd">class</span> <span class="nc">Util</span>
<span class="p">{</span>
	<span class="c1">// 重试逻辑，正常逻辑和异常逻辑分开</span>
	<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">retry</span><span class="p">(</span><span class="nv">$retries</span><span class="p">,</span> <span class="nx">callable</span> <span class="nv">$fn</span><span class="p">,</span> <span class="nv">$sleep</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$base</span> <span class="o">=</span> <span class="nv">$retries</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

        <span class="nx">beginning</span><span class="o">:</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$fn</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$retries</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$sleep</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 休眠时间递增(单位s), 1, 2, 5</span>
                <span class="nv">$sleepTime</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$base</span> <span class="o">-</span> <span class="nv">$retries</span><span class="p">)</span> <span class="o">/</span> <span class="nv">$retries</span><span class="p">;</span>
                <span class="nb">sleep</span><span class="p">(</span><span class="nv">$sleepTime</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nv">$retries</span><span class="o">--</span><span class="p">;</span>
            <span class="nx">goto</span> <span class="nx">beginning</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">const</span> <span class="no">LOOP_RUN_CONTINUE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">LOOP_NORMAL_STOP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">LOOP_API_EXCEPTION_STOP</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="cd">/**
     * 任务循环器, 可复用,用于分页数据获取.
     *
     * @param $run
     * @param mixed ...$args
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">loop</span><span class="p">(</span><span class="nv">$run</span><span class="p">,</span> <span class="o">...</span><span class="nv">$args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$loop</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$run</span><span class="p">,</span> <span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="c1">// status: 0 循环, 1 正常结束, 2 接口异常结束</span>
                <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$run</span><span class="p">(</span><span class="o">...</span><span class="nv">$args</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nv">$loop</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 携程接口API调用频次记录，并且返回冷却时间</span>
<span class="kd">class</span> <span class="nc">APIRateControl</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$redis</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">KEY_PREFIX</span> <span class="o">=</span> <span class="s1">'ctrip:rate:'</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">ClientInterface</span> <span class="nv">$redis</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span> <span class="o">=</span> <span class="nv">$redis</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * 获取API冷却时间.
     *
     * @param string $api
     * @param string $second
     * @param int $times
     *
     * @return int
     * @throws \Exception
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAPICoolingSecond</span><span class="p">(</span><span class="nv">$api</span><span class="p">,</span> <span class="nv">$second</span><span class="p">,</span> <span class="nv">$times</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$lockedTimes</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$api</span><span class="p">,</span> <span class="nv">$expire</span><span class="p">,</span> <span class="nv">$times</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$script</span> <span class="o">=</span> <span class="sh">&lt;&lt;&lt;LUA
local times = redis.call('incr',KEYS[1])

-- 第一次访问的时候加上过期时间60秒（60秒过后从新计数）
if times == 1 then
    redis.call('expire',KEYS[1], ARGV[1])
end

-- 注意，从redis进来的默认为字符串，lua同种数据类型只能和同种数据类型比较
if times &gt; tonumber(ARGV[2]) then
    return 0
end
return 1
LUA;</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">eval</span><span class="p">(</span><span class="nv">$script</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">KEY_PREFIX</span><span class="o">.</span><span class="nv">$api</span><span class="p">,</span> <span class="nv">$expire</span><span class="p">,</span> <span class="nv">$times</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$lockedTimes</span><span class="p">(</span><span class="nv">$api</span><span class="p">,</span> <span class="nv">$second</span><span class="p">,</span> <span class="nv">$times</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$sleep</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">ttl</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">KEY_PREFIX</span><span class="o">.</span><span class="nv">$api</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$sleep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$sleep</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cd">/**
     * 冷却时间.
     *
     * @param string $api
     *
     * @return int
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCoolingSecondForAPI</span><span class="p">(</span><span class="nv">$api</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'rate'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getAPICoolingSecond</span><span class="p">(</span>
            <span class="nv">$api</span><span class="p">,</span>
            <span class="mi">60</span><span class="p">,</span>
            <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'rate'</span><span class="p">]</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="o">&lt;?</span><span class="nx">php</span>

<span class="kn">use</span> <span class="nn">Adbar\Dot</span><span class="p">;</span>

<span class="cd">/**
 *
 * 使用如下：
 *  // 测试HotelRequest toArray
 * $r = new HotelRequest();
 * $r-&gt;PagingSettings_LastRecordID = 100;
 * $r-&gt;PagingSettings_PageSize = 200;
 * $r-&gt;Settings_ExtendedNodes = [ 'HotelStaticInfo.GeoInfo' ];
 * $r-&gt;Settings_PrimaryLangID = 'zh_cn';
 * echo $r-&gt;toJson(),PHP_EOL;
 * var_dump($r-&gt;toArray());
 */</span>

<span class="kd">class</span> <span class="nc">HotelRequest</span>
<span class="p">{</span>
    <span class="c1">// 格式     'SearchCandidate_HotelID' =&gt; 'SearchCandidate.HotelID',</span>
    <span class="k">const</span> <span class="no">RULES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1">// 酒店</span>
        <span class="s1">'SearchCandidate_HotelID'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.HotelID'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_RoomIDs'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.RoomIDs'</span><span class="p">,</span>
        <span class="s1">'Settings_PrimaryLangID'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.PrimaryLangID'</span><span class="p">,</span>
        <span class="s1">'Settings_ExtendedNodes'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.ExtendedNodes'</span><span class="p">,</span>
        <span class="s1">'Settings_SearchTags'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.SearchTags'</span><span class="p">,</span>
        <span class="s1">'PagingSettings_PageSize'</span> <span class="o">=&gt;</span> <span class="s1">'PagingSettings.PageSize'</span><span class="p">,</span>
        <span class="s1">'PagingSettings_LastRecordID'</span> <span class="o">=&gt;</span> <span class="s1">'PagingSettings.LastRecordID'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_DateTimeRange_Start'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.DateTimeRange.Start'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_DateTimeRange_End'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.DateTimeRange.End'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_StartTime'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.StartTime'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_Duration'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.Duration'</span><span class="p">,</span>
        <span class="s1">'Settings_ShowDataRange'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.ShowDataRange'</span><span class="p">,</span>
        <span class="s1">'Settings_IsShowChangeDetails'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.IsShowChangeDetails'</span><span class="p">,</span>
        <span class="s1">'Settings_DataCategory'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.DataCategory'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_SearchByType_SearchType'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.SearchByType.SearchType'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_SearchByType_IsHaveHotel'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.SearchByType.IsHaveHotel'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_SearchByCityID_CityID'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.SearchByCityID.CityID'</span><span class="p">,</span>

        <span class="c1">// 订单部分 //</span>
        <span class="c1">// 可预订检查</span>
        <span class="s1">'AvailRequestSegments_Version'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.Version'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_TransactionIdentifier'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.TransactionIdentifier'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_HotelRef_HotelCode'</span> <span class="o">=&gt;</span>
        <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.HotelRef.HotelCode'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_StayDateRange_Start'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.StayDateRange.Start'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_StayDateRange_End'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.StayDateRange.End'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RoomID'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RatePlanCandidates.RatePlanCandidate.RoomID'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RatePlanID'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RatePlanCandidates.RatePlanCandidate.RatePlanID'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RatePlanCategory'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RatePlanCandidates.RatePlanCandidate.RatePlanCategory'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_PrepaidIndicator'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RatePlanCandidates.RatePlanCandidate.PrepaidIndicator'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RoomStayCandidates_RoomStayCandidate_GuestCounts_GuestCount_Count'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RoomStayCandidates.RoomStayCandidate.GuestCounts.GuestCount.Count'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RoomStayCandidates_RoomStayCandidate_Quantity'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RoomStayCandidates.RoomStayCandidate.Quantity'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_TPA_Extensions_LateArrivalTime'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.TPA_Extensions.LateArrivalTime'</span><span class="p">,</span>
        <span class="c1">// 保存订单</span>
        <span class="s1">'Version'</span> <span class="o">=&gt;</span> <span class="s1">'Version'</span><span class="p">,</span>
        <span class="s1">'TransactionIdentifier'</span> <span class="o">=&gt;</span> <span class="s1">'TransactionIdentifier'</span><span class="p">,</span>
        <span class="s1">'UniqueID'</span> <span class="o">=&gt;</span> <span class="s1">'UniqueID'</span><span class="p">,</span>
        <span class="s1">'UniqueID_Type'</span> <span class="o">=&gt;</span> <span class="s1">'UniqueID.Type'</span><span class="p">,</span>
        <span class="s1">'UniqueID_ID'</span> <span class="o">=&gt;</span> <span class="s1">'UniqueID.ID'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_RoomTypes_RoomType_NumberOfUnits'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.RoomTypes.RoomType.NumberOfUnits'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RoomID'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.RatePlans.RatePlan.RoomID'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RatePlanCategory'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.RatePlans.RatePlan.RatePlanCategory'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_PrepaidIndicator'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.RatePlans.RatePlan.PrepaidIndicator'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RatePlanID'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.RatePlans.RatePlan.RatePlanID'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_BasicPropertyInfo_HotelCode'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.BasicPropertyInfo.HotelCode'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_PersonName'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.PersonName'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_PersonName_Name'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.ContactPerson.PersonName.Name'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_Telephone_PhoneTechType'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.ContactPerson.Telephone.PhoneTechType'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_Telephone_PhoneNumber'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.ContactPerson.Telephone.PhoneNumber'</span><span class="p">,</span>

        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_ContactType'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.ContactPerson.ContactType'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.ContactPerson'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_TPA_Extensions_LateArrivalTime'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.TPA_Extensions.LateArrivalTime'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_ArrivalTime'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.ArrivalTime'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_GuestCounts_GuestCount_Count'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.GuestCounts.GuestCount.Count'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_TimeSpan_Start'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.TimeSpan.Start'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_TimeSpan_End'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.TimeSpan.End'</span><span class="p">,</span>
        <span class="c1">//'HotelReservations_HotelReservation_ResGlobalInfo_DepositPayments' =&gt; 'HotelReservations.HotelReservation.ResGlobalInfo.DepositPayments',</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_Total_ExclusiveAmount'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.Total.ExclusiveAmount'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_Total_InclusiveAmount'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.Total.InclusiveAmount'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_Total_CurrencyCode'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.Total.CurrencyCode'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_ExclusiveAmount'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.TPA_Extensions.TotalCost.ExclusiveAmount'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_InclusiveAmount'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.TPA_Extensions.TotalCost.InclusiveAmount'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_CurrencyCode'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.TPA_Extensions.TotalCost.CurrencyCode'</span><span class="p">,</span>

        <span class="c1">// 订单提交</span>
        <span class="s1">'ReservationPayment_ReservationID_Type'</span> <span class="o">=&gt;</span> <span class="s1">'ReservationPayment.ReservationID.Type'</span><span class="p">,</span>
        <span class="s1">'ReservationPayment_ReservationID_ID'</span> <span class="o">=&gt;</span> <span class="s1">'ReservationPayment.ReservationID.ID'</span><span class="p">,</span>
        <span class="s1">'ReservationPayment_PaymentDetail'</span> <span class="o">=&gt;</span> <span class="s1">'ReservationPayment.PaymentDetail'</span><span class="p">,</span>
        <span class="s1">'ReservationPayment_Invoice'</span> <span class="o">=&gt;</span> <span class="s1">'ReservationPayment.Invoice'</span><span class="p">,</span>

        <span class="c1">// 监测订单状态变化</span>
        <span class="s1">'HotelReservations'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations'</span><span class="p">,</span>
        <span class="s1">'SearchTypeEntity_SearchType'</span> <span class="o">=&gt;</span> <span class="s1">'SearchTypeEntity.SearchType'</span><span class="p">,</span>
        <span class="s1">'SearchTypeEntity_HotelCount'</span> <span class="o">=&gt;</span> <span class="s1">'SearchTypeEntity.HotelCount'</span><span class="p">,</span>
        <span class="s1">'SearchTypeEntity_PageIndex'</span> <span class="o">=&gt;</span> <span class="s1">'SearchTypeEntity.PageIndex'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_City'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.City'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_CheckInDate'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.CheckInDate'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_CheckOutDate'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.CheckOutDate'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_HotelList'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.HotelList'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_FilterRoomByPerson'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.FilterRoomByPerson'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_OnlyPPPrice'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.OnlyPPPrice'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_OnlyFGPrice'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.OnlyFGPrice'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_IsJustifyConfirm'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.IsJustifyConfirm'</span><span class="p">,</span>
        <span class="s1">'FacilityEntity_ChildrenAgeList'</span> <span class="o">=&gt;</span> <span class="s1">'FacilityEntity.ChildrenAgeList'</span><span class="p">,</span>
        <span class="s1">'FacilityEntity_priceRange_lowPrice'</span> <span class="o">=&gt;</span> <span class="s1">'FacilityEntity.priceRange.lowPrice'</span><span class="p">,</span>
        <span class="s1">'FacilityEntity_priceRange_highPrice'</span> <span class="o">=&gt;</span> <span class="s1">'FacilityEntity.priceRange.highPrice'</span><span class="p">,</span>
        <span class="s1">'OrderBy_OrderName'</span> <span class="o">=&gt;</span> <span class="s1">'OrderBy.OrderName'</span><span class="p">,</span>
        <span class="s1">'OrderBy_OrderType'</span> <span class="o">=&gt;</span> <span class="s1">'OrderBy.OrderType'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_DateRange_Start'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.DateRange.Start'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_DateRange_End'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.DateRange.End'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_Occupancy_Adult'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.Occupancy.Adult'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_Occupancy_Child'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.Occupancy.Child'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_Occupancy_ChildInfo'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.Occupancy.ChildInfo'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_SearchTags'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.SearchTags'</span><span class="p">,</span>
        <span class="s1">'Settings_DisplayCurrency'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.DisplayCurrency'</span><span class="p">,</span>
        <span class="s1">'Settings_IsShowNonBookable'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.IsShowNonBookable'</span><span class="p">,</span>
    <span class="p">];</span>


    <span class="k">public</span> <span class="nv">$Version</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$TransactionIdentifier</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_HotelID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_RoomIDs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_PrimaryLangID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_ExtendedNodes</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_SearchTags</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PagingSettings_PageSize</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PagingSettings_LastRecordID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_DateTimeRange_Start</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_DateTimeRange_End</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_StartTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_Duration</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_ShowDataRange</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_IsShowChangeDetails</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_DataCategory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_SearchByType_SearchType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_SearchByType_IsHaveHotel</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_SearchByCityID_CityID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchTypeEntity_SearchType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchTypeEntity_HotelCount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchTypeEntity_PageIndex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_City</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_CheckInDate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_CheckOutDate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_HotelList</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_FilterRoomByPerson</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_OnlyPPPrice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_OnlyFGPrice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_IsJustifyConfirm</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$FacilityEntity_ChildrenAgeList</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$FacilityEntity_priceRange_lowPrice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$FacilityEntity_priceRange_highPrice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$OrderBy_OrderName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$OrderBy_OrderType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_DateRange_Start</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_DateRange_End</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_Occupancy_Adult</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_Occupancy_Child</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_Occupancy_ChildInfo</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_SearchTags</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_DisplayCurrency</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_IsShowNonBookable</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_HotelRef_HotelCode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_StayDateRange_Start</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_StayDateRange_End</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RoomID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RatePlanID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RatePlanCategory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_PrepaidIndicator</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RoomStayCandidates_RoomStayCandidate_GuestCounts_GuestCount_Count</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RoomStayCandidates_RoomStayCandidate_Quantity</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_TPA_Extensions_LateArrivalTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_Version</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_TransactionIdentifier</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="c1">//public $HotelReservations_HotelReservation_ResGlobalInfo_DepositPayments = [];</span>
    <span class="k">public</span> <span class="nv">$UniqueID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$UniqueID_Type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$UniqueID_ID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_RoomTypes_RoomType_NumberOfUnits</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RoomID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RatePlanCategory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_PrepaidIndicator</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RatePlanID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_BasicPropertyInfo_HotelCode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_PersonName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_PersonName_Name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_Telephone_PhoneTechType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_Telephone_PhoneNumber</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_ContactType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_TPA_Extensions_LateArrivalTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_ArrivalTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_GuestCounts_GuestCount_Count</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_TimeSpan_Start</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_TimeSpan_End</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_Total_ExclusiveAmount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_Total_InclusiveAmount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_Total_CurrencyCode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_ExclusiveAmount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_InclusiveAmount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_CurrencyCode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$ReservationPayment_ReservationID_Type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$ReservationPayment_ReservationID_ID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$ReservationPayment_PaymentDetail</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$ReservationPayment_Invoice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$dot</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">HOTEL_STATIC_INFO_EXTENDED_NODES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"HotelStaticInfo.GeoInfo"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.NearbyPOIs"</span><span class="p">,</span><span class="c1">//已废弃请下线处理</span>
        <span class="s2">"HotelStaticInfo.TransportationInfos"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.Brand"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.Group"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.Ratings"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.Policies"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.AcceptedCreditCards"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.ImportantNotices"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.Facilities"</span><span class="p">,</span> <span class="c1">//已废弃，请切换至FacilitiesV2节点</span>
        <span class="s2">"HotelStaticInfo.FacilitiesV2"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.Pictures"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.Descriptions"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.Themes"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.ContactInfo"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelTags.IsBookable"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.HotelTags.IsHeCheng"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.ArrivalTimeLimitInfo"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.DepartureTimeLimitInfo"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.ExternalFacility.Parking"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.ExternalFacility.ChargingPoint"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.BossInfos"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.NormalizedPolicies.ChildAndExtraBedPolicy"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.HotelDiscount"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.SellerShowInfos"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.VideoItems"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.NormalizedPolicies.MealsPolicy"</span><span class="p">,</span> <span class="c1">//已废弃，请切换至MealsPolicyV2</span>
        <span class="s2">"HotelStaticInfo.NormalizedPolicies.MealsPolicyV2"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.HotelTags.ReservedData"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelPromotions"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelTaxRuleInfos"</span><span class="p">,</span><span class="c1">//重UniqueID要</span>
        <span class="s2">"HotelStaticInfo.SepecialServiceForChinese"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelFeatures"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelUsedNames"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.BnBHotel"</span><span class="p">,</span> <span class="c1">// 获取民宿酒店专有信息</span>
        <span class="s2">"HotelStaticInfo.ContactPersonInfos"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelCloseTime"</span><span class="p">,</span>  <span class="c1">//酒店不营业时段</span>
    <span class="p">];</span>

    <span class="k">const</span> <span class="no">ROOM_TYPE_STATIC_EXTENDED_NODES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1">//物理房型相关扩展节点</span>
        <span class="s2">"RoomTypeInfo.Facilities"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.Pictures"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.Descriptions"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.ChildLimit"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.BroadNet"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.RoomBedInfos"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.BnBHotel"</span><span class="p">,</span>    <span class="c1">// 获取民宿房型专有信息</span>
        <span class="s2">"RoomTypeInfo.Smoking"</span><span class="p">,</span><span class="c1">//已废弃，请使用售卖房型吸烟信息</span>
        <span class="s2">"RoomTypeInfo.RoomTypeTags.ReservedData"</span><span class="p">,</span>
        <span class="c1">//售卖房型相关扩展节点</span>
        <span class="s2">"RoomInfo.ApplicabilityInfo"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.Smoking"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.BroadNet"</span><span class="p">,</span><span class="c1">//已废弃，请使用物理房型层宽带信息，售卖房型层宽带信息暂停使用</span>
        <span class="s2">"RoomInfo.RoomBedInfos"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.RoomFGToPPInfo"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.ChannelLimit"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.ExpressCheckout"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.RoomTags"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.RoomGiftInfos"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.AreaApplicabilityInfo"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.RoomPromotions"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.HotelPromotions"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.MaskCampaignInfos"</span><span class="p">,</span><span class="c1">//Mask房型获取</span>
        <span class="s2">"RoomInfo.BookingRules"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.RoomTags.HotelDiscount"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.IsNeedCustomerTelephone"</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">const</span> <span class="no">ROOM_TYPE_STATIC_SEARCH_TAGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">"Code"</span> <span class="o">=&gt;</span> <span class="s2">"IsOutputHiddenMaskRoom"</span><span class="p">,</span> <span class="c1">//异地Mask房型获取</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="s2">"Code"</span><span class="o">=&gt;</span> <span class="s2">"IsOutputLimitDestinationRoom"</span><span class="p">,</span> <span class="c1">//目的地Mask房型获取</span>
        <span class="p">]</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dot</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">convertData</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">RULES</span> <span class="k">as</span> <span class="nv">$underlineRule</span> <span class="o">=&gt;</span> <span class="nv">$dotRule</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$underlineRule</span><span class="p">})</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dot</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$dotRule</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$underlineRule</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">toArray</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">convertData</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dot</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">toJson</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">convertData</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dot</span><span class="o">-&gt;</span><span class="na">toJson</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kd">class</span> <span class="nc">Test</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$ctripClient</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ctripClient</span> <span class="o">=</span> <span class="nv">$ctripClient</span><span class="p">;</span>
	<span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$fetchOnePage</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="o">&amp;</span><span class="nv">$lastRecordId</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HotelRequest</span><span class="p">();</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">SearchCandidate_SearchByType_SearchType</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">SEARCH_TYPE</span><span class="p">;</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">SearchCandidate_SearchByType_IsHaveHotel</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">IS_HAVE_HOTEL</span><span class="p">;</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">PagingSettings_PageSize</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">PAGE_SIZE</span><span class="p">;</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">PagingSettings_LastRecordID</span> <span class="o">=</span> <span class="nv">$lastRecordId</span><span class="p">;</span>

            <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ctripClient</span><span class="o">-&gt;</span><span class="na">getAllCityInfo</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">CtripClient</span><span class="o">::</span><span class="na">success</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">'CityInfos'</span><span class="p">][</span><span class="s1">'CityInfo'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">Util</span><span class="o">::</span><span class="na">LOOP_API_EXCEPTION_STOP</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">'CityInfos'</span><span class="p">][</span><span class="s1">'CityInfo'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$city</span><span class="p">)</span> <span class="p">{</span>
				<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$city</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nv">$lastRecordId</span> <span class="o">=</span> <span class="nx">CtripClient</span><span class="o">::</span><span class="na">successAndReturnLastRecordId</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$lastRecordId</span><span class="p">))</span> <span class="p">{</span>
                <span class="nb">unset</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">Util</span><span class="o">::</span><span class="na">LOOP_NORMAL_STOP</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nb">unset</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">Util</span><span class="o">::</span><span class="na">LOOP_RUN_CONTINUE</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="nv">$lastRecordId</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="nx">Util</span><span class="o">::</span><span class="na">loop</span><span class="p">(</span><span class="nv">$fetchOnePage</span><span class="p">,</span> <span class="nv">$lastRecordId</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$test</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Test</span><span class="p">(</span><span class="k">new</span> <span class="nx">CtripClient</span><span class="p">());</span>
<span class="nv">$test</span><span class="o">-&gt;</span><span class="na">main</span><span class="p">();</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">CtripConfig</code>配置信息类</li>
  <li><code class="highlighter-rouge">CtripToken</code>维护携程token类支持多进程并发获取token。</li>
  <li><code class="highlighter-rouge">CtripClient</code>对外提供的客户端类</li>
  <li><code class="highlighter-rouge">HotelRequest</code>对外提供的请求类</li>
  <li><code class="highlighter-rouge">Util</code>工具类</li>
  <li><code class="highlighter-rouge">Test</code>演示类</li>
</ul>

<p>总结：支持分布式获取token；支持HotelRequest请求类参数配置；支持接口配置；支持接口限速配置；封装重试方法；封装分页循环获取方法。</p>


    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    May
    22nd,
    
    2020
  </span>

  <h2>
    <a href="/data%20structure/2020/05/22/heap.html">二叉堆笔记</a>
  </h2>

  <div>
    
    <h2 id="介绍">介绍</h2>

<p>一个小顶堆(或大顶堆)是一个完整的二叉树。其中每个节点都小于其子节点。因此，根是树中的最小元素。</p>

<p><img src="assets/media/WX20200522-192421@2x.png" alt="图-2" /></p>

<p>在最小堆中有两个关键操作：<code class="highlighter-rouge">insert</code>和<code class="highlighter-rouge">extract_min</code>。</p>

<h2 id="插入操作">插入操作</h2>

<p>当我们向一个最小堆插入元素时，总是从底部开始。从最右边的节点开始插入操作以保持树的完整性。然后，通过与其祖先节点进行交换来“修复”树，直到找到新元素的适当位置。我们基本上是在向上传递最小的元素</p>

<p><img src="assets/media/WX20200522-192404@2x.png" alt="图-1" /></p>

<h2 id="提取最小元素">提取最小元素</h2>

<p>找到小顶堆的最小元素是小菜一碟：它总是在顶部。颇为棘手的是如何删除该元素（其实也不是那么棘手）。首先，删除最小元素并将其与堆中的最后一个元素（位于最底层、最右边的元素）进行交换。然后，向下传递这个元素，不断使其与自身子节点之一进行交换，直到小顶堆的属性得以恢复。是和左边的孩子节点还是右边的孩子节点进行交换取决于它们的值。左右元素之间没有固定的顺序，但是为了保持小顶堆的元素有序，你需要选择两者中较小的元素。</p>

<p><img src="assets/media/WX20200522-192346@2x.png" alt="图-3" /></p>

<h2 id="堆的基本操作">堆的基本操作</h2>

<p>堆的几个基本操作都依赖于两个重要的函数<code class="highlighter-rouge">siftUp</code>和<code class="highlighter-rouge">siftDown</code>，堆的insert通常是在堆尾插入新元素并siftUp调整堆，而<code class="highlighter-rouge">extractMin</code>是在删除堆顶元素，然后将最后一个元素放置堆顶并调用<code class="highlighter-rouge">siftDown</code>调整堆。
堆得基本操作的时间复杂度如下表所示：</p>
<ul>
  <li>heapify O(N)</li>
  <li>insert O(logN)</li>
  <li>extractMin O(logN)</li>
  <li>delete O(logN)</li>
  <li>peek O(1)</li>
</ul>

<h2 id="总结">总结</h2>

<ul>
  <li>（1）堆是一颗完全二叉树；</li>
  <li>（2）小（大）顶堆中的每一个节点都不小于（不大于）它的父节点；</li>
  <li>（3）堆的插入、删除元素的时间复杂度都是O(log n)；</li>
  <li>（4）建堆的时间复杂度是O(n)；</li>
  <li>（5）堆排序的时间复杂度是O(nlog n)；</li>
  <li>（6）堆排序的空间复杂度是O(1)；</li>
</ul>

<h2 id="代码">代码</h2>

<p>最小堆代码示例:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">Heap</span>
<span class="p">{</span>

    <span class="k">private</span> <span class="nv">$items</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$size</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$length</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">=</span> <span class="nv">$length</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">peek</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">??</span><span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">insert</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span> <span class="o">==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shitUp</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">extractMin</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$min</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">peek</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nv">$min</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$min</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="o">--</span><span class="p">;</span>
        <span class="nb">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="p">]);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shitDown</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$min</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">shitUp</span><span class="p">(</span><span class="nv">$pos</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="nv">$pos</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$pos</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$parentPos</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$pos</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$parentPos</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$pos</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$parentPos</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$parentPos</span><span class="p">])</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$parentPos</span><span class="p">],</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">],</span>
            <span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shitUp</span><span class="p">(</span><span class="nv">$parentPos</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">shitDown</span><span class="p">(</span><span class="nv">$pos</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$left</span> <span class="o">=</span> <span class="nv">$pos</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nv">$right</span> <span class="o">=</span> <span class="nv">$pos</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nv">$mpos</span> <span class="o">=</span> <span class="nv">$pos</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$left</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$left</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">])</span> <span class="p">{</span>
            <span class="nv">$mpos</span> <span class="o">=</span> <span class="nv">$left</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$right</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$right</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$mpos</span><span class="p">])</span> <span class="p">{</span>
            <span class="nv">$mpos</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$mpos</span> <span class="o">!=</span> <span class="nv">$pos</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$mpos</span><span class="p">])</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$mpos</span><span class="p">],</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">],</span>
            <span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shitDown</span><span class="p">(</span><span class="nv">$mpos</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">display</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_display</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_display</span><span class="p">(</span><span class="nv">$root</span><span class="p">,</span> <span class="nv">$layout</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$root</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">echo</span> <span class="nb">str_repeat</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$layout</span><span class="p">)</span><span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$root</span><span class="p">],</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

        <span class="nv">$left</span> <span class="o">=</span> <span class="nv">$root</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="nv">$right</span> <span class="o">=</span> <span class="nv">$root</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nv">$layout</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$left</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_display</span><span class="p">(</span><span class="nv">$left</span><span class="p">,</span> <span class="nv">$layout</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$right</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_display</span><span class="p">(</span><span class="nv">$right</span><span class="p">,</span> <span class="nv">$layout</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$heap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">self</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">echo</span> <span class="s1">'遍历显示堆'</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">();</span>

        <span class="k">echo</span> <span class="s2">"peek"</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">peek</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

        <span class="k">echo</span> <span class="s2">"extractMin"</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">extractMin</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">extractMin</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">extractMin</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

        <span class="k">echo</span> <span class="s2">"peek"</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">peek</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

        <span class="k">echo</span> <span class="s2">"extractMin"</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">extractMin</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">extractMin</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

        <span class="k">echo</span> <span class="s1">'遍历显示堆'</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Heap</span><span class="o">::</span><span class="na">main</span><span class="p">();</span>

</code></pre></div></div>

<p>运行结果:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
遍历显示堆
1
        3
                4
                8
        5
                9
                10
peek
1
extractMin
1
3
4
peek
5
extractMin
5
8
遍历显示堆
9
        10

</code></pre></div></div>

<p>二叉堆排序代码如下:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">HeapSort</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$items</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$items</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span> <span class="o">=</span> <span class="nv">$items</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">sort</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$arrLen</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">buildMaxHeap</span><span class="p">(</span><span class="nv">$arrLen</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$arrLen</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">];</span>

            <span class="nv">$arrLen</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">heapify</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$arrLen</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">buildMaxHeap</span><span class="p">(</span><span class="nv">$arrLen</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$arrLen</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span> <span class="nv">$i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">heapify</span><span class="p">(</span><span class="nv">$i</span><span class="p">,</span> <span class="nv">$arrLen</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">heapify</span><span class="p">(</span><span class="nv">$i</span><span class="p">,</span> <span class="nv">$arrLen</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$left</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nv">$i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nv">$right</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nv">$i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nv">$largest</span> <span class="o">=</span> <span class="nv">$i</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$left</span> <span class="o">&lt;</span> <span class="nv">$arrLen</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$left</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$largest</span><span class="p">])</span> <span class="p">{</span>
            <span class="nv">$largest</span> <span class="o">=</span> <span class="nv">$left</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$right</span> <span class="o">&lt;</span> <span class="nv">$arrLen</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$right</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$largest</span><span class="p">])</span> <span class="p">{</span>
            <span class="nv">$largest</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$largest</span> <span class="o">!=</span> <span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$largest</span><span class="p">])</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$largest</span><span class="p">],</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span>
            <span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">heapify</span><span class="p">(</span><span class="nv">$largest</span><span class="p">,</span> <span class="nv">$arrLen</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">7</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
        <span class="p">];</span>
        <span class="k">echo</span> <span class="s1">'排序前'</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$items</span><span class="p">);</span>

        <span class="nv">$self</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">self</span><span class="p">(</span><span class="nv">$items</span><span class="p">);</span>
        <span class="k">echo</span> <span class="s1">'排序后'</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="na">sort</span><span class="p">());</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">HeapSort</span><span class="o">::</span><span class="na">main</span><span class="p">();</span>

</code></pre></div></div>

<p>运行结果:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/local/opt/php@7.1/bin/php /Users/martin/heapsort.php
排序前
/Users/martin/heapsort.php:70:
array(7) {
  [0] =&gt;
  int(1)
  [1] =&gt;
  int(5)
  [2] =&gt;
  int(3)
  [3] =&gt;
  int(6)
  [4] =&gt;
  int(2)
  [5] =&gt;
  int(7)
  [6] =&gt;
  int(4)
}
排序后
/Users/martin/heapsort.php:74:
array(7) {
  [0] =&gt;
  int(1)
  [1] =&gt;
  int(2)
  [2] =&gt;
  int(3)
  [3] =&gt;
  int(4)
  [4] =&gt;
  int(5)
  [5] =&gt;
  int(6)
  [6] =&gt;
  int(7)
}

</code></pre></div></div>

<h2 id="延伸">延伸</h2>

<ul>
  <li>优先队列</li>
  <li>堆排序</li>
  <li>海量实数中（一亿级别以上）找到TopK（一万级别以下）的数集合。</li>
</ul>

<h2 id="参考">参考</h2>
<ul>
  <li>https://blog.csdn.net/u014532901/article/details/78573556</li>
  <li>https://zhuanlan.zhihu.com/p/78146654</li>
</ul>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    May
    16th,
    
    2020
  </span>

  <h2>
    <a href="/data%20structure/2020/05/16/trie-node.html">Trie</a>
  </h2>

  <div>
    
    <h2 id="介绍">介绍</h2>

<p>Trie树,又称单词查找树、字典树，是一种树形结构，是一种哈希树的变种，是一种用于快速检索的多叉树结构。典型应用是用于统计和排序大量的字符串（但不仅限于字符串），所以经常被搜索引擎系统用于文本词频统计。</p>

<p>它的优点是：最大限度地减少无谓的字符串比较，查询效率比哈希表高。Trie 的强大之处就在于它的时间复杂度，插入和查询的效率很高，都为O(N)，其中 N 是待插入/查询的字符串的长度，而与 Trie 中保存了多少个元素无关。
Trie的核心思想是空间换时间。利用字符串的公共前缀来降低查询时间的开销以达到提高效率的目的。
Trie树也有它的缺点,Trie树的内存消耗非常大。</p>

<h2 id="三个基本特性">三个基本特性</h2>
<p>1）根节点不包含字符，除根节点外每一个节点都只包含一个字符。　　</p>

<p>2）从根节点到某一节点，路径上经过的字符连接起来，为该节点对应的字符串。　</p>

<p>3）每个节点的所有子节点包含的字符都不相同。</p>

<h2 id="用php实现一版">用PHP实现一版。</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">TrieNode</span>
<span class="p">{</span>
    <span class="c1">// &lt;char, TrieNode&gt;</span>
    <span class="k">public</span> <span class="nv">$children</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">public</span> <span class="nv">$isEnfOfWord</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Trie</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$root</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TrieNode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">insert</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$word</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$current</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span><span class="p">;</span>

        <span class="nv">$l</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$word</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$l</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$c</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$current</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$c</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$current</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$c</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TrieNode</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$current</span> <span class="o">=</span> <span class="nv">$current</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$c</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="nv">$current</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">search</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$word</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$current</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span><span class="p">;</span>

        <span class="nv">$l</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$word</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$l</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$c</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$current</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$c</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$current</span> <span class="o">=</span> <span class="nv">$current</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$c</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">(</span><span class="nv">$current</span> <span class="o">&amp;&amp;</span> <span class="nv">$current</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_remove</span><span class="p">(</span><span class="nv">$root</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$word</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$depth</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$root</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// If last character of key is being processed</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$depth</span> <span class="o">==</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$word</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// This node is no more end of word after removal of given key</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$root</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// If given is not prefix of any other word</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isEmpty</span><span class="p">(</span><span class="nv">$root</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$root</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nv">$root</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// If not last character, recur for the child</span>
        <span class="c1">// obtained using ASCII value</span>
        <span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$word</span><span class="p">[</span><span class="nv">$depth</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_remove</span><span class="p">(</span>
            <span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$word</span><span class="p">[</span><span class="nv">$depth</span><span class="p">]],</span>
            <span class="nv">$word</span><span class="p">,</span>
            <span class="nv">$depth</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">);</span>

        <span class="c1">// If root does not have any child (its only child got</span>
        <span class="c1">// deleted), and it is not end of another word.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isEmpty</span><span class="p">(</span><span class="nv">$root</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$root</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$root</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$root</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">remove</span><span class="p">(</span><span class="nv">$word</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_remove</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span><span class="p">,</span> <span class="nv">$word</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="nv">$root</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span> <span class="k">as</span> <span class="nv">$child</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$child</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">display</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$words</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_display</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$words</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$words</span> <span class="k">as</span> <span class="nv">$word</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="nv">$word</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_display</span><span class="p">(</span><span class="nv">$root</span><span class="p">,</span> <span class="nv">$prefix</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$words</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$old</span> <span class="o">=</span> <span class="nv">$prefix</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span> <span class="k">as</span> <span class="nv">$char</span> <span class="o">=&gt;</span> <span class="nv">$child</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$child</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$prefix</span> <span class="o">=</span> <span class="nv">$old</span> <span class="o">.</span> <span class="nv">$char</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$child</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$words</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$prefix</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_display</span><span class="p">(</span><span class="nv">$child</span><span class="p">,</span> <span class="nv">$prefix</span><span class="p">,</span> <span class="nv">$words</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">wordCount</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wordCount</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_wordCount</span><span class="p">(</span><span class="nv">$root</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$result</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span> <span class="k">as</span> <span class="nv">$char</span> <span class="o">=&gt;</span> <span class="nv">$child</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$result</span> <span class="o">+=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wordCount</span><span class="p">(</span><span class="nv">$child</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Input keys (use only 'a' through 'z' and lower case)</span>
        <span class="nv">$keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"the"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"there"</span><span class="p">,</span> <span class="s2">"answer"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">,</span> <span class="s2">"by"</span><span class="p">,</span> <span class="s2">"bye"</span><span class="p">,</span> <span class="s2">"their"</span><span class="p">];</span>
        <span class="nv">$output</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Not present in trie"</span><span class="p">,</span> <span class="s2">"Present in trie"</span><span class="p">];</span>

        <span class="nv">$trie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Trie</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$keys</span> <span class="k">as</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$trie</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$trie</span><span class="o">-&gt;</span><span class="na">remove</span><span class="p">(</span><span class="s1">'by'</span><span class="p">);</span>

        <span class="nv">$trie</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">();</span>
        <span class="k">echo</span> <span class="nv">$trie</span><span class="o">-&gt;</span><span class="na">wordCount</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Trie</span><span class="o">::</span><span class="na">main</span><span class="p">();</span>

</code></pre></div></div>

<p>延伸</p>
<ul>
  <li>使用Trie实现一个字典
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class TrieNode
{
  // &lt;char, TrieNode&gt;
  public $children = [];
  public $isEnfOfWord = false;
  public $meaning = ''; // 字典的释义
}
</code></pre></div>    </div>
  </li>
  <li>词频统计
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class TrieNode
{
  // &lt;char, TrieNode&gt;
  public $children = [];
  public $isEnfOfWord = false;
  public $wordFreq = 0; // 词频统计
}
</code></pre></div>    </div>
  </li>
  <li>字典序排序</li>
  <li>前缀匹配</li>
  <li>最长公共前缀</li>
</ul>

<h2 id="问题实例">问题实例</h2>

<p>1、一个文本文件，大约有一万行，每行一个词，要求统计出其中最频繁出现的前10个词，请给出思想，给出时间复杂度分析</p>

<p>提示：用trie树统计每个词出现的次数，时间复杂度是O(n<em>le)（le表示单词的平均长度），然后是找出出现最频繁的前10个词。当然，也可以用堆来实现，时间复杂度是O(n</em>lg10)。所以总的时间复杂度，是O(n<em>le)与O(n</em>lg10)中较大的哪一个。</p>

<p>2、寻找热门查询</p>

<p>原题：搜索引擎会通过日志文件把用户每次检索使用的所有检索串都记录下来，每个查询串的长度为1-255字节。假设目前有一千万个记录，这些查询串的重复读比较高，虽然总数是1千万，但是如果去除重复和，不超过3百万个。一个查询串的重复度越高，说明查询它的用户越多，也就越热门。请你统计最热门的10个查询串，要求使用的内存不能超过1G。</p>

<p>提示：利用trie树，关键字域存该查询串出现的次数，没有出现为0。最后用10个元素的最小推来对出现频率进行排序。</p>

<h2 id="参考">参考</h2>
<ul>
  <li>https://blog.csdn.net/hguisu/article/details/8131559</li>
  <li>https://github.com/julycoding/The-Art-Of-Programming-By-July/blob/master/ebook/zh/06.09.md</li>
</ul>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    May
    16th,
    
    2020
  </span>

  <h2>
    <a href="/data%20structure/2020/05/16/hashtable.html">HashTable</a>
  </h2>

  <div>
    
    <p>HashTable是一种通过将键(key)映射为值(value)从而实现快速查找的数据结构。实现HashTable的方式有很多种。本次介绍2种，并给出第一种的PHP版本实现。</p>

<p>我们使用一个链表构成的数组与一个散列函数来实现散列表。当插入键（字符串或几乎其他所有数据类型）和值时，我们按照如下方法操作。</p>

<p>(1) 首先，计算键的散列值。键的散列值通常为int或者long型。请注意，不同的两个键可以有相同的散列值，因为键的数量是无穷的，而int型的总数是有限的。</p>

<p>(2) 之后，将散列值映射为数组的索引。可以使用类似于hash(key) % array_length的方式完成这一步骤，不同的两个散列值则会被映射到相同的数组索引。</p>

<p>(3) 此数组索引处存储的元素是一系列由键和值为元素组成的链表。请将映射到此索引的键和值存储在这里。由于存在冲突，我们必须使用链表：有可能对于相同的散列值有不同的键，也有可能不同的散列值被映射到了同一个索引。</p>

<p>通过键来获取值则需重复此过程。首先通过键计算散列值，再通过散列值计算索引。之后，查找链表来获取该键所对应的值。</p>

<p>如果冲突发生很多次，最坏情况下的时间复杂度是O(N)，其中N是键的数量。但是，我们通常假设一个不错的实现方式会将冲突数量保持在最低水平，在此情况下，时间复杂度是O(1)。</p>

<p>另一种方法是通过平衡二叉搜索树来实现散列表。该方法的查找时间是O(logN)。该方法的好处是用到的空间可能更少，因为我们不再需要分配一个大数组。还可以按照键的顺序进行迭代访问，在某些时候这样做很有用</p>

<p>我们实现一个PHP版的HashTable, 数据结构<code class="highlighter-rouge">Element</code>、<code class="highlighter-rouge">HashTable</code>,散列函数，我们使用<code class="highlighter-rouge">Times33*hash</code>。
功能：添加(覆盖)、删除、获取，内部隐藏逻辑<code class="highlighter-rouge">rehash</code>。
<code class="highlighter-rouge">rehash</code>两种情况，一种是扩容、一种是缩容。基于<code class="highlighter-rouge">isRehash</code>进行判断。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">Element</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$hash</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">value</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hash</span> <span class="o">=</span> <span class="nv">$hash</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">HashTable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$item</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">public</span> <span class="nv">$length</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$useElement</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">initHashTable</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span><span class="o">:?</span><span class="nx">string</span>
    <span class="p">{</span>
        <span class="nv">$e</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_has</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$e</span> <span class="nx">instanceof</span> <span class="nx">Element</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isRehash</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rehash</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nv">$hash</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="nv">$slot</span> <span class="o">=</span> <span class="nv">$hash</span> <span class="o">%</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">;</span>

        <span class="nv">$element</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_has</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span> <span class="nx">instanceof</span> <span class="nx">Element</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">value</span> <span class="o">!==</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$element</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">==</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$element</span><span class="o">-&gt;</span><span class="na">value</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
            <span class="nb">array_push</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">],</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">));</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">del</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span><span class="o">:?</span><span class="nx">bool</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_has</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="nx">instanceof</span> <span class="nx">Element</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_del</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_del</span><span class="p">(</span><span class="nx">Element</span> <span class="nv">$delElement</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$delElement</span><span class="o">-&gt;</span><span class="na">hash</span> <span class="o">%</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">)]</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">==</span> <span class="nv">$delElement</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">][</span><span class="nv">$k</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span><span class="o">--</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isRehash</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rehash</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">has</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_has</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="nx">instanceof</span> <span class="nx">Element</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_has</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span><span class="o">:?</span><span class="nx">Element</span>
    <span class="p">{</span>
        <span class="nv">$hash</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="nv">$slot</span> <span class="o">=</span> <span class="nv">$hash</span> <span class="o">%</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$element</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">==</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$element</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">hash</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$hash</span> <span class="o">=</span> <span class="mi">5381</span><span class="p">;</span>
            <span class="nv">$l</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$l</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$num</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$key</span><span class="p">[</span><span class="nv">$i</span><span class="p">]);</span>
                <span class="nv">$hash</span> <span class="o">+=</span> <span class="nv">$num</span> <span class="o">+</span> <span class="nv">$hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">+</span> <span class="nv">$hash</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nv">$hash</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">initHashTable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">isRehash</span><span class="p">()</span><span class="o">:</span><span class="nx">bool</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span> <span class="o">&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span>
            <span class="o">||</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="mi">2</span><span class="o">*</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rehash</span><span class="p">();</span>
            <span class="k">echo</span> <span class="s1">'rehash'</span><span class="p">,</span><span class="nx">PHP_EOL</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">rehash</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span> <span class="o">&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$newLength</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$newLength</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$newItem</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span> <span class="k">as</span> <span class="nv">$slot</span> <span class="o">=&gt;</span> <span class="nv">$items</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$slot</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="na">hash</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">))</span> <span class="o">%</span> <span class="nv">$newLength</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newItem</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="nv">$newItem</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="p">}</span>
                <span class="nb">array_push</span><span class="p">(</span><span class="nv">$newItem</span><span class="p">[</span><span class="nv">$slot</span><span class="p">],</span> <span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">=</span> <span class="nv">$newLength</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span> <span class="o">=</span> <span class="nv">$newItem</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">debugHashTable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

        <span class="nv">$hashTable</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HashTable</span><span class="p">();</span>

        <span class="nv">$items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'key'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
            <span class="s1">'c'</span> <span class="o">=&gt;</span> <span class="s1">'12311'</span><span class="p">,</span>
            <span class="mi">122</span> <span class="o">=&gt;</span> <span class="s1">'1231'</span><span class="p">,</span>
            <span class="s1">'key1'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
            <span class="s1">'c1'</span> <span class="o">=&gt;</span> <span class="s1">'12311'</span><span class="p">,</span>
            <span class="mi">1221</span> <span class="o">=&gt;</span> <span class="s1">'1231'</span><span class="p">,</span>
            <span class="s1">'ke'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
            <span class="s1">'ky1'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
            <span class="s1">'ey1'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
            <span class="s1">'ky'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
        <span class="p">];</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">store</span><span class="p">(</span><span class="nv">$k</span><span class="p">,</span> <span class="nv">$v</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="nv">$k</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$k</span><span class="p">),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">echo</span> <span class="s1">'添加key后结果:'</span><span class="p">,</span><span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">debugHashTable</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">del</span><span class="p">(</span><span class="nv">$k</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$k</span> <span class="o">==</span> <span class="s1">'ey1'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">echo</span> <span class="s1">'删除key后，结果:'</span><span class="p">,</span><span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">debugHashTable</span><span class="p">();</span>
        <span class="k">echo</span> <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">HashTable</span><span class="o">::</span><span class="na">main</span><span class="p">();</span>

</code></pre></div></div>

<p>判断一个哈希算法的好坏有以下几点:</p>
<ul>
  <li>一致性，等价的键必然产生相等的哈希值；</li>
  <li>高效性，计算简便；</li>
  <li>均匀性，均匀地对所有的键进行哈希。</li>
</ul>

<p>更多延伸阅读</p>
<ul>
  <li>php HashTable</li>
  <li>redis HashTable</li>
  <li>php vs redis rehash方式为什么不一样</li>
  <li>hash 函数实现方式：Times33(djb2), sdbm,lose</li>
</ul>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    March
    23rd,
    
    2020
  </span>

  <h2>
    <a href="/elasticsearch/2020/03/23/task-log-index-upgrade.html">优化task-log索引</a>
  </h2>

  <div>
    
    <h4 id="背景">背景</h4>

<p><img src="/assets/media/WX20200323-135441.png" alt="task log data" /></p>

<p>索引表数据过大，基于场景，分析该表就是统计任务写入状态使用,便于每天汇总报告.</p>

<h4 id="解决方案">解决方案</h4>

<p>利用Index Template 格式如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT _template/task_log
{
	"index_patterns": ["task-log-*"],
	"settings": {
		"number_of_shards": 3
	},
	"mappings": {
		"_source": {
			"enabled": false
		},
		"dynamic": false,
		"properties": {
			"id": {
				"type": "long"
			},
			"success": {
				"type": "boolean"
			},
			"createtime": {
				"type": "date",
				"format": "yyyy-MM-dd HH:mm:ss"
			}
		}
	},
	"aliases": {
	  "task-log": {}
	},
	"version": 2
}
</code></pre></div></div>

<p>按天创建索引,而且支持动态创建（task_log Template)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST task-log-20200325/_doc
{
  "id":1011221,
  "success":false,
  "createtime":"2020-12-12 13:12:12"
}
</code></pre></div></div>

<p>分析数据（每天的成功个数和失败个数)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET task-log/_search
{
  "size": 0,
  "aggs": {
    "avg_day": {
      "date_histogram": {
        "field": "createtime",
        "interval": "day"
      },
      "aggs": {
        "success": {
          "terms": {
            "field": "success",
            "size": 10
          }
        }
      }

    }
  }
}
</code></pre></div></div>

<p>结果:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "took" : 3,
  "timed_out" : false,
  "_shards" : {
    "total" : 2,
    "successful" : 2,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 7,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "avg_day" : {
      "buckets" : [
        {
          "key_as_string" : "2020-12-12 00:00:00",
          "key" : 1607731200000,
          "doc_count" : 7,
          "success" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : 1,
                "key_as_string" : "true",
                "doc_count" : 5
              },
              {
                "key" : 0,
                "key_as_string" : "false",
                "doc_count" : 2
              }
            ]
          }
        }
      ]
    }
  }
}
</code></pre></div></div>

<p>基本功能实现了，原来的<code class="highlighter-rouge">_source</code>数据不存在了，一条省个及字节，一天几亿条,那就节省不少空间。</p>

<h4 id="优化点">优化点</h4>

<ol>
  <li><code class="highlighter-rouge">_source enable false</code></li>
  <li><code class="highlighter-rouge">index template</code> 支持<code class="highlighter-rouge">version, alias, mapping</code></li>
  <li>移除副本配置，缩小不必要的数据空间</li>
  <li>一个存储日志的主分片理论值50G，三个主分片可容纳150G数据，基于现有每天的数据量按每条1KB，可容纳150亿条数据，足矣满足现在业务使用场景。</li>
</ol>

<h4 id="参考">参考</h4>

<p>https://blog.csdn.net/napoay/article/details/62233031</p>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    March
    17th,
    
    2020
  </span>

  <h2>
    <a href="/feynman/2020/03/17/learn-Feynman.html">学习费曼学习法</a>
  </h2>

  <div>
    
    <p><img src="/assets/media/费曼学习法.png" alt="费曼学习法" /></p>


    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    March
    1st,
    
    2020
  </span>

  <h2>
    <a href="/swoole/2020/03/01/learn-swoole.html">学习Swoole</a>
  </h2>

  <div>
    
    <h3 id="学习swoole需要掌握哪些基础知识">学习Swoole需要掌握哪些基础知识</h3>

<h4 id="多进程多线程">多进程/多线程</h4>

<ul>
  <li>了解Linux操作系统进程和线程的概念</li>
  <li>了解Linux进程/线程切换调度的基本知识</li>
  <li>了解进程间通信的基本知识，如管道、UnixSocket、消息队列、共享内存</li>
</ul>

<h4 id="socket">SOCKET</h4>

<ul>
  <li>了解SOCKET的基本操作如accept/connect、send/recv、close、listen、bind</li>
  <li>了解SOCKET的接收缓存区、发送缓存区、阻塞/非阻塞、超时等概念</li>
</ul>

<h4 id="io复用">IO复用</h4>

<ul>
  <li>了解select/poll/epoll</li>
  <li>了解基于select/epoll实现的事件循环，Reactor模型</li>
  <li>了解可读事件、可写事件</li>
</ul>

<h4 id="tcpip网络协议">TCP/IP网络协议</h4>

<ul>
  <li>了解TCP/IP协议</li>
  <li>了解TCP、UDP传输协议</li>
</ul>

<h4 id="调试工具">调试工具</h4>

<ul>
  <li>使用 gdb 调试Linux程序</li>
  <li>使用 strace 跟踪进程的系统调用</li>
  <li>使用 tcpdump 跟踪网络通信过程</li>
  <li>其他Linux系统工具，如ps、lsof、top、vmstat、netstat、sar、ss等</li>
</ul>

<p>概括一句话读《linux高性能服务器编程》</p>

<h3 id="swoole-图">Swoole 图</h3>

<h4 id="类图">类图</h4>

<p><img src="/assets/media/WX20200301-072210@2x.png" alt="swoole class" /></p>

<h4 id="运行流程图">运行流程图</h4>

<p><img src="https://wiki.swoole.com/_images/server/running_process.jpg" alt="运行流程图" /></p>

<h4 id="进程--线程结构图">进程 / 线程结构图</h4>

<p><img src="https://wiki.swoole.com/_images/server/process_structure.jpg" alt="进程 / 线程结构图" /></p>

<p><img src="https://wiki.swoole.com/_images/server/process_structure_2.png" alt="结构图2" /></p>

<h3 id="实践代码">实践代码</h3>

<p>可以用代码中作”基酒” -&gt; <a href="https://github.com/superman2014/sf-swoole-console">sf-swoole-console</a></p>

<p>Docker运行环境：<a href="https://hub.docker.com/r/phpswoole/swoole">https://hub.docker.com/r/phpswoole/swoole</a></p>

<p>简单写了一个mapreduce 的add 加法:<a href="https://github.com/superman2014/sf-swoole-console/tree/feature-op-add">feature-op-add</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -p 9501:9501 -it -v $(pwd):/var/html phpswoole/swoole  /bin/bash
cd /var/html
php console task:server start
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ telnet 127.0.0.1 9501
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
{"op":"add", "data":[1,2]}
3
</code></pre></div></div>

<h3 id="自定义协议">自定义协议</h3>

<h4 id="eof结束符">EOF结束符</h4>

<p>发送者和接收者约定数据包已一个特殊的结束符(EOF)做结尾。适合协议相对简单的需求，常见的比如 redis、memcache、ftp、stmp等都是用\r\n换行符作为结束符。</p>

<h3 id="固定包头包体协议">固定包头+包体协议</h3>

<p><img src="https://opso.coding.me/images/swoole_pack.png" alt="固定包头+包体协议" /></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// server.php</span>
<span class="nv">$serv</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Swoole\Server</span><span class="p">(</span><span class="s2">"127.0.0.1"</span><span class="p">,</span> <span class="mi">9501</span><span class="p">);</span>
<span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">'open_length_check'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s1">'package_length_type'</span> <span class="o">=&gt;</span> <span class="s1">'n'</span><span class="p">,</span>
    <span class="s1">'package_length_offset'</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s1">'package_body_offset'</span> <span class="o">=&gt;</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">'package_max_length'</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">,</span>
<span class="p">));</span>
<span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Connect'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$serv</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Client: Connect.</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">});</span>
<span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Receive'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$serv</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">,</span> <span class="nv">$from_id</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$header</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="nv">$p</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s1">'a6begin/nbodyLen'</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$p</span><span class="p">[</span><span class="s1">'begin'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'SWOOLE'</span><span class="p">){</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nv">$len</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'bodyLen'</span><span class="p">];</span>
	<span class="nv">$bodyPack</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s2">"a</span><span class="si">{</span><span class="nv">$len</span><span class="si">}</span><span class="s2">body"</span><span class="p">,</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nv">$len</span><span class="p">));</span>
    <span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span> <span class="s2">"Server: "</span><span class="o">.</span><span class="nv">$bodyPack</span><span class="p">[</span><span class="s1">'body'</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="p">});</span>
<span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Close'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$serv</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Client: Close.</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">});</span>
<span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">//client.php</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">swoole_client</span><span class="p">(</span><span class="nx">SWOOLE_SOCK_TCP</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">'127.0.0.1'</span><span class="p">,</span> <span class="mi">9501</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">exit</span><span class="p">(</span><span class="s2">"connect failed. Error: </span><span class="si">{</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">errCode</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$msg</span> <span class="o">=</span> <span class="s1">'Hello World!'</span><span class="p">;</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nv">$msg</span><span class="p">));</span> <span class="c1">// 正常发包</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nv">$msg</span><span class="o">.</span><span class="s1">'0'</span><span class="p">)</span><span class="o">.</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nv">$msg</span><span class="o">.</span><span class="s1">'1'</span><span class="p">)</span><span class="o">.</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nv">$msg</span><span class="o">.</span><span class="s1">'2'</span><span class="p">));</span><span class="c1">// 模拟粘包</span>
<span class="k">echo</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">recv</span><span class="p">();</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
<span class="k">function</span> <span class="nf">sendMsg</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$p</span> <span class="o">=</span> <span class="s1">'SWOOLE'</span><span class="p">;</span>
	<span class="nv">$p</span> <span class="o">.=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">'n'</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">));</span>
	<span class="nv">$p</span> <span class="o">.=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">'a'</span> <span class="o">.</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">),</span> <span class="nv">$msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">$p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>抓包数据分析</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>13:36:39.050774 IP 127.0.0.1.33844 &gt; 127.0.0.1.9501: Flags [P.], seq 1:21, ack 1, win 342, options [nop,nop,TS val 4907685 ecr 4907685], length 20
        0x0000:  0000 0000 0000 0000 0000 0000 0800 4500  ..............E.
        0x0010:  0048 a56a 4000 4006 9743 7f00 0001 7f00  .H.j@.@..C......
        0x0020:  0001 8434 251d 496d 47ce 8446 849b 8018  ...4%.ImG..F....
        0x0030:  0156 fe3c 0000 0101 080a 004a e2a5 004a  .V.&lt;.......J...J
        0x0040:  e2a5 5357 4f4f 4c45 000c 4865 6c6c 6f20  ..SWOOLE..Hello.
        0x0050:  576f 726c 6421                           World!
13:36:39.050820 IP 127.0.0.1.9501 &gt; 127.0.0.1.33844: Flags [.], ack 21, win 342, options [nop,nop,TS val 4907685 ecr 4907685], length 0
        0x0000:  0000 0000 0000 0000 0000 0000 0800 4500  ..............E.
        0x0010:  0034 663e 4000 4006 d683 7f00 0001 7f00  .4f&gt;@.@.........
        0x0020:  0001 251d 8434 8446 849b 496d 47e2 8010  ..%..4.F..ImG...
        0x0030:  0156 fe28 0000 0101 080a 004a e2a5 004a  .V.(.......J...J
        0x0040:  e2a5                                     ..
13:36:39.050862 IP 127.0.0.1.33844 &gt; 127.0.0.1.9501: Flags [P.], seq 21:84, ack 1, win 342, options [nop,nop,TS val 4907685 ecr 4907685], length 63
        0x0000:  0000 0000 0000 0000 0000 0000 0800 4500  ..............E.
        0x0010:  0073 a56b 4000 4006 9717 7f00 0001 7f00  .s.k@.@.........
        0x0020:  0001 8434 251d 496d 47e2 8446 849b 8018  ...4%.ImG..F....
        0x0030:  0156 fe67 0000 0101 080a 004a e2a5 004a  .V.g.......J...J
        0x0040:  e2a5 5357 4f4f 4c45 000d 4865 6c6c 6f20  ..SWOOLE..Hello.   //这里
        0x0050:  576f 726c 6421 3053 574f 4f4c 4500 0d48  World!0SWOOLE..H
        0x0060:  656c 6c6f 2057 6f72 6c64 2131 5357 4f4f  ello.World!1SWOO
        0x0070:  4c45 000d 4865 6c6c 6f20 576f 726c 6421  LE..Hello.World!
        0x0080:  32                                       2
13:36:39.050885 IP 127.0.0.1.9501 &gt; 127.0.0.1.33844: Flags [.], ack 84, win 342, options [nop,nop,TS val 4907685 ecr 4907685], length 0
        0x0000:  0000 0000 0000 0000 0000 0000 0800 4500  ..............E.
        0x0010:  0034 663f 4000 4006 d682 7f00 0001 7f00  .4f?@.@.........
        0x0020:  0001 251d 8434 8446 849b 496d 4821 8010  ..%..4.F..ImH!..
        0x0030:  0156 fe28 0000 0101 080a 004a e2a5 004a  .V.(.......J...J
        0x0040:  e2a5                                     ..
13:36:39.051626 IP 127.0.0.1.9501 &gt; 127.0.0.1.33844: Flags [P.], seq 1:22, ack 84, win 342, options [nop,nop,TS val 4907685 ecr 4907685], length 21
        0x0000:  0000 0000 0000 0000 0000 0000 0800 4500  ..............E.
        0x0010:  0049 6640 4000 4006 d66c 7f00 0001 7f00  .If@@.@..l......
        0x0020:  0001 251d 8434 8446 849b 496d 4821 8018  ..%..4.F..ImH!..
        0x0030:  0156 fe3d 0000 0101 080a 004a e2a5 004a  .V.=.......J...J
        0x0040:  e2a5 5365 7276 6572 3a20 4865 6c6c 6f20  ..Server:.Hello. // 这里
        0x0050:  576f 726c 6421 0a                        World!.


</code></pre></div></div>

<p>再来一个漂亮版本的代码</p>

<p>RPC 编码协议类</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Superman2014\SfSwooleConsole</span><span class="p">;</span>

<span class="cd">/**
 * Class Protocol
 * @package Superman2014\SfSwooleConsole
 *
 *
 * 包结构
 *
 * 字段	字节数	说明
 * 包头	定长	每一个通信消息必须包含的内容
 * 包体	不定长	根据每个通信消息的不同产生变化
 *
 * 其中包头详细内容如下：
 *
 * 字段        字节数 类型  说明
 * pkg_len	    2   ushort	整个包的长度，不超过4K
 * version	    1 	uchar	通讯协议版本号
 * command_id	2 	ushort	消息命令ID
 * result	    2 	short	请求时不起作用；请求返回时使用
 *
 */</span>
<span class="kd">class</span> <span class="nc">Protocol</span>
<span class="p">{</span>

    <span class="k">const</span> <span class="no">VERSION</span> <span class="o">=</span> <span class="s1">'1'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">HEADER</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">PACKAGE_LENGTH</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">partHeader</span><span class="p">(</span><span class="nv">$bodyLen</span><span class="p">,</span> <span class="nv">$version</span><span class="p">,</span> <span class="nv">$commandId</span><span class="p">,</span> <span class="nv">$result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">pack</span><span class="p">(</span><span class="s2">"nCns"</span><span class="p">,</span> <span class="nv">$bodyLen</span><span class="p">,</span> <span class="nv">$version</span><span class="p">,</span> <span class="nv">$commandId</span><span class="p">,</span> <span class="nv">$result</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">partBody</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">pack</span><span class="p">(</span><span class="s2">"a"</span><span class="o">.</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">),</span> <span class="nv">$msg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">encode</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="nv">$commandId</span><span class="p">,</span> <span class="nv">$result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">partHeader</span><span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">),</span> <span class="nx">self</span><span class="o">::</span><span class="na">VERSION</span><span class="p">,</span> <span class="nv">$commandId</span><span class="p">,</span> <span class="nv">$result</span><span class="p">)</span>
            <span class="o">.</span> <span class="nx">self</span><span class="o">::</span><span class="na">partBody</span><span class="p">(</span><span class="nv">$msg</span><span class="p">);</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">decode</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">HEADER</span><span class="p">);</span>
        <span class="nv">$p</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s1">'nbodyLen/Cversion/ncommandId/sresult'</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
        <span class="nv">$len</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'bodyLen'</span><span class="p">];</span>
        <span class="nv">$bodyPack</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s2">"a</span><span class="si">{</span><span class="nv">$len</span><span class="si">}</span><span class="s2">body"</span><span class="p">,</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">HEADER</span><span class="p">,</span> <span class="nv">$len</span><span class="p">));</span>
        <span class="k">return</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$bodyPack</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">,</span> <span class="s2">"1001"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="nb">var_dump</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">decode</span><span class="p">(</span><span class="nv">$msg</span><span class="p">));</span>

        <span class="c1">//</span>
<span class="c1">//        array(5) {</span>
<span class="c1">//        ["body"]=&gt;</span>
<span class="c1">//  string(5) "hello"</span>
<span class="c1">//        ["bodyLen"]=&gt;</span>
<span class="c1">//  int(5)</span>
<span class="c1">//  ["version"]=&gt;</span>
<span class="c1">//  int(1)</span>
<span class="c1">//  ["commandId"]=&gt;</span>
<span class="c1">//  int(1001)</span>
<span class="c1">//  ["result"]=&gt;</span>
<span class="c1">//  int(0)</span>
<span class="c1">//    }</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Protocol::main();</span>
</code></pre></div></div>

<p>常量类</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Superman2014\SfSwooleConsole</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TaskConstant</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">COMMAND_SET</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">START</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">STOP</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">RESTART</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">RELOAD</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">PING</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">STATUS</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">USAGE</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">const</span> <span class="no">USER_COMMAND</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">STATUS</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">RELOAD</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">RESTART</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">STOP</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">const</span> <span class="no">START</span> <span class="o">=</span> <span class="s1">'start'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">STOP</span> <span class="o">=</span> <span class="s1">'stop'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">STATUS</span> <span class="o">=</span> <span class="s1">'status'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">RELOAD</span> <span class="o">=</span> <span class="s1">'reload'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">RESTART</span> <span class="o">=</span> <span class="s1">'restart'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">PING</span> <span class="o">=</span> <span class="s1">'ping'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">USAGE</span> <span class="o">=</span> <span class="s1">'usage'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">DATA</span> <span class="o">=</span> <span class="s1">'data'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">COMMAND_ID_LIST</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mi">1001</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">START</span><span class="p">,</span>
        <span class="mi">1002</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">STOP</span><span class="p">,</span>
        <span class="mi">1003</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">RESTART</span><span class="p">,</span>
        <span class="mi">1004</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">RELOAD</span><span class="p">,</span>
        <span class="mi">1005</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">PING</span><span class="p">,</span>
        <span class="mi">1006</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">STATUS</span><span class="p">,</span>
        <span class="mi">1007</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">DATA</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">commandIdByName</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
       <span class="k">return</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">COMMAND_ID_LIST</span><span class="p">)[</span><span class="nv">$name</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Superman2014\SfSwooleConsole</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">Swoole\Server</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Swoole\Process</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Swoole\Client</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Swoole\Timer</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TaskServer</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">NAME</span> <span class="o">=</span> <span class="s1">'sf-swoole-console'</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$config</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'worker_num'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s1">'task_worker_num'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s1">'daemonize'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
        <span class="s1">'backlog'</span> <span class="o">=&gt;</span> <span class="mi">128</span><span class="p">,</span>
        <span class="s1">'log_file'</span> <span class="o">=&gt;</span> <span class="s1">'/tmp/swoole.log'</span><span class="p">,</span>
        <span class="s1">'log_level'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'task_ipc_mode'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s1">'heartbeat_check_interval'</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">'heartbeat_idle_time'</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">'pid_file'</span> <span class="o">=&gt;</span> <span class="s1">'/tmp/sf-swoole-console.pid'</span><span class="p">,</span>

        <span class="s1">'open_length_check'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
        <span class="s1">'package_length_type'</span> <span class="o">=&gt;</span> <span class="s1">'n'</span><span class="p">,</span>
        <span class="s1">'package_length_offset'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'package_body_offset'</span> <span class="o">=&gt;</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">HEADER</span><span class="p">,</span>
        <span class="s1">'package_max_length'</span> <span class="o">=&gt;</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">PACKAGE_LENGTH</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">const</span> <span class="no">LISTEN_HOST</span> <span class="o">=</span> <span class="s1">'0.0.0.0'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">MANAGE_HOST</span> <span class="o">=</span> <span class="s1">'127.0.0.1'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">9501</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$command</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">START</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STOP</span><span class="o">:</span>
                 <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientSendCommand</span><span class="p">()(</span><span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STOP</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STATUS</span><span class="o">:</span>
                <span class="nv">$recv</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientSendCommand</span><span class="p">()(</span><span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STATUS</span><span class="p">);</span>
                <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$recv</span><span class="p">[</span><span class="s1">'body'</span><span class="p">]);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">PING</span><span class="o">:</span>
                <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientSendCommand</span><span class="p">()(</span><span class="nx">TaskConstant</span><span class="o">::</span><span class="na">PING</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RELOAD</span><span class="o">:</span>
                <span class="nv">$recv</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientSendCommand</span><span class="p">()(</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RELOAD</span><span class="p">);</span>
                <span class="k">echo</span> <span class="nv">$recv</span><span class="p">[</span><span class="s1">'body'</span><span class="p">],</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RESTART</span><span class="o">:</span>
                <span class="nv">$recv</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientSendCommand</span><span class="p">()(</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RESTART</span><span class="p">);</span>
                <span class="k">echo</span> <span class="nv">$recv</span><span class="p">[</span><span class="s1">'body'</span><span class="p">],</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">clientSendCommand</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$command</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">(</span><span class="nx">SWOOLE_SOCK_TCP</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">MANAGE_HOST</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">PORT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">exit</span><span class="p">(</span><span class="s2">"connect failed. Error: </span><span class="si">{</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">errCode</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$command</span><span class="p">,</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">COMMAND_SET</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nx">Protocol</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$command</span><span class="p">,</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">commandIdByName</span><span class="p">(</span><span class="nv">$command</span><span class="p">)));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nx">Protocol</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$command</span><span class="p">,</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">commandIdByName</span><span class="p">(</span><span class="nx">TaskConstant</span><span class="o">::</span><span class="na">DATA</span><span class="p">)));</span>
            <span class="p">}</span>

            <span class="nv">$recv</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">recv</span><span class="p">();</span>
            <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">decode</span><span class="p">(</span><span class="nv">$recv</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">LISTEN_HOST</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">PORT</span><span class="p">,</span> <span class="nx">SWOOLE_BASE</span><span class="p">,</span> <span class="nx">SWOOLE_SOCK_TCP</span><span class="p">);</span>

        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">);</span>

        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Connect'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onConnect'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Close'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onClose'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Task'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onTask'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Finish'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onFinish'</span><span class="p">]);</span>
<span class="c1">//        $server-&gt;on('Start', [$this, 'onStart']); // SWOOLE_BASE 不存在</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'WorkerStart'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onWorkerStart'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'WorkerStop'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onWorkerStop'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'ManagerStart'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onManagerStart'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Shutdown'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onShutdown'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'WorkerExit'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onWorkerExit'</span><span class="p">]);</span>

        <span class="cd">/**
         * 用户进程实现了广播功能，循环接收unixSocket的消息，并发给服务器的所有连接
         */</span>
        <span class="nv">$process</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Process</span><span class="p">(</span>
            <span class="k">function</span> <span class="p">(</span><span class="nv">$process</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$server</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$socket</span> <span class="o">=</span> <span class="nv">$process</span><span class="o">-&gt;</span><span class="na">exportSocket</span><span class="p">();</span>
                <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">recv</span><span class="p">();</span>

                    <span class="nv">$command</span> <span class="o">=</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">COMMAND_ID_LIST</span><span class="p">[</span><span class="nv">$msg</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$command</span> <span class="o">==</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STATUS</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">stats</span><span class="p">()));</span>
                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$command</span> <span class="o">==</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RELOAD</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">reload</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                        <span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s1">'reload ok'</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$command</span> <span class="o">==</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RESTART</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">Process</span><span class="o">::</span><span class="na">kill</span><span class="p">(</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">manager_pid</span><span class="p">,</span> <span class="nx">SIGUSR1</span><span class="p">);</span>
                        <span class="nx">Process</span><span class="o">::</span><span class="na">kill</span><span class="p">(</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">manager_pid</span><span class="p">,</span> <span class="nx">SIGUSR2</span><span class="p">);</span>
                        <span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s1">'restart ok'</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$command</span> <span class="o">==</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STOP</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">shutdown</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="kc">false</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">1</span>
        <span class="p">);</span>

        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">addProcess</span><span class="p">(</span><span class="nv">$process</span><span class="p">);</span>

        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Receive'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$server</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">,</span> <span class="nv">$reactorId</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$process</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$c</span> <span class="o">=</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">COMMAND_ID_LIST</span><span class="p">[</span><span class="nv">$msg</span><span class="p">[</span><span class="s1">'commandId'</span><span class="p">]],</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">USER_COMMAND</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$socket</span> <span class="o">=</span> <span class="nv">$process</span><span class="o">-&gt;</span><span class="na">exportSocket</span><span class="p">();</span>
                <span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$msg</span><span class="p">[</span><span class="s1">'commandId'</span><span class="p">]);</span>
                <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">recv</span><span class="p">(),</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">commandIdByName</span><span class="p">(</span><span class="nx">TaskConstant</span><span class="o">::</span><span class="na">DATA</span><span class="p">)));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">onReceive</span><span class="p">(</span><span class="nv">$server</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">,</span> <span class="nv">$reactorId</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//此回调函数在worker进程中执行</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onReceive</span><span class="p">(</span><span class="nx">Server</span> <span class="nv">$server</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$fd</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$reactorId</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'body'</span><span class="p">],</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'commandId'</span><span class="p">]));</span>
    <span class="p">}</span>

	<span class="c1">// ....</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Server</code> 的基本基本命令<code class="highlighter-rouge">stop</code> <code class="highlighter-rouge">restart</code> <code class="highlighter-rouge">ping</code> <code class="highlighter-rouge">stop</code> 就是使用协议里面定义的commandId。 后续还会这里进行深入研究。</p>

<p>跟编解码类似的如编程中序列化，反序列化. 可以看看这边文档 <a href="https://www.infoq.cn/article/serialization-and-deserialization">序列化和反序列化</a>。</p>

<h2 id="参考">参考</h2>

<ul>
  <li><a href="https://toxmc.github.io/swoole-cs.github.io/">Swoole 4.x LTS 速查表</a></li>
  <li><a href="https://wiki.swoole.com/#/server/init">服务端异步风格</a></li>
  <li><a href="https://opso.coding.me/post/swoole-tcp-pack/">通过swoole理解TCP粘包</a></li>
  <li><a href="https://www.ruanyifeng.com/blog/2016/11/byte-order.html">理解字节序</a></li>
  <li><a href="https://my.oschina.net/goal/blog/195749">PHP: 深入pack/unpack</a></li>
  <li><a href="https://www.infoq.cn/article/serialization-and-deserialization">序列化和反序列化</a></li>
  <li><a href="https://github.com/superman2014/sf-swoole-console/tree/feature-self-protocol">自定义swoole协议demo</a></li>
  <li><a href="https://github.com/msgpack-rpc/msgpack-rpc">msgpack rpc</a></li>
</ul>

    
  </div>

</article>

<hr/>

<ul class="pager"> 

  
  <li class="previous disabled">
    <a>&larr; Newer</a>
  </li>
  
  
  <li>
    <span class="page_number">Page: 1 of 3</span>
  </li>

  
  <li class="next">
    <a href="/page2">Older &rarr;</a>
  </li>
  

</ul>




		<footer>
			<hr/>
			<p>
				&copy; 2020 JY with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



