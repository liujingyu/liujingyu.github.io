<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>JY</title>
	
	<meta name="author" content="JY">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/liujingyu">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:jingyu525@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
                <img src="/assets/media/dragon.jpeg" class="img-circle" />
				JY
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="background: url(/assets/media/sky.png) no-repeat !important;">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
        <img src="/assets/media/dragon.jpeg" class="img-circle"  height="150" width="150" />
	</a>
	<h3 class="title">
        <a href="/">JY</a>
    </h3>
</header>


<div id="bio" class="text-center">
	目前就职于小猪短租
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/liujingyu">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:jingyu525@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
	<ul class="list-unstyled list-inline">
		<li>
            <a class="btn btn-default btn-sm" href="/about">
                关于
			</a>
		</li>
		<li>
            <a class="btn btn-default btn-sm" href="/elasticsearch">
                elasticsearch
			</a>
		</li>
		<li>
            <a class="btn btn-default btn-sm" href="/open-source">
                开源项目
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>JY </h1>
</div>



<article class="home">

  <span class="post-date">
    
    May
    26th,
    
    2020
  </span>

  <h2>
    <a href="/encapsulation/2020/05/26/ctrip-client-sdk.html">携程酒店SDK封装</a>
  </h2>

  <div>
    
    <p>最近做的分销业务，携程只提供了HTTP API，没有提供php sdk。这方面，淘宝做的不错（飞猪）直接点击下载sdk。</p>

<p>虽然提供了两个客户端sdk，跟现有框架融合是一个问题。淘宝的sdk直接利用<code class="highlighter-rouge">composer</code>包的方式加载:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╰─$ ls -lh .
total 744
-rw-r--r--   1 martin  staff   6.3K  5 23 16:48 README.md
....
-rw-r--r--   1 martin  staff   229B  5  8 12:02 codeception.yml
-rw-r--r--   1 martin  staff   3.0K  5 26 17:33 composer.json
-rw-r--r--   1 martin  staff   327K  5 26 17:33 composer.lock
-rw-r--r--   1 martin  staff    15K  5 26 17:33 symfony.lock
lrwxr-xr-x   1 martin  staff    43B  5  8 12:02 taobao-sdk -&gt; taobao-sdk-PHP-auto_1568088312300-20191114/
drwxr-xr-x  11 martin  staff   352B  5  8 12:02 taobao-sdk-PHP-auto_1568088312300-20191114
drwxr-xr-x  53 martin  staff   1.7K  5 26 17:33 vendor
</code></pre></div></div>

<p>composer.json再加入仓库引入源:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    },
    "repositories": [
        {
            "type": "path",
            "url": "./taobao-sdk"
        }
    ],
    "minimum-stability":"dev"
}
</code></pre></div></div>
<p>这样就纳入了包管理。</p>

<p>淘宝的sdk，需要增加一个<code class="highlighter-rouge">composer.json</code>文件。</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "name": "martin/taobao-sdk",
    "authors": [
        {
            "name": "liujingyu",
            "email": "liujingyu@xiaozhu.com"
        }
    ],
    "require": {},
    "autoload":{
        "classmap": [
            "top/",
            "aliyun/",
            "dingtalk/",
            "QimenCloud/"
        ]
    },
    "minimum-stability":"dev"
}
</code></pre></div></div>

<p>安装可。</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer install martin/taobao-sdk
</code></pre></div></div>

<p>接下来聊聊，携程sdk<code class="highlighter-rouge">https://dev.ctrip.com/#/document?id=83</code>。
基于携程接口特点设计如下:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">class</span> <span class="nc">CtripConfig</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">SOURCE</span> <span class="o">=</span> <span class="nx">CommonSetting</span><span class="o">::</span><span class="na">CTRIP</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">MODE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">FORMAT</span> <span class="o">=</span> <span class="s1">'json'</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">REFRESH_TOKEN_EXPIRE</span> <span class="o">=</span> <span class="mi">900</span><span class="p">;</span> <span class="c1">// expire 15min</span>

    <span class="c1">// 携程API列表</span>
    <span class="k">const</span> <span class="no">API_LIST</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1">// api_name</span>
        <span class="c1">// @see ....</span>
        <span class="c1">//'api_name' =&gt; [</span>
            <span class="c1">//'path' =&gt; [</span>
                <span class="c1">//'prod' =&gt; '',</span>
                <span class="c1">//'test' =&gt; '',</span>
                <span class="c1">//'dev' =&gt; '',</span>
                <span class="c1">//'*' =&gt; '',</span>
            <span class="c1">//],</span>
        <span class="c1">//],</span>

        <span class="c1">// 获取全量城市信息</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=121</span>
        <span class="s1">'getAllCityInfo'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'f321ca3356b643ec8e32db0aec6a4b70'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'da97859659134aab9bfea1afbfa96d83'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'da97859659134aab9bfea1afbfa96d83'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'da97859659134aab9bfea1afbfa96d83'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span> <span class="c1">// 每分钟200次</span>
        <span class="p">],</span>

        <span class="c1">// 获取酒店清单</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=144</span>
        <span class="s1">'getHotelList'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'3a46e1d3100d46d8a46f52c3dc6b0273'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'4c81467f1e5843fbb0a5eaba23906d70'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'4c81467f1e5843fbb0a5eaba23906d70'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'4c81467f1e5843fbb0a5eaba23906d70'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span> <span class="c1">// 每分钟200次</span>
        <span class="p">],</span>

        <span class="c1">// 获取酒店静态信息</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=145</span>
        <span class="s1">'getHotelStaticInfo'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'becf5b5008064a26be77cac065688ca7'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'62a8bb573582435bbe8b361334efe36f'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'62a8bb573582435bbe8b361334efe36f'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'62a8bb573582435bbe8b361334efe36f'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span> <span class="c1">//每分钟600</span>
        <span class="p">],</span>

        <span class="c1">// 获取房型静态信息</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=146</span>
        <span class="s1">'getRoomTypeStaticInfo'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'39122604bf0e4b33a9569658cf273161'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'c04d1d7b7af449999dba88896fcc0811'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'c04d1d7b7af449999dba88896fcc0811'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'c04d1d7b7af449999dba88896fcc0811'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span> <span class="c1">//每分钟600</span>
        <span class="p">],</span>

        <span class="c1">// 监测静态信息变化</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=56</span>
        <span class="s1">'listenStaticInfo'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'66fd1e3089fb448e912808cccbe017c0'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'d0e65061aef24f88854031c60cabfd91'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'d0e65061aef24f88854031c60cabfd91'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'d0e65061aef24f88854031c60cabfd91'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'filter'</span> <span class="o">=&gt;</span> <span class="s1">'ChangeInfos'</span><span class="p">,</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">1000</span><span class="p">,</span> <span class="c1">// 每分钟1000次</span>
        <span class="p">],</span>

        <span class="c1">// 监测房价、房量、房态增量变化接口</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=98</span>
        <span class="s1">'listenRoomPriceNumberStatus'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'a8f721b9716a41ca9df8b326f10655df'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'68c959f3d5a94d7ca4ddd97cbe97d424'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'68c959f3d5a94d7ca4ddd97cbe97d424'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'68c959f3d5a94d7ca4ddd97cbe97d424'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'filter'</span> <span class="o">=&gt;</span> <span class="s1">'ChangeInfos'</span><span class="p">,</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">1000</span><span class="p">,</span> <span class="c1">// 每分钟1000次</span>
        <span class="p">],</span>

        <span class="c1">// 监测房型上下线</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=161</span>
        <span class="s1">'listenRoomTypeOnAndOffLine'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'4536a4178961443a937423c1eb8fa2ba'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'ef89b1f6ec8e49d39d5debac065a9a4a'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'ef89b1f6ec8e49d39d5debac065a9a4a'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'ef89b1f6ec8e49d39d5debac065a9a4a'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'filter'</span> <span class="o">=&gt;</span> <span class="s1">'RoomStatusChangeItems'</span><span class="p">,</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="c1">// 每分钟100次</span>
        <span class="p">],</span>

        <span class="c1">// 每日价格拉取接口（仅国内酒店）&lt;落地价&gt;</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=95</span>
        <span class="s1">'fetchLandPrice'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'99503c56b9fa4417a8bc77b92ea56d41'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'99503c56b9fa4417a8bc77b92ea56d41'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'99503c56b9fa4417a8bc77b92ea56d41'</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">],</span>

        <span class="c1">// 报价实时查询接口（国内酒店+海外酒店） &lt;直连价&gt;</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=94</span>
        <span class="s1">'fetchDirectPrice'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'4c15cadb05f14aa9836260c53ab74526'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'14a14763194648f5b9d2427f00b3ca04'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'14a14763194648f5b9d2427f00b3ca04'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'14a14763194648f5b9d2427f00b3ca04'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">6000</span><span class="p">,</span> <span class="c1">//每分钟6000次</span>
        <span class="p">],</span>

        <span class="c1">// 可预订检查</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=62</span>
        <span class="s1">'checkBookAble'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'419f7a688e3c45f481d295708b870323'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'d67d24cfdc2940cd858f506c708cf0d4'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'d67d24cfdc2940cd858f506c708cf0d4'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'d67d24cfdc2940cd858f506c708cf0d4'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">// 订单保存</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=63</span>
        <span class="s1">'saveOrderBook'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'2b0c7e0eebe2467a97be3d284313a129'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'acf5c44749234668ba3c539cc1d26c87'</span><span class="p">,</span>
                <span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'acf5c44749234668ba3c539cc1d26c87'</span><span class="p">,</span>
                <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="s1">'acf5c44749234668ba3c539cc1d26c87'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">// 订单提交</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=64</span>
        <span class="s1">'submitOrderBook'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'f40c5c71f84745cbbc73238252d9d43c'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'5f3c81bc0c90458ba94bfe2dafea8459'</span><span class="p">,</span>
                <span class="s1">'dev'</span>  <span class="o">=&gt;</span> <span class="s1">'5f3c81bc0c90458ba94bfe2dafea8459'</span><span class="p">,</span>
                <span class="s1">'*'</span>    <span class="o">=&gt;</span> <span class="s1">'5f3c81bc0c90458ba94bfe2dafea8459'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">// 获取订单详情</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=67</span>
        <span class="s1">'getOrderBookDetail'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'e4a2a8ac057f4b378c9e153ef3f35249'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'5db9d7e805ef4b36a8cf0e57900e118a'</span><span class="p">,</span>
                <span class="s1">'dev'</span>  <span class="o">=&gt;</span> <span class="s1">'5db9d7e805ef4b36a8cf0e57900e118a'</span><span class="p">,</span>
                <span class="s1">'*'</span>    <span class="o">=&gt;</span> <span class="s1">'5db9d7e805ef4b36a8cf0e57900e118a'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">// 取消订单</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=68</span>
        <span class="s1">'cancelBookOrder'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'f40a36ac2dfe42518fb883d33fa33391'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'519114d791b94babba31f32eb5d559eb'</span><span class="p">,</span>
                <span class="s1">'dev'</span>  <span class="o">=&gt;</span> <span class="s1">'519114d791b94babba31f32eb5d559eb'</span><span class="p">,</span>
                <span class="s1">'*'</span>    <span class="o">=&gt;</span> <span class="s1">'519114d791b94babba31f32eb5d559eb'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">// 检测订单状态变化</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=66</span>
        <span class="s1">'listenOrderStatusChange'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'e5e981e2cf9340f99f9cbf79c82668ac'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'61aebb32ae1347c5a274fc9fb4b4f962'</span><span class="p">,</span>
                <span class="s1">'dev'</span>  <span class="o">=&gt;</span> <span class="s1">'61aebb32ae1347c5a274fc9fb4b4f962'</span><span class="p">,</span>
                <span class="s1">'*'</span>    <span class="o">=&gt;</span> <span class="s1">'61aebb32ae1347c5a274fc9fb4b4f962'</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>

        <span class="c1">//查询某城市下各酒店的起价</span>
        <span class="c1">// @see https://dev.ctrip.com/#/document?id=93</span>
        <span class="s1">'fetchLowerPrice'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'prod'</span> <span class="o">=&gt;</span> <span class="s1">'4c6f5dcc4663443b8d8ae044ad8bee10'</span><span class="p">,</span>
                <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'c659a717bf23422b907ff7f9c75022ed'</span><span class="p">,</span>
                <span class="s1">'dev'</span>  <span class="o">=&gt;</span> <span class="s1">'c659a717bf23422b907ff7f9c75022ed'</span><span class="p">,</span>
                <span class="s1">'*'</span>    <span class="o">=&gt;</span> <span class="s1">'c659a717bf23422b907ff7f9c75022ed'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">'rate'</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span> <span class="c1">// 每分钟200次</span>
        <span class="p">]</span>
    <span class="p">];</span>

    <span class="cd">/**
     * 根据key获取携程api icode
     *
     * @param $api
     * @return bool|string
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getCtripIcode</span><span class="p">(</span><span class="nv">$api</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$env</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'APP_ENV'</span><span class="p">);</span>
        <span class="nv">$default</span> <span class="o">=</span> <span class="s1">'*'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'path'</span><span class="p">][</span><span class="nv">$env</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'path'</span><span class="p">][</span><span class="nv">$env</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'path'</span><span class="p">][</span><span class="nv">$default</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cd">/**
     * 获取结果过滤器
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getApiFilter</span><span class="p">(</span><span class="nv">$api</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'filter'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'filter'</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">CtripToken</span>
<span class="p">{</span>

    <span class="k">private</span> <span class="nv">$aid</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$sid</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$redis</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$client</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span>
        <span class="nx">ContainerInterface</span> <span class="nv">$container</span><span class="p">,</span>
        <span class="nx">ClientInterface</span> <span class="nv">$redis</span><span class="p">,</span>
        <span class="nx">LoggerInterface</span> <span class="nv">$logger</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span> <span class="o">=</span> <span class="nv">$redis</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'bl_guzzle.client.ctrip'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aid</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_AID'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sid</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_SID'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_KEY'</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="cd">/**
     * (支持分布式获取Token)获取 token.
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">getToken</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SOURCE</span><span class="o">.</span><span class="s2">"_token"</span><span class="p">);</span>
        <span class="nv">$refreshToken</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SOURCE</span><span class="o">.</span><span class="s2">"_refresh_token"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$token</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$token</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 加锁，避免重复刷新token</span>
        <span class="nv">$lock</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s2">"ctrip:lock"</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="s2">"nx"</span><span class="p">,</span> <span class="s2">"ex"</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="nv">$unlock</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$script</span> <span class="o">=</span> <span class="sh">&lt;&lt;&lt;LUA
if redis.call("get",KEYS[1]) == ARGV[1]
then
    return redis.call("del",KEYS[1])
else
    return 0
end
LUA;</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">eval</span><span class="p">(</span><span class="nv">$script</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"ctrip:lock"</span><span class="p">,</span> <span class="nv">$key</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="nv">$key</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>

        <span class="nx">token</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$lock</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$refreshToken</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// token 初始化</span>
                <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
                    <span class="s1">'/openserviceauth/authorize.ashx?'</span> <span class="o">.</span>
                    <span class="nb">http_build_query</span><span class="p">([</span>
                        <span class="s1">'AID'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aid</span><span class="p">,</span>
                        <span class="s1">'SID'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sid</span><span class="p">,</span>
                        <span class="s1">'KEY'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span>
                    <span class="p">])</span>
                <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// token 更新</span>
                <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
                    <span class="s1">'/openserviceauth/refresh.ashx?'</span><span class="o">.</span>
                    <span class="nb">http_build_query</span><span class="p">([</span>
                        <span class="s1">'AID'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aid</span><span class="p">,</span>
                        <span class="s1">'SID'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sid</span><span class="p">,</span>
                        <span class="s1">'refresh_token'</span> <span class="o">=&gt;</span> <span class="nv">$refreshToken</span><span class="p">,</span>
                    <span class="p">])</span>
                <span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// 解锁失败，说明锁超时，返回null，上层进行重试</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$unlock</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span><span class="s1">'unlock failure'</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span><span class="s1">'lock failure'</span><span class="p">);</span>
            <span class="c1">// 未取得锁，上层进行重试</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// 加锁结束</span>

        <span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">!=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">getStatusCode</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">'CTRIP GET Token Http Client error'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'ErrCode'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'ErrCode'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1005</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 重置刷新Token</span>
            <span class="nv">$refreshToken</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">goto</span> <span class="nx">token</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'Expires_In'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'Access_Token'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'Refresh_Token'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">'CTRIP GET TOKNE Http Client error, response data format error:'</span><span class="o">.</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">setex</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SOURCE</span><span class="o">.</span><span class="s2">"_token"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Expires_In'</span><span class="p">],</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Access_Token'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">setex</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SOURCE</span><span class="o">.</span><span class="s2">"_refresh_token"</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">REFRESH_TOKEN_EXPIRE</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Refresh_Token'</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Access_Token'</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">removeCtripAccessToken</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">del</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SOURCE</span><span class="o">.</span><span class="s2">"_token"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">CtripClient</span>
<span class="p">{</span>

    <span class="k">private</span> <span class="nv">$aid</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$sid</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$redis</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$client</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$messageControl</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$apiRateControl</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span>
        <span class="nx">ContainerInterface</span> <span class="nv">$container</span><span class="p">,</span>
        <span class="nx">ClientInterface</span> <span class="nv">$redis</span><span class="p">,</span>
        <span class="nx">MessageControl</span> <span class="nv">$messageControl</span><span class="p">,</span>
        <span class="nx">LoggerInterface</span> <span class="nv">$logger</span><span class="p">,</span>
        <span class="nx">APIRateControl</span> <span class="nv">$apiRateControl</span><span class="p">,</span>
        <span class="nx">Token</span> <span class="nv">$token</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span> <span class="o">=</span> <span class="nv">$redis</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'bl_guzzle.client.ctrip'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">messageControl</span> <span class="o">=</span> <span class="nv">$messageControl</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">apiRateControl</span> <span class="o">=</span> <span class="nv">$apiRateControl</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">token</span> <span class="o">=</span> <span class="nv">$token</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aid</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_AID'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sid</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_SID'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CTRIP_KEY'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * 支持 API_LIST 里面的所有接口.
     *
     * @param $name
     * @param $arguments
     * @return array
     * @throws FatalException
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__call</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$name</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nx">instanceof</span> <span class="nx">HotelRequest</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDetailData</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">toArray</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\BadMethodCallException</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @param $response
     * @return array|mixed
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">getContent</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">==</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">getStatusCode</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">\GuzzleHttp\json_decode</span><span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">[];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cd">/**
     * 获取数据接口.
     *
     * @param string $api
     * @param array $dataParam
     *
     * @return array
     **/</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">getDetailData</span><span class="p">(</span><span class="nv">$api</span><span class="p">,</span> <span class="nv">$dataParam</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$icode</span> <span class="o">=</span> <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">getCtripIcode</span><span class="p">(</span><span class="nv">$api</span><span class="p">)))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s2">"icode find by api, not found the api:%s"</span><span class="p">,</span> <span class="nv">$api</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="c1">// api 接口测试限制</span>
            <span class="k">if</span> <span class="p">((</span><span class="nv">$coolingSecond</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">apiRateControl</span><span class="o">-&gt;</span><span class="na">getCoolingSecondForAPI</span><span class="p">(</span><span class="nv">$api</span><span class="p">)))</span> <span class="p">{</span>
                <span class="nb">sleep</span><span class="p">(</span><span class="nv">$coolingSecond</span><span class="p">);</span>
            <span class="p">}</span>

<span class="nx">token</span><span class="o">:</span>
            <span class="nv">$token</span> <span class="o">=</span> <span class="nx">Util</span><span class="o">::</span><span class="na">try</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">token</span><span class="o">-&gt;</span><span class="na">getToken</span><span class="p">();</span>
                    <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nv">$token</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'get token retry 3 failure'</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nv">$params</span> <span class="o">=</span> <span class="nb">http_build_query</span><span class="p">([</span>
                    <span class="s1">'AID'</span>   <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aid</span><span class="p">,</span>
                    <span class="s1">'SID'</span>   <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sid</span><span class="p">,</span>
                    <span class="s1">'ICODE'</span> <span class="o">=&gt;</span> <span class="nv">$icode</span><span class="p">,</span>
                    <span class="s1">'UUID'</span>  <span class="o">=&gt;</span> <span class="nx">Util</span><span class="o">::</span><span class="na">getUUID</span><span class="p">(),</span>
                    <span class="s1">'Token'</span> <span class="o">=&gt;</span> <span class="nv">$token</span><span class="p">,</span>
                    <span class="s1">'Mode'</span>  <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">MODE</span><span class="p">,</span>
                    <span class="s1">'Format'</span><span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">FORMAT</span>
            <span class="p">]);</span>

            <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span>
                    <span class="s1">'/openservice/serviceproxy.ashx?'</span><span class="o">.</span><span class="nv">$params</span><span class="p">,</span>
                    <span class="p">[</span>
                    <span class="s1">'json'</span> <span class="o">=&gt;</span> <span class="nv">$dataParam</span>
                    <span class="p">]</span>
                    <span class="p">);</span>

            <span class="nv">$content</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$content</span><span class="p">[</span><span class="s1">'ErrCode'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$content</span><span class="p">[</span><span class="s1">'ErrCode'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">232</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// clear store redis token and retry</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">token</span><span class="o">-&gt;</span><span class="na">removeCtripAccessToken</span><span class="p">();</span>
                <span class="nx">goto</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">((</span><span class="nv">$field</span> <span class="o">=</span> <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">getApiFilter</span><span class="p">(</span><span class="nv">$api</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$content</span><span class="p">[</span><span class="nv">$field</span><span class="p">]))</span> <span class="p">{</span>
                <span class="c1">// 去除重复调用的数据</span>
                <span class="nv">$content</span><span class="p">[</span><span class="nv">$field</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">messageControl</span><span class="o">-&gt;</span><span class="na">filterMessage</span><span class="p">(</span><span class="nv">$content</span><span class="p">[</span><span class="nv">$field</span><span class="p">]);</span>
                <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Throwable</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">'CtripClient Throwable'</span><span class="p">,</span> <span class="p">[</span>
                    <span class="s1">'api'</span> <span class="o">=&gt;</span> <span class="nv">$api</span><span class="p">,</span>
                    <span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nv">$dataParam</span><span class="p">,</span>
                    <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span>
            <span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">successAndReturnLastRecordId</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$successAndReturnLastRecordId</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">success</span><span class="p">(</span><span class="nv">$response</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">'PagingInfo'</span><span class="p">][</span><span class="s1">'LastRecordID'</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">'PagingInfo'</span><span class="p">][</span><span class="s1">'LastRecordID'</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nv">$successAndReturnLastRecordId</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">success</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$success</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">'ResponseStatus'</span><span class="p">][</span><span class="s1">'Ack'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">'ResponseStatus'</span><span class="p">][</span><span class="s1">'Ack'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Success'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nv">$success</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 工具类封装</span>
<span class="kd">class</span> <span class="nc">Util</span>
<span class="p">{</span>
	<span class="c1">// 重试逻辑，正常逻辑和异常逻辑分开</span>
	<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">retry</span><span class="p">(</span><span class="nv">$retries</span><span class="p">,</span> <span class="nx">callable</span> <span class="nv">$fn</span><span class="p">,</span> <span class="nv">$sleep</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$base</span> <span class="o">=</span> <span class="nv">$retries</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

        <span class="nx">beginning</span><span class="o">:</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$fn</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$retries</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$sleep</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 休眠时间递增(单位s), 1, 2, 5</span>
                <span class="nv">$sleepTime</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$base</span> <span class="o">-</span> <span class="nv">$retries</span><span class="p">)</span> <span class="o">/</span> <span class="nv">$retries</span><span class="p">;</span>
                <span class="nb">sleep</span><span class="p">(</span><span class="nv">$sleepTime</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nv">$retries</span><span class="o">--</span><span class="p">;</span>
            <span class="nx">goto</span> <span class="nx">beginning</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">const</span> <span class="no">LOOP_RUN_CONTINUE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">LOOP_NORMAL_STOP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">LOOP_API_EXCEPTION_STOP</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="cd">/**
     * 任务循环器, 可复用,用于分页数据获取.
     *
     * @param $run
     * @param mixed ...$args
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">loop</span><span class="p">(</span><span class="nv">$run</span><span class="p">,</span> <span class="o">...</span><span class="nv">$args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$loop</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$run</span><span class="p">,</span> <span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="c1">// status: 0 循环, 1 正常结束, 2 接口异常结束</span>
                <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$run</span><span class="p">(</span><span class="o">...</span><span class="nv">$args</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nv">$loop</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 携程接口API调用频次记录，并且返回冷却时间</span>
<span class="kd">class</span> <span class="nc">APIRateControl</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$redis</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">KEY_PREFIX</span> <span class="o">=</span> <span class="s1">'ctrip:rate:'</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">ClientInterface</span> <span class="nv">$redis</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span> <span class="o">=</span> <span class="nv">$redis</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * 获取API冷却时间.
     *
     * @param string $api
     * @param string $second
     * @param int $times
     *
     * @return int
     * @throws \Exception
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAPICoolingSecond</span><span class="p">(</span><span class="nv">$api</span><span class="p">,</span> <span class="nv">$second</span><span class="p">,</span> <span class="nv">$times</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$lockedTimes</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$api</span><span class="p">,</span> <span class="nv">$expire</span><span class="p">,</span> <span class="nv">$times</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$script</span> <span class="o">=</span> <span class="sh">&lt;&lt;&lt;LUA
local times = redis.call('incr',KEYS[1])

-- 第一次访问的时候加上过期时间60秒（60秒过后从新计数）
if times == 1 then
    redis.call('expire',KEYS[1], ARGV[1])
end

-- 注意，从redis进来的默认为字符串，lua同种数据类型只能和同种数据类型比较
if times &gt; tonumber(ARGV[2]) then
    return 0
end
return 1
LUA;</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">eval</span><span class="p">(</span><span class="nv">$script</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">KEY_PREFIX</span><span class="o">.</span><span class="nv">$api</span><span class="p">,</span> <span class="nv">$expire</span><span class="p">,</span> <span class="nv">$times</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$lockedTimes</span><span class="p">(</span><span class="nv">$api</span><span class="p">,</span> <span class="nv">$second</span><span class="p">,</span> <span class="nv">$times</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$sleep</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">ttl</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">KEY_PREFIX</span><span class="o">.</span><span class="nv">$api</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$sleep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$sleep</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cd">/**
     * 冷却时间.
     *
     * @param string $api
     *
     * @return int
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCoolingSecondForAPI</span><span class="p">(</span><span class="nv">$api</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'rate'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getAPICoolingSecond</span><span class="p">(</span>
            <span class="nv">$api</span><span class="p">,</span>
            <span class="mi">60</span><span class="p">,</span>
            <span class="nx">CtripConfig</span><span class="o">::</span><span class="na">API_LIST</span><span class="p">[</span><span class="nv">$api</span><span class="p">][</span><span class="s1">'rate'</span><span class="p">]</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="o">&lt;?</span><span class="nx">php</span>

<span class="kn">use</span> <span class="nn">Adbar\Dot</span><span class="p">;</span>

<span class="cd">/**
 *
 * 使用如下：
 *  // 测试HotelRequest toArray
 * $r = new HotelRequest();
 * $r-&gt;PagingSettings_LastRecordID = 100;
 * $r-&gt;PagingSettings_PageSize = 200;
 * $r-&gt;Settings_ExtendedNodes = [ 'HotelStaticInfo.GeoInfo' ];
 * $r-&gt;Settings_PrimaryLangID = 'zh_cn';
 * echo $r-&gt;toJson(),PHP_EOL;
 * var_dump($r-&gt;toArray());
 */</span>

<span class="kd">class</span> <span class="nc">HotelRequest</span>
<span class="p">{</span>
    <span class="c1">// 格式     'SearchCandidate_HotelID' =&gt; 'SearchCandidate.HotelID',</span>
    <span class="k">const</span> <span class="no">RULES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1">// 酒店</span>
        <span class="s1">'SearchCandidate_HotelID'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.HotelID'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_RoomIDs'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.RoomIDs'</span><span class="p">,</span>
        <span class="s1">'Settings_PrimaryLangID'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.PrimaryLangID'</span><span class="p">,</span>
        <span class="s1">'Settings_ExtendedNodes'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.ExtendedNodes'</span><span class="p">,</span>
        <span class="s1">'Settings_SearchTags'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.SearchTags'</span><span class="p">,</span>
        <span class="s1">'PagingSettings_PageSize'</span> <span class="o">=&gt;</span> <span class="s1">'PagingSettings.PageSize'</span><span class="p">,</span>
        <span class="s1">'PagingSettings_LastRecordID'</span> <span class="o">=&gt;</span> <span class="s1">'PagingSettings.LastRecordID'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_DateTimeRange_Start'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.DateTimeRange.Start'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_DateTimeRange_End'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.DateTimeRange.End'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_StartTime'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.StartTime'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_Duration'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.Duration'</span><span class="p">,</span>
        <span class="s1">'Settings_ShowDataRange'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.ShowDataRange'</span><span class="p">,</span>
        <span class="s1">'Settings_IsShowChangeDetails'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.IsShowChangeDetails'</span><span class="p">,</span>
        <span class="s1">'Settings_DataCategory'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.DataCategory'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_SearchByType_SearchType'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.SearchByType.SearchType'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_SearchByType_IsHaveHotel'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.SearchByType.IsHaveHotel'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_SearchByCityID_CityID'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.SearchByCityID.CityID'</span><span class="p">,</span>

        <span class="c1">// 订单部分 //</span>
        <span class="c1">// 可预订检查</span>
        <span class="s1">'AvailRequestSegments_Version'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.Version'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_TransactionIdentifier'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.TransactionIdentifier'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_HotelRef_HotelCode'</span> <span class="o">=&gt;</span>
        <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.HotelRef.HotelCode'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_StayDateRange_Start'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.StayDateRange.Start'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_StayDateRange_End'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.StayDateRange.End'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RoomID'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RatePlanCandidates.RatePlanCandidate.RoomID'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RatePlanID'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RatePlanCandidates.RatePlanCandidate.RatePlanID'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RatePlanCategory'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RatePlanCandidates.RatePlanCandidate.RatePlanCategory'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_PrepaidIndicator'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RatePlanCandidates.RatePlanCandidate.PrepaidIndicator'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RoomStayCandidates_RoomStayCandidate_GuestCounts_GuestCount_Count'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RoomStayCandidates.RoomStayCandidate.GuestCounts.GuestCount.Count'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RoomStayCandidates_RoomStayCandidate_Quantity'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.RoomStayCandidates.RoomStayCandidate.Quantity'</span><span class="p">,</span>
        <span class="s1">'AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_TPA_Extensions_LateArrivalTime'</span> <span class="o">=&gt;</span> <span class="s1">'AvailRequestSegments.AvailRequestSegment.HotelSearchCriteria.Criterion.TPA_Extensions.LateArrivalTime'</span><span class="p">,</span>
        <span class="c1">// 保存订单</span>
        <span class="s1">'Version'</span> <span class="o">=&gt;</span> <span class="s1">'Version'</span><span class="p">,</span>
        <span class="s1">'TransactionIdentifier'</span> <span class="o">=&gt;</span> <span class="s1">'TransactionIdentifier'</span><span class="p">,</span>
        <span class="s1">'UniqueID'</span> <span class="o">=&gt;</span> <span class="s1">'UniqueID'</span><span class="p">,</span>
        <span class="s1">'UniqueID_Type'</span> <span class="o">=&gt;</span> <span class="s1">'UniqueID.Type'</span><span class="p">,</span>
        <span class="s1">'UniqueID_ID'</span> <span class="o">=&gt;</span> <span class="s1">'UniqueID.ID'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_RoomTypes_RoomType_NumberOfUnits'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.RoomTypes.RoomType.NumberOfUnits'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RoomID'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.RatePlans.RatePlan.RoomID'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RatePlanCategory'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.RatePlans.RatePlan.RatePlanCategory'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_PrepaidIndicator'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.RatePlans.RatePlan.PrepaidIndicator'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RatePlanID'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.RatePlans.RatePlan.RatePlanID'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_RoomStays_RoomStay_BasicPropertyInfo_HotelCode'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.RoomStays.RoomStay.BasicPropertyInfo.HotelCode'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_PersonName'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.PersonName'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_PersonName_Name'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.ContactPerson.PersonName.Name'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_Telephone_PhoneTechType'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.ContactPerson.Telephone.PhoneTechType'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_Telephone_PhoneNumber'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.ContactPerson.Telephone.PhoneNumber'</span><span class="p">,</span>

        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_ContactType'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.ContactPerson.ContactType'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.Profiles.ProfileInfo.Profile.Customer.ContactPerson'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_TPA_Extensions_LateArrivalTime'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.TPA_Extensions.LateArrivalTime'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGuests_ResGuest_ArrivalTime'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGuests.ResGuest.ArrivalTime'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_GuestCounts_GuestCount_Count'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.GuestCounts.GuestCount.Count'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_TimeSpan_Start'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.TimeSpan.Start'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_TimeSpan_End'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.TimeSpan.End'</span><span class="p">,</span>
        <span class="c1">//'HotelReservations_HotelReservation_ResGlobalInfo_DepositPayments' =&gt; 'HotelReservations.HotelReservation.ResGlobalInfo.DepositPayments',</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_Total_ExclusiveAmount'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.Total.ExclusiveAmount'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_Total_InclusiveAmount'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.Total.InclusiveAmount'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_Total_CurrencyCode'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.Total.CurrencyCode'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_ExclusiveAmount'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.TPA_Extensions.TotalCost.ExclusiveAmount'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_InclusiveAmount'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.TPA_Extensions.TotalCost.InclusiveAmount'</span><span class="p">,</span>
        <span class="s1">'HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_CurrencyCode'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations.HotelReservation.ResGlobalInfo.TPA_Extensions.TotalCost.CurrencyCode'</span><span class="p">,</span>

        <span class="c1">// 订单提交</span>
        <span class="s1">'ReservationPayment_ReservationID_Type'</span> <span class="o">=&gt;</span> <span class="s1">'ReservationPayment.ReservationID.Type'</span><span class="p">,</span>
        <span class="s1">'ReservationPayment_ReservationID_ID'</span> <span class="o">=&gt;</span> <span class="s1">'ReservationPayment.ReservationID.ID'</span><span class="p">,</span>
        <span class="s1">'ReservationPayment_PaymentDetail'</span> <span class="o">=&gt;</span> <span class="s1">'ReservationPayment.PaymentDetail'</span><span class="p">,</span>
        <span class="s1">'ReservationPayment_Invoice'</span> <span class="o">=&gt;</span> <span class="s1">'ReservationPayment.Invoice'</span><span class="p">,</span>

        <span class="c1">// 监测订单状态变化</span>
        <span class="s1">'HotelReservations'</span> <span class="o">=&gt;</span> <span class="s1">'HotelReservations'</span><span class="p">,</span>
        <span class="s1">'SearchTypeEntity_SearchType'</span> <span class="o">=&gt;</span> <span class="s1">'SearchTypeEntity.SearchType'</span><span class="p">,</span>
        <span class="s1">'SearchTypeEntity_HotelCount'</span> <span class="o">=&gt;</span> <span class="s1">'SearchTypeEntity.HotelCount'</span><span class="p">,</span>
        <span class="s1">'SearchTypeEntity_PageIndex'</span> <span class="o">=&gt;</span> <span class="s1">'SearchTypeEntity.PageIndex'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_City'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.City'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_CheckInDate'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.CheckInDate'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_CheckOutDate'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.CheckOutDate'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_HotelList'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.HotelList'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_FilterRoomByPerson'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.FilterRoomByPerson'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_OnlyPPPrice'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.OnlyPPPrice'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_OnlyFGPrice'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.OnlyFGPrice'</span><span class="p">,</span>
        <span class="s1">'PublicSearchParameter_IsJustifyConfirm'</span> <span class="o">=&gt;</span> <span class="s1">'PublicSearchParameter.IsJustifyConfirm'</span><span class="p">,</span>
        <span class="s1">'FacilityEntity_ChildrenAgeList'</span> <span class="o">=&gt;</span> <span class="s1">'FacilityEntity.ChildrenAgeList'</span><span class="p">,</span>
        <span class="s1">'FacilityEntity_priceRange_lowPrice'</span> <span class="o">=&gt;</span> <span class="s1">'FacilityEntity.priceRange.lowPrice'</span><span class="p">,</span>
        <span class="s1">'FacilityEntity_priceRange_highPrice'</span> <span class="o">=&gt;</span> <span class="s1">'FacilityEntity.priceRange.highPrice'</span><span class="p">,</span>
        <span class="s1">'OrderBy_OrderName'</span> <span class="o">=&gt;</span> <span class="s1">'OrderBy.OrderName'</span><span class="p">,</span>
        <span class="s1">'OrderBy_OrderType'</span> <span class="o">=&gt;</span> <span class="s1">'OrderBy.OrderType'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_DateRange_Start'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.DateRange.Start'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_DateRange_End'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.DateRange.End'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_Occupancy_Adult'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.Occupancy.Adult'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_Occupancy_Child'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.Occupancy.Child'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_Occupancy_ChildInfo'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.Occupancy.ChildInfo'</span><span class="p">,</span>
        <span class="s1">'SearchCandidate_SearchTags'</span> <span class="o">=&gt;</span> <span class="s1">'SearchCandidate.SearchTags'</span><span class="p">,</span>
        <span class="s1">'Settings_DisplayCurrency'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.DisplayCurrency'</span><span class="p">,</span>
        <span class="s1">'Settings_IsShowNonBookable'</span> <span class="o">=&gt;</span> <span class="s1">'Settings.IsShowNonBookable'</span><span class="p">,</span>
    <span class="p">];</span>


    <span class="k">public</span> <span class="nv">$Version</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$TransactionIdentifier</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_HotelID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_RoomIDs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_PrimaryLangID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_ExtendedNodes</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_SearchTags</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PagingSettings_PageSize</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PagingSettings_LastRecordID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_DateTimeRange_Start</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_DateTimeRange_End</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_StartTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_Duration</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_ShowDataRange</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_IsShowChangeDetails</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_DataCategory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_SearchByType_SearchType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_SearchByType_IsHaveHotel</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_SearchByCityID_CityID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchTypeEntity_SearchType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchTypeEntity_HotelCount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchTypeEntity_PageIndex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_City</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_CheckInDate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_CheckOutDate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_HotelList</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_FilterRoomByPerson</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_OnlyPPPrice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_OnlyFGPrice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$PublicSearchParameter_IsJustifyConfirm</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$FacilityEntity_ChildrenAgeList</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$FacilityEntity_priceRange_lowPrice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$FacilityEntity_priceRange_highPrice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$OrderBy_OrderName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$OrderBy_OrderType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_DateRange_Start</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_DateRange_End</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_Occupancy_Adult</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_Occupancy_Child</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_Occupancy_ChildInfo</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$SearchCandidate_SearchTags</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_DisplayCurrency</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$Settings_IsShowNonBookable</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_HotelRef_HotelCode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_StayDateRange_Start</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_StayDateRange_End</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RoomID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RatePlanID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_RatePlanCategory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RatePlanCandidates_RatePlanCandidate_PrepaidIndicator</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RoomStayCandidates_RoomStayCandidate_GuestCounts_GuestCount_Count</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_RoomStayCandidates_RoomStayCandidate_Quantity</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_AvailRequestSegment_HotelSearchCriteria_Criterion_TPA_Extensions_LateArrivalTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_Version</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$AvailRequestSegments_TransactionIdentifier</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="c1">//public $HotelReservations_HotelReservation_ResGlobalInfo_DepositPayments = [];</span>
    <span class="k">public</span> <span class="nv">$UniqueID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$UniqueID_Type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$UniqueID_ID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_RoomTypes_RoomType_NumberOfUnits</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RoomID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RatePlanCategory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_PrepaidIndicator</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_RatePlans_RatePlan_RatePlanID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_RoomStays_RoomStay_BasicPropertyInfo_HotelCode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_PersonName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_PersonName_Name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_Telephone_PhoneTechType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_Telephone_PhoneNumber</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson_ContactType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_Profiles_ProfileInfo_Profile_Customer_ContactPerson</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_TPA_Extensions_LateArrivalTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGuests_ResGuest_ArrivalTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_GuestCounts_GuestCount_Count</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_TimeSpan_Start</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_TimeSpan_End</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_Total_ExclusiveAmount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_Total_InclusiveAmount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_Total_CurrencyCode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_ExclusiveAmount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_InclusiveAmount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$HotelReservations_HotelReservation_ResGlobalInfo_TPA_Extensions_TotalCost_CurrencyCode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$ReservationPayment_ReservationID_Type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$ReservationPayment_ReservationID_ID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$ReservationPayment_PaymentDetail</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$ReservationPayment_Invoice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$dot</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">HOTEL_STATIC_INFO_EXTENDED_NODES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"HotelStaticInfo.GeoInfo"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.NearbyPOIs"</span><span class="p">,</span><span class="c1">//已废弃请下线处理</span>
        <span class="s2">"HotelStaticInfo.TransportationInfos"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.Brand"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.Group"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.Ratings"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.Policies"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.AcceptedCreditCards"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.ImportantNotices"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.Facilities"</span><span class="p">,</span> <span class="c1">//已废弃，请切换至FacilitiesV2节点</span>
        <span class="s2">"HotelStaticInfo.FacilitiesV2"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.Pictures"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.Descriptions"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.Themes"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.ContactInfo"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelTags.IsBookable"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.HotelTags.IsHeCheng"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.ArrivalTimeLimitInfo"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.DepartureTimeLimitInfo"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.ExternalFacility.Parking"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.ExternalFacility.ChargingPoint"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.BossInfos"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.NormalizedPolicies.ChildAndExtraBedPolicy"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.HotelDiscount"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.SellerShowInfos"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.VideoItems"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.NormalizedPolicies.MealsPolicy"</span><span class="p">,</span> <span class="c1">//已废弃，请切换至MealsPolicyV2</span>
        <span class="s2">"HotelStaticInfo.NormalizedPolicies.MealsPolicyV2"</span><span class="p">,</span><span class="c1">//重要</span>
        <span class="s2">"HotelStaticInfo.HotelTags.ReservedData"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelPromotions"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelTaxRuleInfos"</span><span class="p">,</span><span class="c1">//重UniqueID要</span>
        <span class="s2">"HotelStaticInfo.SepecialServiceForChinese"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelFeatures"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelUsedNames"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.BnBHotel"</span><span class="p">,</span> <span class="c1">// 获取民宿酒店专有信息</span>
        <span class="s2">"HotelStaticInfo.ContactPersonInfos"</span><span class="p">,</span>
        <span class="s2">"HotelStaticInfo.HotelCloseTime"</span><span class="p">,</span>  <span class="c1">//酒店不营业时段</span>
    <span class="p">];</span>

    <span class="k">const</span> <span class="no">ROOM_TYPE_STATIC_EXTENDED_NODES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1">//物理房型相关扩展节点</span>
        <span class="s2">"RoomTypeInfo.Facilities"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.Pictures"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.Descriptions"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.ChildLimit"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.BroadNet"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.RoomBedInfos"</span><span class="p">,</span>
        <span class="s2">"RoomTypeInfo.BnBHotel"</span><span class="p">,</span>    <span class="c1">// 获取民宿房型专有信息</span>
        <span class="s2">"RoomTypeInfo.Smoking"</span><span class="p">,</span><span class="c1">//已废弃，请使用售卖房型吸烟信息</span>
        <span class="s2">"RoomTypeInfo.RoomTypeTags.ReservedData"</span><span class="p">,</span>
        <span class="c1">//售卖房型相关扩展节点</span>
        <span class="s2">"RoomInfo.ApplicabilityInfo"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.Smoking"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.BroadNet"</span><span class="p">,</span><span class="c1">//已废弃，请使用物理房型层宽带信息，售卖房型层宽带信息暂停使用</span>
        <span class="s2">"RoomInfo.RoomBedInfos"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.RoomFGToPPInfo"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.ChannelLimit"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.ExpressCheckout"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.RoomTags"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.RoomGiftInfos"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.AreaApplicabilityInfo"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.RoomPromotions"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.HotelPromotions"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.MaskCampaignInfos"</span><span class="p">,</span><span class="c1">//Mask房型获取</span>
        <span class="s2">"RoomInfo.BookingRules"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.RoomTags.HotelDiscount"</span><span class="p">,</span>
        <span class="s2">"RoomInfo.IsNeedCustomerTelephone"</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">const</span> <span class="no">ROOM_TYPE_STATIC_SEARCH_TAGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">"Code"</span> <span class="o">=&gt;</span> <span class="s2">"IsOutputHiddenMaskRoom"</span><span class="p">,</span> <span class="c1">//异地Mask房型获取</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="s2">"Code"</span><span class="o">=&gt;</span> <span class="s2">"IsOutputLimitDestinationRoom"</span><span class="p">,</span> <span class="c1">//目的地Mask房型获取</span>
        <span class="p">]</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dot</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">convertData</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">RULES</span> <span class="k">as</span> <span class="nv">$underlineRule</span> <span class="o">=&gt;</span> <span class="nv">$dotRule</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$underlineRule</span><span class="p">})</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dot</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$dotRule</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$underlineRule</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">toArray</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">convertData</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dot</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">toJson</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">convertData</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dot</span><span class="o">-&gt;</span><span class="na">toJson</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kd">class</span> <span class="nc">Test</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$ctripClient</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ctripClient</span> <span class="o">=</span> <span class="nv">$ctripClient</span><span class="p">;</span>
	<span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$fetchOnePage</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="o">&amp;</span><span class="nv">$lastRecordId</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HotelRequest</span><span class="p">();</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">SearchCandidate_SearchByType_SearchType</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">SEARCH_TYPE</span><span class="p">;</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">SearchCandidate_SearchByType_IsHaveHotel</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">IS_HAVE_HOTEL</span><span class="p">;</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">PagingSettings_PageSize</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">PAGE_SIZE</span><span class="p">;</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">PagingSettings_LastRecordID</span> <span class="o">=</span> <span class="nv">$lastRecordId</span><span class="p">;</span>

            <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ctripClient</span><span class="o">-&gt;</span><span class="na">getAllCityInfo</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">CtripClient</span><span class="o">::</span><span class="na">success</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">'CityInfos'</span><span class="p">][</span><span class="s1">'CityInfo'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">Util</span><span class="o">::</span><span class="na">LOOP_API_EXCEPTION_STOP</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">'CityInfos'</span><span class="p">][</span><span class="s1">'CityInfo'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$city</span><span class="p">)</span> <span class="p">{</span>
				<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$city</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nv">$lastRecordId</span> <span class="o">=</span> <span class="nx">CtripClient</span><span class="o">::</span><span class="na">successAndReturnLastRecordId</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$lastRecordId</span><span class="p">))</span> <span class="p">{</span>
                <span class="nb">unset</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">Util</span><span class="o">::</span><span class="na">LOOP_NORMAL_STOP</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nb">unset</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">Util</span><span class="o">::</span><span class="na">LOOP_RUN_CONTINUE</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="nv">$lastRecordId</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="nx">Util</span><span class="o">::</span><span class="na">loop</span><span class="p">(</span><span class="nv">$fetchOnePage</span><span class="p">,</span> <span class="nv">$lastRecordId</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$test</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Test</span><span class="p">(</span><span class="k">new</span> <span class="nx">CtripClient</span><span class="p">());</span>
<span class="nv">$test</span><span class="o">-&gt;</span><span class="na">main</span><span class="p">();</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">CtripConfig</code>配置信息类</li>
  <li><code class="highlighter-rouge">CtripToken</code>维护携程token类支持多进程并发获取token。</li>
  <li><code class="highlighter-rouge">CtripClient</code>对外提供的客户端类</li>
  <li><code class="highlighter-rouge">HotelRequest</code>对外提供的请求类</li>
  <li><code class="highlighter-rouge">Util</code>工具类</li>
  <li><code class="highlighter-rouge">Test</code>演示类</li>
</ul>

<p>总结：支持分布式获取token；支持HotelRequest请求类参数配置；支持接口配置；支持接口限速配置；封装重试方法；封装分页循环获取方法。</p>


    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    May
    22nd,
    
    2020
  </span>

  <h2>
    <a href="/heap/2020/05/22/heap.html">二叉堆笔记</a>
  </h2>

  <div>
    
    <h2 id="介绍">介绍</h2>

<p>一个小顶堆(或大顶堆)是一个完整的二叉树。其中每个节点都小于其子节点。因此，根是树中的最小元素。</p>

<p><img src="assets/media/WX20200522-192421@2x.png" alt="图-2" /></p>

<p>在最小堆中有两个关键操作：<code class="highlighter-rouge">insert</code>和<code class="highlighter-rouge">extract_min</code>。</p>

<h2 id="插入操作">插入操作</h2>

<p>当我们向一个最小堆插入元素时，总是从底部开始。从最右边的节点开始插入操作以保持树的完整性。然后，通过与其祖先节点进行交换来“修复”树，直到找到新元素的适当位置。我们基本上是在向上传递最小的元素</p>

<p><img src="assets/media/WX20200522-192404@2x.png" alt="图-1" /></p>

<h2 id="提取最小元素">提取最小元素</h2>

<p>找到小顶堆的最小元素是小菜一碟：它总是在顶部。颇为棘手的是如何删除该元素（其实也不是那么棘手）。首先，删除最小元素并将其与堆中的最后一个元素（位于最底层、最右边的元素）进行交换。然后，向下传递这个元素，不断使其与自身子节点之一进行交换，直到小顶堆的属性得以恢复。是和左边的孩子节点还是右边的孩子节点进行交换取决于它们的值。左右元素之间没有固定的顺序，但是为了保持小顶堆的元素有序，你需要选择两者中较小的元素。</p>

<p><img src="assets/media/WX20200522-192346@2x.png" alt="图-3" /></p>

<h2 id="堆的基本操作">堆的基本操作</h2>

<p>堆的几个基本操作都依赖于两个重要的函数<code class="highlighter-rouge">siftUp</code>和<code class="highlighter-rouge">siftDown</code>，堆的insert通常是在堆尾插入新元素并siftUp调整堆，而<code class="highlighter-rouge">extractMin</code>是在删除堆顶元素，然后将最后一个元素放置堆顶并调用<code class="highlighter-rouge">siftDown</code>调整堆。
堆得基本操作的时间复杂度如下表所示：</p>
<ul>
  <li>heapify O(N)</li>
  <li>insert O(logN)</li>
  <li>extractMin O(logN)</li>
  <li>delete O(logN)</li>
  <li>peek O(1)</li>
</ul>

<h2 id="总结">总结</h2>

<ul>
  <li>（1）堆是一颗完全二叉树；</li>
  <li>（2）小（大）顶堆中的每一个节点都不小于（不大于）它的父节点；</li>
  <li>（3）堆的插入、删除元素的时间复杂度都是O(log n)；</li>
  <li>（4）建堆的时间复杂度是O(n)；</li>
  <li>（5）堆排序的时间复杂度是O(nlog n)；</li>
  <li>（6）堆排序的空间复杂度是O(1)；</li>
</ul>

<h2 id="代码">代码</h2>

<p>最小堆代码示例:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">Heap</span>
<span class="p">{</span>

    <span class="k">private</span> <span class="nv">$items</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$size</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$length</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">=</span> <span class="nv">$length</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">peek</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">??</span><span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">insert</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span> <span class="o">==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shitUp</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">extractMin</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$min</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">peek</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nv">$min</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$min</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="o">--</span><span class="p">;</span>
        <span class="nb">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="p">]);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shitDown</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$min</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">shitUp</span><span class="p">(</span><span class="nv">$pos</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="nv">$pos</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$pos</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$parentPos</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$pos</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$parentPos</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$pos</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$parentPos</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$parentPos</span><span class="p">])</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$parentPos</span><span class="p">],</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">],</span>
            <span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shitUp</span><span class="p">(</span><span class="nv">$parentPos</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">shitDown</span><span class="p">(</span><span class="nv">$pos</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$left</span> <span class="o">=</span> <span class="nv">$pos</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nv">$right</span> <span class="o">=</span> <span class="nv">$pos</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nv">$mpos</span> <span class="o">=</span> <span class="nv">$pos</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$left</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$left</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">])</span> <span class="p">{</span>
            <span class="nv">$mpos</span> <span class="o">=</span> <span class="nv">$left</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$right</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$right</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$mpos</span><span class="p">])</span> <span class="p">{</span>
            <span class="nv">$mpos</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$mpos</span> <span class="o">!=</span> <span class="nv">$pos</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$mpos</span><span class="p">])</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$mpos</span><span class="p">],</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$pos</span><span class="p">],</span>
            <span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shitDown</span><span class="p">(</span><span class="nv">$mpos</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">display</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_display</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_display</span><span class="p">(</span><span class="nv">$root</span><span class="p">,</span> <span class="nv">$layout</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$root</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">echo</span> <span class="nb">str_repeat</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$layout</span><span class="p">)</span><span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$root</span><span class="p">],</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

        <span class="nv">$left</span> <span class="o">=</span> <span class="nv">$root</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="nv">$right</span> <span class="o">=</span> <span class="nv">$root</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nv">$layout</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$left</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_display</span><span class="p">(</span><span class="nv">$left</span><span class="p">,</span> <span class="nv">$layout</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$right</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_display</span><span class="p">(</span><span class="nv">$right</span><span class="p">,</span> <span class="nv">$layout</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$heap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">self</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">echo</span> <span class="s1">'遍历显示堆'</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">();</span>

        <span class="k">echo</span> <span class="s2">"peek"</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">peek</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

        <span class="k">echo</span> <span class="s2">"extractMin"</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">extractMin</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">extractMin</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">extractMin</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

        <span class="k">echo</span> <span class="s2">"peek"</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">peek</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

        <span class="k">echo</span> <span class="s2">"extractMin"</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">extractMin</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">extractMin</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

        <span class="k">echo</span> <span class="s1">'遍历显示堆'</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nv">$heap</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Heap</span><span class="o">::</span><span class="na">main</span><span class="p">();</span>

</code></pre></div></div>

<p>运行结果:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
遍历显示堆
1
        3
                4
                8
        5
                9
                10
peek
1
extractMin
1
3
4
peek
5
extractMin
5
8
遍历显示堆
9
        10

</code></pre></div></div>

<p>二叉堆排序代码如下:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">HeapSort</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$items</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$items</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span> <span class="o">=</span> <span class="nv">$items</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">sort</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$arrLen</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">buildMaxHeap</span><span class="p">(</span><span class="nv">$arrLen</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$arrLen</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">];</span>

            <span class="nv">$arrLen</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">heapify</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$arrLen</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">buildMaxHeap</span><span class="p">(</span><span class="nv">$arrLen</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$arrLen</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span> <span class="nv">$i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">heapify</span><span class="p">(</span><span class="nv">$i</span><span class="p">,</span> <span class="nv">$arrLen</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">heapify</span><span class="p">(</span><span class="nv">$i</span><span class="p">,</span> <span class="nv">$arrLen</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$left</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nv">$i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nv">$right</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nv">$i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nv">$largest</span> <span class="o">=</span> <span class="nv">$i</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$left</span> <span class="o">&lt;</span> <span class="nv">$arrLen</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$left</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$largest</span><span class="p">])</span> <span class="p">{</span>
            <span class="nv">$largest</span> <span class="o">=</span> <span class="nv">$left</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$right</span> <span class="o">&lt;</span> <span class="nv">$arrLen</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$right</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$largest</span><span class="p">])</span> <span class="p">{</span>
            <span class="nv">$largest</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$largest</span> <span class="o">!=</span> <span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$largest</span><span class="p">])</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$largest</span><span class="p">],</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span>
            <span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">heapify</span><span class="p">(</span><span class="nv">$largest</span><span class="p">,</span> <span class="nv">$arrLen</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">7</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
        <span class="p">];</span>
        <span class="k">echo</span> <span class="s1">'排序前'</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$items</span><span class="p">);</span>

        <span class="nv">$self</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">self</span><span class="p">(</span><span class="nv">$items</span><span class="p">);</span>
        <span class="k">echo</span> <span class="s1">'排序后'</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="na">sort</span><span class="p">());</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">HeapSort</span><span class="o">::</span><span class="na">main</span><span class="p">();</span>

</code></pre></div></div>

<p>运行结果:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/local/opt/php@7.1/bin/php /Users/martin/heapsort.php
排序前
/Users/martin/heapsort.php:70:
array(7) {
  [0] =&gt;
  int(1)
  [1] =&gt;
  int(5)
  [2] =&gt;
  int(3)
  [3] =&gt;
  int(6)
  [4] =&gt;
  int(2)
  [5] =&gt;
  int(7)
  [6] =&gt;
  int(4)
}
排序后
/Users/martin/heapsort.php:74:
array(7) {
  [0] =&gt;
  int(1)
  [1] =&gt;
  int(2)
  [2] =&gt;
  int(3)
  [3] =&gt;
  int(4)
  [4] =&gt;
  int(5)
  [5] =&gt;
  int(6)
  [6] =&gt;
  int(7)
}

</code></pre></div></div>

<h2 id="延伸">延伸</h2>

<ul>
  <li>优先队列</li>
  <li>堆排序</li>
  <li>海量实数中（一亿级别以上）找到TopK（一万级别以下）的数集合。</li>
</ul>

<h2 id="参考">参考</h2>
<ul>
  <li>https://blog.csdn.net/u014532901/article/details/78573556</li>
  <li>https://zhuanlan.zhihu.com/p/78146654</li>
</ul>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    May
    16th,
    
    2020
  </span>

  <h2>
    <a href="/trie/2020/05/16/trie-node.html">Trie</a>
  </h2>

  <div>
    
    <h2 id="介绍">介绍</h2>

<p>Trie树,又称单词查找树、字典树，是一种树形结构，是一种哈希树的变种，是一种用于快速检索的多叉树结构。典型应用是用于统计和排序大量的字符串（但不仅限于字符串），所以经常被搜索引擎系统用于文本词频统计。</p>

<p>它的优点是：最大限度地减少无谓的字符串比较，查询效率比哈希表高。Trie 的强大之处就在于它的时间复杂度，插入和查询的效率很高，都为O(N)，其中 N 是待插入/查询的字符串的长度，而与 Trie 中保存了多少个元素无关。
Trie的核心思想是空间换时间。利用字符串的公共前缀来降低查询时间的开销以达到提高效率的目的。
Trie树也有它的缺点,Trie树的内存消耗非常大。</p>

<h2 id="三个基本特性">三个基本特性</h2>
<p>1）根节点不包含字符，除根节点外每一个节点都只包含一个字符。　　</p>

<p>2）从根节点到某一节点，路径上经过的字符连接起来，为该节点对应的字符串。　</p>

<p>3）每个节点的所有子节点包含的字符都不相同。</p>

<h2 id="用php实现一版">用PHP实现一版。</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">TrieNode</span>
<span class="p">{</span>
    <span class="c1">// &lt;char, TrieNode&gt;</span>
    <span class="k">public</span> <span class="nv">$children</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">public</span> <span class="nv">$isEnfOfWord</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Trie</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$root</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TrieNode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">insert</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$word</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$current</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span><span class="p">;</span>

        <span class="nv">$l</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$word</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$l</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$c</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$current</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$c</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$current</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$c</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TrieNode</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$current</span> <span class="o">=</span> <span class="nv">$current</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$c</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="nv">$current</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">search</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$word</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$current</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span><span class="p">;</span>

        <span class="nv">$l</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$word</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$l</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$c</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$current</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$c</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$current</span> <span class="o">=</span> <span class="nv">$current</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$c</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">(</span><span class="nv">$current</span> <span class="o">&amp;&amp;</span> <span class="nv">$current</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_remove</span><span class="p">(</span><span class="nv">$root</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$word</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$depth</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$root</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// If last character of key is being processed</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$depth</span> <span class="o">==</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$word</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// This node is no more end of word after removal of given key</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$root</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// If given is not prefix of any other word</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isEmpty</span><span class="p">(</span><span class="nv">$root</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$root</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nv">$root</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// If not last character, recur for the child</span>
        <span class="c1">// obtained using ASCII value</span>
        <span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$word</span><span class="p">[</span><span class="nv">$depth</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_remove</span><span class="p">(</span>
            <span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">[</span><span class="nv">$word</span><span class="p">[</span><span class="nv">$depth</span><span class="p">]],</span>
            <span class="nv">$word</span><span class="p">,</span>
            <span class="nv">$depth</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">);</span>

        <span class="c1">// If root does not have any child (its only child got</span>
        <span class="c1">// deleted), and it is not end of another word.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isEmpty</span><span class="p">(</span><span class="nv">$root</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$root</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$root</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$root</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">remove</span><span class="p">(</span><span class="nv">$word</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_remove</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span><span class="p">,</span> <span class="nv">$word</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="nv">$root</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span> <span class="k">as</span> <span class="nv">$child</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$child</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">display</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$words</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_display</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$words</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$words</span> <span class="k">as</span> <span class="nv">$word</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="nv">$word</span><span class="p">,</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_display</span><span class="p">(</span><span class="nv">$root</span><span class="p">,</span> <span class="nv">$prefix</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$words</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$old</span> <span class="o">=</span> <span class="nv">$prefix</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span> <span class="k">as</span> <span class="nv">$char</span> <span class="o">=&gt;</span> <span class="nv">$child</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$child</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$prefix</span> <span class="o">=</span> <span class="nv">$old</span> <span class="o">.</span> <span class="nv">$char</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$child</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$words</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$prefix</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_display</span><span class="p">(</span><span class="nv">$child</span><span class="p">,</span> <span class="nv">$prefix</span><span class="p">,</span> <span class="nv">$words</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">wordCount</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wordCount</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">root</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_wordCount</span><span class="p">(</span><span class="nv">$root</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">isEnfOfWord</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$result</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$root</span><span class="o">-&gt;</span><span class="na">children</span> <span class="k">as</span> <span class="nv">$char</span> <span class="o">=&gt;</span> <span class="nv">$child</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$result</span> <span class="o">+=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wordCount</span><span class="p">(</span><span class="nv">$child</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Input keys (use only 'a' through 'z' and lower case)</span>
        <span class="nv">$keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"the"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"there"</span><span class="p">,</span> <span class="s2">"answer"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">,</span> <span class="s2">"by"</span><span class="p">,</span> <span class="s2">"bye"</span><span class="p">,</span> <span class="s2">"their"</span><span class="p">];</span>
        <span class="nv">$output</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Not present in trie"</span><span class="p">,</span> <span class="s2">"Present in trie"</span><span class="p">];</span>

        <span class="nv">$trie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Trie</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$keys</span> <span class="k">as</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$trie</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$trie</span><span class="o">-&gt;</span><span class="na">remove</span><span class="p">(</span><span class="s1">'by'</span><span class="p">);</span>

        <span class="nv">$trie</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">();</span>
        <span class="k">echo</span> <span class="nv">$trie</span><span class="o">-&gt;</span><span class="na">wordCount</span><span class="p">(),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Trie</span><span class="o">::</span><span class="na">main</span><span class="p">();</span>

</code></pre></div></div>

<p>延伸</p>
<ul>
  <li>使用Trie实现一个字典
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class TrieNode
{
  // &lt;char, TrieNode&gt;
  public $children = [];
  public $isEnfOfWord = false;
  public $meaning = ''; // 字典的释义
}
</code></pre></div>    </div>
  </li>
  <li>词频统计
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class TrieNode
{
  // &lt;char, TrieNode&gt;
  public $children = [];
  public $isEnfOfWord = false;
  public $wordFreq = 0; // 词频统计
}
</code></pre></div>    </div>
  </li>
  <li>字典序排序</li>
  <li>前缀匹配</li>
  <li>最长公共前缀</li>
</ul>

<h2 id="参考">参考</h2>
<ul>
  <li>https://blog.csdn.net/hguisu/article/details/8131559</li>
</ul>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    May
    16th,
    
    2020
  </span>

  <h2>
    <a href="/hashtable/2020/05/16/hashtable.html">HashTable</a>
  </h2>

  <div>
    
    <p>HashTable是一种通过将键(key)映射为值(value)从而实现快速查找的数据结构。实现HashTable的方式有很多种。本次介绍2种，并给出第一种的PHP版本实现。</p>

<p>我们使用一个链表构成的数组与一个散列函数来实现散列表。当插入键（字符串或几乎其他所有数据类型）和值时，我们按照如下方法操作。</p>

<p>(1) 首先，计算键的散列值。键的散列值通常为int或者long型。请注意，不同的两个键可以有相同的散列值，因为键的数量是无穷的，而int型的总数是有限的。</p>

<p>(2) 之后，将散列值映射为数组的索引。可以使用类似于hash(key) % array_length的方式完成这一步骤，不同的两个散列值则会被映射到相同的数组索引。</p>

<p>(3) 此数组索引处存储的元素是一系列由键和值为元素组成的链表。请将映射到此索引的键和值存储在这里。由于存在冲突，我们必须使用链表：有可能对于相同的散列值有不同的键，也有可能不同的散列值被映射到了同一个索引。</p>

<p>通过键来获取值则需重复此过程。首先通过键计算散列值，再通过散列值计算索引。之后，查找链表来获取该键所对应的值。</p>

<p>如果冲突发生很多次，最坏情况下的时间复杂度是O(N)，其中N是键的数量。但是，我们通常假设一个不错的实现方式会将冲突数量保持在最低水平，在此情况下，时间复杂度是O(1)。</p>

<p>另一种方法是通过平衡二叉搜索树来实现散列表。该方法的查找时间是O(logN)。该方法的好处是用到的空间可能更少，因为我们不再需要分配一个大数组。还可以按照键的顺序进行迭代访问，在某些时候这样做很有用</p>

<p>我们实现一个PHP版的HashTable, 数据结构<code class="highlighter-rouge">Element</code>、<code class="highlighter-rouge">HashTable</code>,散列函数，我们使用<code class="highlighter-rouge">Times33*hash</code>。
功能：添加(覆盖)、删除、获取，内部隐藏逻辑<code class="highlighter-rouge">rehash</code>。
<code class="highlighter-rouge">rehash</code>两种情况，一种是扩容、一种是缩容。基于<code class="highlighter-rouge">isRehash</code>进行判断。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">Element</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$hash</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">value</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hash</span> <span class="o">=</span> <span class="nv">$hash</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">HashTable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$item</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">public</span> <span class="nv">$length</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$useElement</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">initHashTable</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span><span class="o">:?</span><span class="nx">string</span>
    <span class="p">{</span>
        <span class="nv">$e</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_has</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$e</span> <span class="nx">instanceof</span> <span class="nx">Element</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isRehash</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rehash</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nv">$hash</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="nv">$slot</span> <span class="o">=</span> <span class="nv">$hash</span> <span class="o">%</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">;</span>

        <span class="nv">$element</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_has</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span> <span class="nx">instanceof</span> <span class="nx">Element</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">value</span> <span class="o">!==</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$element</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">==</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$element</span><span class="o">-&gt;</span><span class="na">value</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
            <span class="nb">array_push</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">],</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">));</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">del</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span><span class="o">:?</span><span class="nx">bool</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_has</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="nx">instanceof</span> <span class="nx">Element</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_del</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_del</span><span class="p">(</span><span class="nx">Element</span> <span class="nv">$delElement</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$delElement</span><span class="o">-&gt;</span><span class="na">hash</span> <span class="o">%</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">)]</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">==</span> <span class="nv">$delElement</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">][</span><span class="nv">$k</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span><span class="o">--</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isRehash</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rehash</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">has</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_has</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="nx">instanceof</span> <span class="nx">Element</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_has</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span><span class="o">:?</span><span class="nx">Element</span>
    <span class="p">{</span>
        <span class="nv">$hash</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="nv">$slot</span> <span class="o">=</span> <span class="nv">$hash</span> <span class="o">%</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$element</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">==</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$element</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">hash</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$hash</span> <span class="o">=</span> <span class="mi">5381</span><span class="p">;</span>
            <span class="nv">$l</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$l</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$num</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$key</span><span class="p">[</span><span class="nv">$i</span><span class="p">]);</span>
                <span class="nv">$hash</span> <span class="o">+=</span> <span class="nv">$num</span> <span class="o">+</span> <span class="nv">$hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">+</span> <span class="nv">$hash</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nv">$hash</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">initHashTable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">isRehash</span><span class="p">()</span><span class="o">:</span><span class="nx">bool</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span> <span class="o">&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span>
            <span class="o">||</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="mi">2</span><span class="o">*</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rehash</span><span class="p">();</span>
            <span class="k">echo</span> <span class="s1">'rehash'</span><span class="p">,</span><span class="nx">PHP_EOL</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">rehash</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useElement</span> <span class="o">&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$newLength</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$newLength</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$newItem</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span> <span class="k">as</span> <span class="nv">$slot</span> <span class="o">=&gt;</span> <span class="nv">$items</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$slot</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="na">hash</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">))</span> <span class="o">%</span> <span class="nv">$newLength</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newItem</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="nv">$newItem</span><span class="p">[</span><span class="nv">$slot</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="p">}</span>
                <span class="nb">array_push</span><span class="p">(</span><span class="nv">$newItem</span><span class="p">[</span><span class="nv">$slot</span><span class="p">],</span> <span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">=</span> <span class="nv">$newLength</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span> <span class="o">=</span> <span class="nv">$newItem</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">debugHashTable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

        <span class="nv">$hashTable</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HashTable</span><span class="p">();</span>

        <span class="nv">$items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'key'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
            <span class="s1">'c'</span> <span class="o">=&gt;</span> <span class="s1">'12311'</span><span class="p">,</span>
            <span class="mi">122</span> <span class="o">=&gt;</span> <span class="s1">'1231'</span><span class="p">,</span>
            <span class="s1">'key1'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
            <span class="s1">'c1'</span> <span class="o">=&gt;</span> <span class="s1">'12311'</span><span class="p">,</span>
            <span class="mi">1221</span> <span class="o">=&gt;</span> <span class="s1">'1231'</span><span class="p">,</span>
            <span class="s1">'ke'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
            <span class="s1">'ky1'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
            <span class="s1">'ey1'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
            <span class="s1">'ky'</span> <span class="o">=&gt;</span> <span class="s1">'1212'</span><span class="p">,</span>
        <span class="p">];</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">store</span><span class="p">(</span><span class="nv">$k</span><span class="p">,</span> <span class="nv">$v</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="nv">$k</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$k</span><span class="p">),</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">echo</span> <span class="s1">'添加key后结果:'</span><span class="p">,</span><span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">debugHashTable</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">del</span><span class="p">(</span><span class="nv">$k</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$k</span> <span class="o">==</span> <span class="s1">'ey1'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">echo</span> <span class="s1">'删除key后，结果:'</span><span class="p">,</span><span class="nx">PHP_EOL</span><span class="p">;</span>
        <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">debugHashTable</span><span class="p">();</span>
        <span class="k">echo</span> <span class="nv">$hashTable</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">HashTable</span><span class="o">::</span><span class="na">main</span><span class="p">();</span>

</code></pre></div></div>

<p>判断一个哈希算法的好坏有以下几点:</p>
<ul>
  <li>一致性，等价的键必然产生相等的哈希值；</li>
  <li>高效性，计算简便；</li>
  <li>均匀性，均匀地对所有的键进行哈希。</li>
</ul>

<p>更多延伸阅读</p>
<ul>
  <li>php HashTable</li>
  <li>redis HashTable</li>
  <li>php vs redis rehash方式为什么不一样</li>
  <li>hash 函数实现方式：Times33(djb2), sdbm,lose</li>
</ul>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    March
    23rd,
    
    2020
  </span>

  <h2>
    <a href="/elasticsearch/2020/03/23/task-log-index-upgrade.html">优化task-log索引</a>
  </h2>

  <div>
    
    <h4 id="背景">背景</h4>

<p><img src="/assets/media/WX20200323-135441.png" alt="task log data" /></p>

<p>索引表数据过大，基于场景，分析该表就是统计任务写入状态使用,便于每天汇总报告.</p>

<h4 id="解决方案">解决方案</h4>

<p>利用Index Template 格式如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT _template/task_log
{
	"index_patterns": ["task-log-*"],
	"settings": {
		"number_of_shards": 3
	},
	"mappings": {
		"_source": {
			"enabled": false
		},
		"dynamic": false,
		"properties": {
			"id": {
				"type": "long"
			},
			"success": {
				"type": "boolean"
			},
			"createtime": {
				"type": "date",
				"format": "yyyy-MM-dd HH:mm:ss"
			}
		}
	},
	"aliases": {
	  "task-log": {}
	},
	"version": 2
}
</code></pre></div></div>

<p>按天创建索引,而且支持动态创建（task_log Template)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST task-log-20200325/_doc
{
  "id":1011221,
  "success":false,
  "createtime":"2020-12-12 13:12:12"
}
</code></pre></div></div>

<p>分析数据（每天的成功个数和失败个数)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET task-log/_search
{
  "size": 0,
  "aggs": {
    "avg_day": {
      "date_histogram": {
        "field": "createtime",
        "interval": "day"
      },
      "aggs": {
        "success": {
          "terms": {
            "field": "success",
            "size": 10
          }
        }
      }

    }
  }
}
</code></pre></div></div>

<p>结果:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "took" : 3,
  "timed_out" : false,
  "_shards" : {
    "total" : 2,
    "successful" : 2,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 7,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "avg_day" : {
      "buckets" : [
        {
          "key_as_string" : "2020-12-12 00:00:00",
          "key" : 1607731200000,
          "doc_count" : 7,
          "success" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : 1,
                "key_as_string" : "true",
                "doc_count" : 5
              },
              {
                "key" : 0,
                "key_as_string" : "false",
                "doc_count" : 2
              }
            ]
          }
        }
      ]
    }
  }
}
</code></pre></div></div>

<p>基本功能实现了，原来的<code class="highlighter-rouge">_source</code>数据不存在了，一条省个及字节，一天几亿条,那就节省不少空间。</p>

<h4 id="优化点">优化点</h4>

<ol>
  <li><code class="highlighter-rouge">_source enable false</code></li>
  <li><code class="highlighter-rouge">index template</code> 支持<code class="highlighter-rouge">version, alias, mapping</code></li>
  <li>移除副本配置，缩小不必要的数据空间</li>
  <li>一个存储日志的主分片理论值50G，三个主分片可容纳150G数据，基于现有每天的数据量按每条1KB，可容纳150亿条数据，足矣满足现在业务使用场景。</li>
</ol>

<h4 id="参考">参考</h4>

<p>https://blog.csdn.net/napoay/article/details/62233031</p>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    March
    17th,
    
    2020
  </span>

  <h2>
    <a href="/feynman/2020/03/17/learn-Feynman.html">学习费曼学习法</a>
  </h2>

  <div>
    
    <p><img src="/assets/media/费曼学习法.png" alt="费曼学习法" /></p>


    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    March
    1st,
    
    2020
  </span>

  <h2>
    <a href="/swoole/2020/03/01/learn-swoole.html">学习Swoole</a>
  </h2>

  <div>
    
    <h3 id="学习swoole需要掌握哪些基础知识">学习Swoole需要掌握哪些基础知识</h3>

<h4 id="多进程多线程">多进程/多线程</h4>

<ul>
  <li>了解Linux操作系统进程和线程的概念</li>
  <li>了解Linux进程/线程切换调度的基本知识</li>
  <li>了解进程间通信的基本知识，如管道、UnixSocket、消息队列、共享内存</li>
</ul>

<h4 id="socket">SOCKET</h4>

<ul>
  <li>了解SOCKET的基本操作如accept/connect、send/recv、close、listen、bind</li>
  <li>了解SOCKET的接收缓存区、发送缓存区、阻塞/非阻塞、超时等概念</li>
</ul>

<h4 id="io复用">IO复用</h4>

<ul>
  <li>了解select/poll/epoll</li>
  <li>了解基于select/epoll实现的事件循环，Reactor模型</li>
  <li>了解可读事件、可写事件</li>
</ul>

<h4 id="tcpip网络协议">TCP/IP网络协议</h4>

<ul>
  <li>了解TCP/IP协议</li>
  <li>了解TCP、UDP传输协议</li>
</ul>

<h4 id="调试工具">调试工具</h4>

<ul>
  <li>使用 gdb 调试Linux程序</li>
  <li>使用 strace 跟踪进程的系统调用</li>
  <li>使用 tcpdump 跟踪网络通信过程</li>
  <li>其他Linux系统工具，如ps、lsof、top、vmstat、netstat、sar、ss等</li>
</ul>

<p>概括一句话读《linux高性能服务器编程》</p>

<h3 id="swoole-图">Swoole 图</h3>

<h4 id="类图">类图</h4>

<p><img src="/assets/media/WX20200301-072210@2x.png" alt="swoole class" /></p>

<h4 id="运行流程图">运行流程图</h4>

<p><img src="https://wiki.swoole.com/_images/server/running_process.jpg" alt="运行流程图" /></p>

<h4 id="进程--线程结构图">进程 / 线程结构图</h4>

<p><img src="https://wiki.swoole.com/_images/server/process_structure.jpg" alt="进程 / 线程结构图" /></p>

<p><img src="https://wiki.swoole.com/_images/server/process_structure_2.png" alt="结构图2" /></p>

<h3 id="实践代码">实践代码</h3>

<p>可以用代码中作”基酒” -&gt; <a href="https://github.com/superman2014/sf-swoole-console">sf-swoole-console</a></p>

<p>Docker运行环境：<a href="https://hub.docker.com/r/phpswoole/swoole">https://hub.docker.com/r/phpswoole/swoole</a></p>

<p>简单写了一个mapreduce 的add 加法:<a href="https://github.com/superman2014/sf-swoole-console/tree/feature-op-add">feature-op-add</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -p 9501:9501 -it -v $(pwd):/var/html phpswoole/swoole  /bin/bash
cd /var/html
php console task:server start
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ telnet 127.0.0.1 9501
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
{"op":"add", "data":[1,2]}
3
</code></pre></div></div>

<h3 id="自定义协议">自定义协议</h3>

<h4 id="eof结束符">EOF结束符</h4>

<p>发送者和接收者约定数据包已一个特殊的结束符(EOF)做结尾。适合协议相对简单的需求，常见的比如 redis、memcache、ftp、stmp等都是用\r\n换行符作为结束符。</p>

<h3 id="固定包头包体协议">固定包头+包体协议</h3>

<p><img src="https://opso.coding.me/images/swoole_pack.png" alt="固定包头+包体协议" /></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// server.php</span>
<span class="nv">$serv</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Swoole\Server</span><span class="p">(</span><span class="s2">"127.0.0.1"</span><span class="p">,</span> <span class="mi">9501</span><span class="p">);</span>
<span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">'open_length_check'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s1">'package_length_type'</span> <span class="o">=&gt;</span> <span class="s1">'n'</span><span class="p">,</span>
    <span class="s1">'package_length_offset'</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s1">'package_body_offset'</span> <span class="o">=&gt;</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">'package_max_length'</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">,</span>
<span class="p">));</span>
<span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Connect'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$serv</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Client: Connect.</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">});</span>
<span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Receive'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$serv</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">,</span> <span class="nv">$from_id</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$header</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="nv">$p</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s1">'a6begin/nbodyLen'</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$p</span><span class="p">[</span><span class="s1">'begin'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'SWOOLE'</span><span class="p">){</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nv">$len</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'bodyLen'</span><span class="p">];</span>
	<span class="nv">$bodyPack</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s2">"a</span><span class="si">{</span><span class="nv">$len</span><span class="si">}</span><span class="s2">body"</span><span class="p">,</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nv">$len</span><span class="p">));</span>
    <span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span> <span class="s2">"Server: "</span><span class="o">.</span><span class="nv">$bodyPack</span><span class="p">[</span><span class="s1">'body'</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="p">});</span>
<span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Close'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$serv</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Client: Close.</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">});</span>
<span class="nv">$serv</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">//client.php</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">swoole_client</span><span class="p">(</span><span class="nx">SWOOLE_SOCK_TCP</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">'127.0.0.1'</span><span class="p">,</span> <span class="mi">9501</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">exit</span><span class="p">(</span><span class="s2">"connect failed. Error: </span><span class="si">{</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">errCode</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$msg</span> <span class="o">=</span> <span class="s1">'Hello World!'</span><span class="p">;</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nv">$msg</span><span class="p">));</span> <span class="c1">// 正常发包</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nv">$msg</span><span class="o">.</span><span class="s1">'0'</span><span class="p">)</span><span class="o">.</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nv">$msg</span><span class="o">.</span><span class="s1">'1'</span><span class="p">)</span><span class="o">.</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nv">$msg</span><span class="o">.</span><span class="s1">'2'</span><span class="p">));</span><span class="c1">// 模拟粘包</span>
<span class="k">echo</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">recv</span><span class="p">();</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
<span class="k">function</span> <span class="nf">sendMsg</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$p</span> <span class="o">=</span> <span class="s1">'SWOOLE'</span><span class="p">;</span>
	<span class="nv">$p</span> <span class="o">.=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">'n'</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">));</span>
	<span class="nv">$p</span> <span class="o">.=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">'a'</span> <span class="o">.</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">),</span> <span class="nv">$msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">$p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>抓包数据分析</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>13:36:39.050774 IP 127.0.0.1.33844 &gt; 127.0.0.1.9501: Flags [P.], seq 1:21, ack 1, win 342, options [nop,nop,TS val 4907685 ecr 4907685], length 20
        0x0000:  0000 0000 0000 0000 0000 0000 0800 4500  ..............E.
        0x0010:  0048 a56a 4000 4006 9743 7f00 0001 7f00  .H.j@.@..C......
        0x0020:  0001 8434 251d 496d 47ce 8446 849b 8018  ...4%.ImG..F....
        0x0030:  0156 fe3c 0000 0101 080a 004a e2a5 004a  .V.&lt;.......J...J
        0x0040:  e2a5 5357 4f4f 4c45 000c 4865 6c6c 6f20  ..SWOOLE..Hello.
        0x0050:  576f 726c 6421                           World!
13:36:39.050820 IP 127.0.0.1.9501 &gt; 127.0.0.1.33844: Flags [.], ack 21, win 342, options [nop,nop,TS val 4907685 ecr 4907685], length 0
        0x0000:  0000 0000 0000 0000 0000 0000 0800 4500  ..............E.
        0x0010:  0034 663e 4000 4006 d683 7f00 0001 7f00  .4f&gt;@.@.........
        0x0020:  0001 251d 8434 8446 849b 496d 47e2 8010  ..%..4.F..ImG...
        0x0030:  0156 fe28 0000 0101 080a 004a e2a5 004a  .V.(.......J...J
        0x0040:  e2a5                                     ..
13:36:39.050862 IP 127.0.0.1.33844 &gt; 127.0.0.1.9501: Flags [P.], seq 21:84, ack 1, win 342, options [nop,nop,TS val 4907685 ecr 4907685], length 63
        0x0000:  0000 0000 0000 0000 0000 0000 0800 4500  ..............E.
        0x0010:  0073 a56b 4000 4006 9717 7f00 0001 7f00  .s.k@.@.........
        0x0020:  0001 8434 251d 496d 47e2 8446 849b 8018  ...4%.ImG..F....
        0x0030:  0156 fe67 0000 0101 080a 004a e2a5 004a  .V.g.......J...J
        0x0040:  e2a5 5357 4f4f 4c45 000d 4865 6c6c 6f20  ..SWOOLE..Hello.   //这里
        0x0050:  576f 726c 6421 3053 574f 4f4c 4500 0d48  World!0SWOOLE..H
        0x0060:  656c 6c6f 2057 6f72 6c64 2131 5357 4f4f  ello.World!1SWOO
        0x0070:  4c45 000d 4865 6c6c 6f20 576f 726c 6421  LE..Hello.World!
        0x0080:  32                                       2
13:36:39.050885 IP 127.0.0.1.9501 &gt; 127.0.0.1.33844: Flags [.], ack 84, win 342, options [nop,nop,TS val 4907685 ecr 4907685], length 0
        0x0000:  0000 0000 0000 0000 0000 0000 0800 4500  ..............E.
        0x0010:  0034 663f 4000 4006 d682 7f00 0001 7f00  .4f?@.@.........
        0x0020:  0001 251d 8434 8446 849b 496d 4821 8010  ..%..4.F..ImH!..
        0x0030:  0156 fe28 0000 0101 080a 004a e2a5 004a  .V.(.......J...J
        0x0040:  e2a5                                     ..
13:36:39.051626 IP 127.0.0.1.9501 &gt; 127.0.0.1.33844: Flags [P.], seq 1:22, ack 84, win 342, options [nop,nop,TS val 4907685 ecr 4907685], length 21
        0x0000:  0000 0000 0000 0000 0000 0000 0800 4500  ..............E.
        0x0010:  0049 6640 4000 4006 d66c 7f00 0001 7f00  .If@@.@..l......
        0x0020:  0001 251d 8434 8446 849b 496d 4821 8018  ..%..4.F..ImH!..
        0x0030:  0156 fe3d 0000 0101 080a 004a e2a5 004a  .V.=.......J...J
        0x0040:  e2a5 5365 7276 6572 3a20 4865 6c6c 6f20  ..Server:.Hello. // 这里
        0x0050:  576f 726c 6421 0a                        World!.


</code></pre></div></div>

<p>再来一个漂亮版本的代码</p>

<p>RPC 编码协议类</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Superman2014\SfSwooleConsole</span><span class="p">;</span>

<span class="cd">/**
 * Class Protocol
 * @package Superman2014\SfSwooleConsole
 *
 *
 * 包结构
 *
 * 字段	字节数	说明
 * 包头	定长	每一个通信消息必须包含的内容
 * 包体	不定长	根据每个通信消息的不同产生变化
 *
 * 其中包头详细内容如下：
 *
 * 字段        字节数 类型  说明
 * pkg_len	    2   ushort	整个包的长度，不超过4K
 * version	    1 	uchar	通讯协议版本号
 * command_id	2 	ushort	消息命令ID
 * result	    2 	short	请求时不起作用；请求返回时使用
 *
 */</span>
<span class="kd">class</span> <span class="nc">Protocol</span>
<span class="p">{</span>

    <span class="k">const</span> <span class="no">VERSION</span> <span class="o">=</span> <span class="s1">'1'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">HEADER</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">PACKAGE_LENGTH</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">partHeader</span><span class="p">(</span><span class="nv">$bodyLen</span><span class="p">,</span> <span class="nv">$version</span><span class="p">,</span> <span class="nv">$commandId</span><span class="p">,</span> <span class="nv">$result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">pack</span><span class="p">(</span><span class="s2">"nCns"</span><span class="p">,</span> <span class="nv">$bodyLen</span><span class="p">,</span> <span class="nv">$version</span><span class="p">,</span> <span class="nv">$commandId</span><span class="p">,</span> <span class="nv">$result</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">partBody</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">pack</span><span class="p">(</span><span class="s2">"a"</span><span class="o">.</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">),</span> <span class="nv">$msg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">encode</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="nv">$commandId</span><span class="p">,</span> <span class="nv">$result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">partHeader</span><span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">),</span> <span class="nx">self</span><span class="o">::</span><span class="na">VERSION</span><span class="p">,</span> <span class="nv">$commandId</span><span class="p">,</span> <span class="nv">$result</span><span class="p">)</span>
            <span class="o">.</span> <span class="nx">self</span><span class="o">::</span><span class="na">partBody</span><span class="p">(</span><span class="nv">$msg</span><span class="p">);</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">decode</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">HEADER</span><span class="p">);</span>
        <span class="nv">$p</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s1">'nbodyLen/Cversion/ncommandId/sresult'</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
        <span class="nv">$len</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'bodyLen'</span><span class="p">];</span>
        <span class="nv">$bodyPack</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s2">"a</span><span class="si">{</span><span class="nv">$len</span><span class="si">}</span><span class="s2">body"</span><span class="p">,</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">HEADER</span><span class="p">,</span> <span class="nv">$len</span><span class="p">));</span>
        <span class="k">return</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$bodyPack</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">,</span> <span class="s2">"1001"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="nb">var_dump</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">decode</span><span class="p">(</span><span class="nv">$msg</span><span class="p">));</span>

        <span class="c1">//</span>
<span class="c1">//        array(5) {</span>
<span class="c1">//        ["body"]=&gt;</span>
<span class="c1">//  string(5) "hello"</span>
<span class="c1">//        ["bodyLen"]=&gt;</span>
<span class="c1">//  int(5)</span>
<span class="c1">//  ["version"]=&gt;</span>
<span class="c1">//  int(1)</span>
<span class="c1">//  ["commandId"]=&gt;</span>
<span class="c1">//  int(1001)</span>
<span class="c1">//  ["result"]=&gt;</span>
<span class="c1">//  int(0)</span>
<span class="c1">//    }</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Protocol::main();</span>
</code></pre></div></div>

<p>常量类</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Superman2014\SfSwooleConsole</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TaskConstant</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">COMMAND_SET</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">START</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">STOP</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">RESTART</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">RELOAD</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">PING</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">STATUS</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">USAGE</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">const</span> <span class="no">USER_COMMAND</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">STATUS</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">RELOAD</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">RESTART</span><span class="p">,</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">STOP</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">const</span> <span class="no">START</span> <span class="o">=</span> <span class="s1">'start'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">STOP</span> <span class="o">=</span> <span class="s1">'stop'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">STATUS</span> <span class="o">=</span> <span class="s1">'status'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">RELOAD</span> <span class="o">=</span> <span class="s1">'reload'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">RESTART</span> <span class="o">=</span> <span class="s1">'restart'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">PING</span> <span class="o">=</span> <span class="s1">'ping'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">USAGE</span> <span class="o">=</span> <span class="s1">'usage'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">DATA</span> <span class="o">=</span> <span class="s1">'data'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">COMMAND_ID_LIST</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mi">1001</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">START</span><span class="p">,</span>
        <span class="mi">1002</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">STOP</span><span class="p">,</span>
        <span class="mi">1003</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">RESTART</span><span class="p">,</span>
        <span class="mi">1004</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">RELOAD</span><span class="p">,</span>
        <span class="mi">1005</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">PING</span><span class="p">,</span>
        <span class="mi">1006</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">STATUS</span><span class="p">,</span>
        <span class="mi">1007</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">DATA</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">commandIdByName</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
       <span class="k">return</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">COMMAND_ID_LIST</span><span class="p">)[</span><span class="nv">$name</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Superman2014\SfSwooleConsole</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">Swoole\Server</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Swoole\Process</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Swoole\Client</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Swoole\Timer</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TaskServer</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">NAME</span> <span class="o">=</span> <span class="s1">'sf-swoole-console'</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$config</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'worker_num'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s1">'task_worker_num'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s1">'daemonize'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
        <span class="s1">'backlog'</span> <span class="o">=&gt;</span> <span class="mi">128</span><span class="p">,</span>
        <span class="s1">'log_file'</span> <span class="o">=&gt;</span> <span class="s1">'/tmp/swoole.log'</span><span class="p">,</span>
        <span class="s1">'log_level'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'task_ipc_mode'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s1">'heartbeat_check_interval'</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">'heartbeat_idle_time'</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">'pid_file'</span> <span class="o">=&gt;</span> <span class="s1">'/tmp/sf-swoole-console.pid'</span><span class="p">,</span>

        <span class="s1">'open_length_check'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
        <span class="s1">'package_length_type'</span> <span class="o">=&gt;</span> <span class="s1">'n'</span><span class="p">,</span>
        <span class="s1">'package_length_offset'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'package_body_offset'</span> <span class="o">=&gt;</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">HEADER</span><span class="p">,</span>
        <span class="s1">'package_max_length'</span> <span class="o">=&gt;</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">PACKAGE_LENGTH</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">const</span> <span class="no">LISTEN_HOST</span> <span class="o">=</span> <span class="s1">'0.0.0.0'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">MANAGE_HOST</span> <span class="o">=</span> <span class="s1">'127.0.0.1'</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">9501</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$command</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">START</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STOP</span><span class="o">:</span>
                 <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientSendCommand</span><span class="p">()(</span><span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STOP</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STATUS</span><span class="o">:</span>
                <span class="nv">$recv</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientSendCommand</span><span class="p">()(</span><span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STATUS</span><span class="p">);</span>
                <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$recv</span><span class="p">[</span><span class="s1">'body'</span><span class="p">]);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">PING</span><span class="o">:</span>
                <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientSendCommand</span><span class="p">()(</span><span class="nx">TaskConstant</span><span class="o">::</span><span class="na">PING</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RELOAD</span><span class="o">:</span>
                <span class="nv">$recv</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientSendCommand</span><span class="p">()(</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RELOAD</span><span class="p">);</span>
                <span class="k">echo</span> <span class="nv">$recv</span><span class="p">[</span><span class="s1">'body'</span><span class="p">],</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RESTART</span><span class="o">:</span>
                <span class="nv">$recv</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientSendCommand</span><span class="p">()(</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RESTART</span><span class="p">);</span>
                <span class="k">echo</span> <span class="nv">$recv</span><span class="p">[</span><span class="s1">'body'</span><span class="p">],</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">clientSendCommand</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$command</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">(</span><span class="nx">SWOOLE_SOCK_TCP</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">MANAGE_HOST</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">PORT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">exit</span><span class="p">(</span><span class="s2">"connect failed. Error: </span><span class="si">{</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">errCode</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$command</span><span class="p">,</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">COMMAND_SET</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nx">Protocol</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$command</span><span class="p">,</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">commandIdByName</span><span class="p">(</span><span class="nv">$command</span><span class="p">)));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nx">Protocol</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$command</span><span class="p">,</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">commandIdByName</span><span class="p">(</span><span class="nx">TaskConstant</span><span class="o">::</span><span class="na">DATA</span><span class="p">)));</span>
            <span class="p">}</span>

            <span class="nv">$recv</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">recv</span><span class="p">();</span>
            <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">decode</span><span class="p">(</span><span class="nv">$recv</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">LISTEN_HOST</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">PORT</span><span class="p">,</span> <span class="nx">SWOOLE_BASE</span><span class="p">,</span> <span class="nx">SWOOLE_SOCK_TCP</span><span class="p">);</span>

        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">);</span>

        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Connect'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onConnect'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Close'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onClose'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Task'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onTask'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Finish'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onFinish'</span><span class="p">]);</span>
<span class="c1">//        $server-&gt;on('Start', [$this, 'onStart']); // SWOOLE_BASE 不存在</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'WorkerStart'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onWorkerStart'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'WorkerStop'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onWorkerStop'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'ManagerStart'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onManagerStart'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Shutdown'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onShutdown'</span><span class="p">]);</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'WorkerExit'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'onWorkerExit'</span><span class="p">]);</span>

        <span class="cd">/**
         * 用户进程实现了广播功能，循环接收unixSocket的消息，并发给服务器的所有连接
         */</span>
        <span class="nv">$process</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Process</span><span class="p">(</span>
            <span class="k">function</span> <span class="p">(</span><span class="nv">$process</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$server</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$socket</span> <span class="o">=</span> <span class="nv">$process</span><span class="o">-&gt;</span><span class="na">exportSocket</span><span class="p">();</span>
                <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">recv</span><span class="p">();</span>

                    <span class="nv">$command</span> <span class="o">=</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">COMMAND_ID_LIST</span><span class="p">[</span><span class="nv">$msg</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$command</span> <span class="o">==</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STATUS</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">stats</span><span class="p">()));</span>
                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$command</span> <span class="o">==</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RELOAD</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">reload</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                        <span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s1">'reload ok'</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$command</span> <span class="o">==</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">RESTART</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">Process</span><span class="o">::</span><span class="na">kill</span><span class="p">(</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">manager_pid</span><span class="p">,</span> <span class="nx">SIGUSR1</span><span class="p">);</span>
                        <span class="nx">Process</span><span class="o">::</span><span class="na">kill</span><span class="p">(</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">manager_pid</span><span class="p">,</span> <span class="nx">SIGUSR2</span><span class="p">);</span>
                        <span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s1">'restart ok'</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$command</span> <span class="o">==</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">STOP</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">shutdown</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="kc">false</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">1</span>
        <span class="p">);</span>

        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">addProcess</span><span class="p">(</span><span class="nv">$process</span><span class="p">);</span>

        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'Receive'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$server</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">,</span> <span class="nv">$reactorId</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$process</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$c</span> <span class="o">=</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">COMMAND_ID_LIST</span><span class="p">[</span><span class="nv">$msg</span><span class="p">[</span><span class="s1">'commandId'</span><span class="p">]],</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">USER_COMMAND</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$socket</span> <span class="o">=</span> <span class="nv">$process</span><span class="o">-&gt;</span><span class="na">exportSocket</span><span class="p">();</span>
                <span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$msg</span><span class="p">[</span><span class="s1">'commandId'</span><span class="p">]);</span>
                <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$socket</span><span class="o">-&gt;</span><span class="na">recv</span><span class="p">(),</span> <span class="nx">TaskConstant</span><span class="o">::</span><span class="na">commandIdByName</span><span class="p">(</span><span class="nx">TaskConstant</span><span class="o">::</span><span class="na">DATA</span><span class="p">)));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">onReceive</span><span class="p">(</span><span class="nv">$server</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">,</span> <span class="nv">$reactorId</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//此回调函数在worker进程中执行</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onReceive</span><span class="p">(</span><span class="nx">Server</span> <span class="nv">$server</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$fd</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$reactorId</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span> <span class="nx">Protocol</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'body'</span><span class="p">],</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'commandId'</span><span class="p">]));</span>
    <span class="p">}</span>

	<span class="c1">// ....</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Server</code> 的基本基本命令<code class="highlighter-rouge">stop</code> <code class="highlighter-rouge">restart</code> <code class="highlighter-rouge">ping</code> <code class="highlighter-rouge">stop</code> 就是使用协议里面定义的commandId。 后续还会这里进行深入研究。</p>

<p>跟编解码类似的如编程中序列化，反序列化. 可以看看这边文档 <a href="https://www.infoq.cn/article/serialization-and-deserialization">序列化和反序列化</a>。</p>

<h2 id="参考">参考</h2>

<ul>
  <li><a href="https://toxmc.github.io/swoole-cs.github.io/">Swoole 4.x LTS 速查表</a></li>
  <li><a href="https://wiki.swoole.com/#/server/init">服务端异步风格</a></li>
  <li><a href="https://opso.coding.me/post/swoole-tcp-pack/">通过swoole理解TCP粘包</a></li>
  <li><a href="https://www.ruanyifeng.com/blog/2016/11/byte-order.html">理解字节序</a></li>
  <li><a href="https://my.oschina.net/goal/blog/195749">PHP: 深入pack/unpack</a></li>
  <li><a href="https://www.infoq.cn/article/serialization-and-deserialization">序列化和反序列化</a></li>
  <li><a href="https://github.com/superman2014/sf-swoole-console/tree/feature-self-protocol">自定义swoole协议demo</a></li>
  <li><a href="https://github.com/msgpack-rpc/msgpack-rpc">msgpack rpc</a></li>
</ul>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    February
    25th,
    
    2020
  </span>

  <h2>
    <a href="/tcpdump/2020/02/25/learn-tcp-ip-protocol.html">学习TCP/IP 协议</a>
  </h2>

  <div>
    
    <h2 id="tcpip-协议栈-是什么"><code class="highlighter-rouge">TCP/IP</code> 协议（栈） 是什么</h2>

<p>TCP/IP（Transmission Control Protocol/Internet Protocol，传输控制协议/网际协议）是指能够在多个不同网络间实现信息传输的协议簇。TCP/IP协议不仅仅指的是TCP 和IP两个协议，而是指一个由FTP、SMTP、TCP、UDP、IP等协议构成的协议簇， 只是因为在TCP/IP协议中TCP协议和IP协议最具代表性，所以被称为TCP/IP协议。</p>

<h3 id="计算机网络体系结构分层">计算机网络体系结构分层</h3>
<p>TCP/IP协议在一定程度上参考了OSI的体系结构。OSI模型共有七层，从下到上分别是物理层、数据链路层、网络层、运输层、会话层、表示层和应用层。但是这显然是有些复杂的，所以在TCP/IP协议中，它们被简化为了四个层次。</p>

<p><img src="/assets/media/690219fae5b0587fa26e2dee545e6200" alt="计算机网络体系结构分层" /></p>

<p>OSI 七层模型目前只是一个模型，目前实际网络应用的是TCP/IP 四层模型。</p>

<h3 id="缺陷">缺陷</h3>

<p>像OSI模型一样，TCP/IP模型和协议也有自己的问题。</p>
<ul>
  <li>（1）该模型没有明显地区分服务、接口和协议的概念。因此，对于使用新技术来设计新网络，TCP/IP模型不是一个太好的模板。</li>
  <li>（2）TCP/IP模型完全不是通用的，并且不适合描述除TCP/IP模型之外的任何协议栈。</li>
  <li>（3）链路层并不是通常意义上的一层。它是一个接口，处于网络层和数据链路层之间。接口和层间的区别是很重要的。</li>
  <li>（4）TCP/IP模型不区分物理层和数据链路层。这两层完全不同，物理层必须处理铜缆、光纤和无线通信的传输特征；而数据链路层的工作是确定帧的开始和结束，并且按照所需的可靠程度把帧从一端发送到另一端。</li>
</ul>

<h3 id="两台计算机通过tcpip协议通讯的过程如下所示">两台计算机通过TCP/IP协议通讯的过程如下所示</h3>

<p><img src="/assets/media/tcpip.transferlan.png" alt="tcpip" /></p>

<h3 id="tcpip数据包的封装">TCP/IP数据包的封装</h3>

<p>不同的协议层对数据包有不同的称谓，在传输层叫做段（segment），在网络层叫做数据报（datagram），在链路层叫做帧（frame）。数据封装成帧后发到传输介质上，到达目的主机后每层协议再剥掉相应的首部，最后将应用层数据交给应用程序处理。</p>

<p><img src="/assets/media/tcpip.datagram.png" alt="tcpip.datagram.png" /></p>

<h4 id="以太网-格式">以太网 格式</h4>

<p><img src="/assets/media/tcpip.ethernetformat.png" alt="tcpip.ethernetformat.png" /></p>

<h4 id="arp格式">ARP格式</h4>

<p><img src="/assets/media/2016-04-12_570cbf887a6d7.png" alt="2016-04-12_570cbf887a6d7.png" /></p>

<h4 id="ip-格式">IP 格式</h4>

<p><img src="/assets/media/tcpip.ipformat.png" alt="ipformat" /></p>

<h4 id="tcp-格式">TCP 格式</h4>

<p><img src="/assets/media/tcpip.tcpformat.png" alt="tcpformat" /></p>

<h5 id="tcp-可选项">TCP 可选项</h5>
<p><img src="/assets/media/3611655386-5b097d85e838f_articlex.jpeg" alt="other choose item" /></p>

<h5 id="tcp状态流转图">TCP状态流转图</h5>

<p><img src="/assets/media/79702-b5828684905e8dc1.webp" alt="TCP" /></p>

<p>各种状态表示的意思</p>

<ul>
  <li>CLOSED：表示初始状态</li>
  <li>LISTEN：表示服务器端的某个 socket 处于监听状态，可以接受连接</li>
  <li>SYN_SENT：在服务端监听后，客户端 socket 执行 CONNECT 连接时，客户端发送 SYN 报文，此时客户端就进入 SYN_SENT 状态，等待服务端确认。</li>
  <li>SYN_RCVD：表示服务端接收到了 SYN 报文。</li>
  <li>ESTABLISHED：表示连接已经建立了。</li>
  <li>FIN_WAIT_1：其中一方请求终止连接，等待对方的 FIN 报文。</li>
  <li>FIN_WAIT_2：在 FIN_WAIT_2 之后， 当对方回应 ACK 报文之后，进入该状态。</li>
  <li>TIME_WAIT：表示收到了对方的 FIN 报文，并发送出了 ACK 报文，就等 2MSL 之后即可回到 CLOSED 状态。</li>
  <li>CLOSING：一种罕见状态，发生在发送 FIN 报文之后，本应是先收到 ACK 报文，却先收到对方的 FIN 报文，那么就从 FIN_WAIT_1 的状态进入 CLOSING 状态。</li>
  <li>CLOSE_WAIT：表示等待关闭，在 ESTABLISHED 过渡到 LAST_ACK 的一个过渡阶段，该阶段需要考虑是否还有数据发送给对方，如果没有，就可以关闭连接，发送 FIN 报文，然后进入 LAST_ACK 状态。</li>
  <li>LAST_ACK：被动关闭一方发送 FIN 报文之后，最后等待对方的 ACK 报文所处的状态。</li>
  <li>CLOSED：当收到 ACK 保温后，就可以进入 CLOSED 状态了。</li>
</ul>

<h5 id="tcp时序图">TCP时序图</h5>

<p>在这个例子中，首先客户端主动发起连接、发送请求，然后服务器端响应请求，然后客户端主动关闭连接。两条竖线表示通讯的两端，从上到下表示时间的先后顺序，注意，数据从一端传到网络的另一端也需要时间，所以图中的箭头都是斜的。双方发送的段按时间顺序编号为1-10，各段中的主要信息在箭头上标出，例如段2的箭头上标着SYN, 8000(0), ACK 1001, &lt;mss 1024&gt;，表示该段中的SYN位置1，32位序号是8000，该段不携带有效载荷（数据字节数为0），ACK位置1，32位确认序号是1001，带有一个mss选项值为1024。</p>

<p>建立连接的过程：</p>

<p>客户端发出段1，SYN位表示连接请求。序号是1000，这个序号在网络通讯中用作临时的地址，每发一个数据字节，这个序号要加1，这样在接收端可以根据序号排出数据包的正确顺序，也可以发现丢包的情况，另外，规定SYN位和FIN位也要占一个序号，这次虽然没发数据，但是由于发了SYN位，因此下次再发送应该用序号1001。mss表示最大段尺寸，如果一个段太大，封装成帧后超过了链路层的最大帧长度，就必须在IP层分片，为了避免这种情况，客户端声明自己的最大段尺寸，建议服务器端发来的段不要超过这个长度。</p>

<p>服务器发出段2，也带有SYN位，同时置ACK位表示确认，确认序号是1001，表示“我接收到序号1000及其以前所有的段，请你下次发送序号为1001的段”，也就是应答了客户端的连接请求，同时也给客户端发出一个连接请求，同时声明最大尺寸为1024。</p>

<p>客户端发出段3，对服务器的连接请求进行应答，确认序号是8001。</p>

<p>在这个过程中，客户端和服务器分别给对方发了连接请求，也应答了对方的连接请求，其中服务器的请求和应答在一个段中发出，因此一共有三个段用于建立连接，称为’‘三方握手（three-way-handshake）’‘。在建立连接的同时，双方协商了一些信息，例如双方发送序号的初始值、最大段尺寸等。</p>

<p><img src="/assets/media/tcpip.tcpconnection.png" alt="tcpip.tcpconnection.png" /></p>

<h3 id="udp-格式">UDP 格式</h3>

<p><img src="/assets/media/tcpip.udpformat.png" alt="udpformat" /></p>

<h3 id="跨路由器通讯过程">跨路由器通讯过程</h3>

<p><img src="assets/media/tcpip.transferovernet.png" alt="transferovernet" /></p>

<h3 id="multiplexing过程">Multiplexing过程</h3>

<p>注意，虽然IP、ARP和RARP数据报都需要以太网驱动程序来封装成帧，但是从功能上划分，ARP和RARP属于链路层，IP属于网络层。虽然ICMP、IGMP、TCP、UDP的数据都需要IP协议来封装成数据报，但是从功能上划分，ICMP、IGMP与IP同属于网络层，TCP和UDP属于传输层。</p>

<p><img src="assets/media/tcpip.multiplex.png" alt="multiplexing" /></p>

<h2 id="为什么学习-tcpip-协议">为什么学习 <code class="highlighter-rouge">TCP/IP</code> 协议</h2>

<p>很多公司招聘JD上，写着网络编程经验，说明实际工作中还是有很大的应用市场(应用:微信、QQ, 领域:IM、车联网、服务治理)。学会了它，可以非常轻松了解，浏览器输入URL Enter背后发生了什么。有了这个基础可以更好的学习Socket编程等等等。</p>

<p><img src="/assets/media/WX20200225-180648@2x.png" alt="腾讯JD" /></p>

<h2 id="如何学习-tcpip">如何学习 <code class="highlighter-rouge">TCP/IP</code></h2>

<h3 id="redis">Redis</h3>
<p>我们利用<code class="highlighter-rouge">tcpdump</code>工具抓包来分析实际网络请求数据。</p>

<p>本地安装<code class="highlighter-rouge">Redis</code></p>

<p>step 0: 查看本地的网卡list</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tcpdump -D
1.en0 [Up, Running]
2.p2p0 [Up, Running]
3.awdl0 [Up, Running]
4.llw0 [Up, Running]
5.utun0 [Up, Running]
6.utun1 [Up, Running]
7.utun2 [Up, Running]
8.utun3 [Up, Running]
9.utun4 [Up, Running]
10.lo0 [Up, Running, Loopback]
11.bridge0 [Up, Running]
12.en1 [Up, Running]
13.en2 [Up, Running]
14.gif0 [none]
15.stf0 [none]
</code></pre></div></div>

<p>step 1: 开启抓包工具，命令</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tcpdump -w /tmp/logs -i lo0 port 6379 -s0

</code></pre></div></div>

<p>-i lo0 抓取回路网口</p>

<p>port 监听redis的端口</p>

<p>-s0 防止包截断</p>

<p>step 2: 开启<code class="highlighter-rouge">Redis-cli</code> 发送<code class="highlighter-rouge">ping</code>命令</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ redis-cli
127.0.0.1:6379&gt; ping
PONG
127.0.0.1:6379&gt;

</code></pre></div></div>

<p>step 3: 停止抓包，用Vim打开</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tcpdump -r /tmp/logs -n -nn -A -x| vim -

</code></pre></div></div>

<p>-x 以16进制形式展示，便于后面分析</p>

<p>首先分析一下我们的ping命令</p>

<p>报文数据中的 [、]、{ 和 } 是为了方便区分数据，我自己加上的。[]包围的部分为本报文中的 IP 头，{}包围的部分为本报文中的 TCP 头。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    09:18:06.471045 IP 127.0.0.1.50510 &gt; 127.0.0.1.6379: Flags [P.], seq 18:32, ack 11469, win 6200, options [nop,nop,TS val 192620081 ecr 192618164], length 14: RESP "ping" //请求的数据
        0x0000:  [4500 0042 0000 4000 4006 0000 7f00 0001
        0x0010:  7f00 0001]{c54e 18eb 7c1d d1ad 9576 97dc
        0x0020:  8018 1838 fe36 0000 0101 080a 0b7b 2631
        0x0030:  0b7b 1eb4}2a31 0d0a 2434 0d0a 7069 6e67
        0x0040:  0d0a

IP 层
a) 0x4 4bit， ip 协议版本 0x4 表示 IPv4。
b) 0x5 4bit，ip首部长度
c) 0x00 8bit，服务类型 TOS 现在大多数的TCP/IP实现都不支持TOS特性 。可以看到，本报文 TOS 字段为全 0
d) 0x0042 16bit， IP 报文总长度 单位字节，换算下来，该数据报的长度为 66 字节，数一下上面的报文，恰好 66B。
从占位数来算， IP 数据报最长为 2^16=65535B，但大部分网络的链路层 MTU（最大传输单元）没有这么大，一些上层协议或主机也不会接受这么大的，故超长 IP 数据报在传输时会被分片
e) 0x0000 16bit，标识  唯一的标识主机发送的每一个数据报。通常每发送一个报文，它的值+1。当 IP 报文分片时，该标识字段值被复制到所有数据分片的标识字段中，使得这些分片在达到最终目的地时可以依照标识字段的内容重新组成原先的数据。
f) 0x4000 3bit 标志 + 13bit 片偏移 3bit 标志对应 R、DF、MF。目前只有后两位有效，DF位：为1表示不分片，为0表示分片。MF：为1表示“更多的片”，为0表示这是最后一片。
13bit 片位移：本分片在原先数据报文中相对首位的偏移位。（需要再乘以8）
g) 0x40 8bit 生存时间TTL IP 报文所允许通过的路由器的最大数量。每经过一个路由器，TTL减1，当为 0 时，路由器将该数据报丢弃。TTL 字段是由发送端初始设置一个 8 bit字段.推荐的初始值由分配数字 RFC 指定。发送 ICMP 回显应答时经常把 TTL 设为最大值 255。TTL可以防止数据报陷入路由循环。
h) 0x06 8bit 协议 指出 IP 报文携带的数据使用的是哪种协议，以便目的主机的IP层能知道要将数据报上交到哪个进程。TCP 的协议号为6，UDP 的协议号为17。ICMP 的协议号为1，IGMP 的协议号为2。该 IP 报文携带的数据使用 TCP 协议，得到了验证。
i) 0x0000 16bit IP 首部校验和
j) 0x7f000001 32bit 源地址
k) 0x7f000001 32bit 目的地址

TCP 层
a) 0xc54e  16bit，源端口
b) 0x11eb 16bit，目的端口
c) 0x7c1dd1ad 32bit，序号
d) 0x957697dc 32bit，确认号
e) 0x8 4bit，TCP 报文首部长度  也叫 offset，其实也就是数据从哪里开始。8 * 4 = 32B,因此该 TCP 报文的可选部分长度为 32 - 20 = 12B，这个资源还是很紧张的！ 同 IP 头部类似，最大长度为 60B。
f) 0b000000 6bit, 保留位 保留为今后使用，但目前应置为 0。
g) 0b011000 6bit，TCP 标志位 上图可以看到，从左到右依次是紧急 URG、确认 ACK、推送 PSH、复位 RST、同步 SYN 、终止 FIN。 从抓包可以看出，该报文是带了 ack 的，所以 ACK 标志位置为 1。
h) 0x1838 16bit，滑动窗口大小 解析得到十进制 6200，跟 tcpdump 解析的 win 字段一致。
i) 0xfe36 16bit，校验和 由发送端填充，接收端对 TCP 报文段执行 CRC 算法，以检验 TCP 报文段在传输过程中是否损坏，如果损坏这丢弃。 检验范围包括首部和数据两部分，这也是 TCP 可靠传输的一个重要保障
j) 0x0000 16bit，紧急指针 仅在 URG = 1 时才有意义，它指出本报文段中的紧急数据的字节数。 当 URG = 1 时，发送方 TCP 就把紧急数据插入到本报文段数据的最前面，而在紧急数据后面的数据仍是普通数据。

TCP可选项
a) 0x01 NOP 填充，没有 Length 和 Value 字段， 用于将TCP Header的长度补齐至 32bit 的倍数
b) 0x01 同上。
c) 0x080a 可选项类型为时间戳，len为 10B，value 为0x0b7b 0x2631 0x0b7b 0x1eb4，加上 0x080a，恰好 10B!
启用 Timestamp Option后，该字段包含2 个 32bit 的Timestamp（TS val 和 TS ecr）。
d) 0x0b7b 0x2631 解析后得到 192620081，恰好与 tcpdump 解析到的 TS 字段的 val一致！
e) 0x0b7b 0x1eb4 解析后得到 192618164，恰好与 tcpdump 解析到的 TS 字段的 ecr一致！

该 IP 报文长度为 66B，IP 头长度为 20B，TCP 头部长度为 32B，因此得到数据的长度为 66 - 20 - 32 = 14B，这与 tcpdump 解析到的 length 字段一致

ascii 表 (man 7 ascii)

0x2a31         -&gt; *1
0x0d0a         -&gt; \r\n
0x2434         -&gt; $4
0x0d0a         -&gt; \r\n
0x7069 0x6e67  -&gt; ping
0x0d0a         -&gt; \r\n

    09:18:06.471069 IP 127.0.0.1.6379 &gt; 127.0.0.1.50510: Flags [.], ack 32, win 6379, options [nop,nop,TS val 192620081 ecr 192620081], length 0
        0x0000:  4500 0034 0000 4000 4006 0000 7f00 0001
        0x0010:  7f00 0001 18eb c54e 9576 97dc 7c1d d1bb
        0x0020:  8010 18eb fe28 0000 0101 080a 0b7b 2631
        0x0030:  0b7b 2631
    09:18:06.471115 IP 127.0.0.1.6379 &gt; 127.0.0.1.50510: Flags [P.], seq 11469:11476, ack 32, win 6379, options [nop,nop,TS val 192620081 ecr 192620081], length 7: RESP "PONG" // 返回的数据
        0x0000:  4500 003b 0000 4000 4006 0000 7f00 0001
        0x0010:  7f00 0001 18eb c54e 9576 97dc 7c1d d1bb
        0x0020:  8018 18eb fe2f 0000 0101 080a 0b7b 2631
        0x0030:  0b7b 2631 2b50 4f4e 470d 0a
    09:18:06.471132 IP 127.0.0.1.50510 &gt; 127.0.0.1.6379: Flags [.], ack 11476, win 6200, options [nop,nop,TS val 192620081 ecr 192620081], length 0
        0x0000:  4500 0034 0000 4000 4006 0000 7f00 0001
        0x0010:  7f00 0001 c54e 18eb 7c1d d1bb 9576 97e3
        0x0020:  8010 1838 fe28 0000 0101 080a 0b7b 2631
        0x0030:  0b7b 2631
</code></pre></div></div>

<p>step4: tcpdump 补充 filter可以简单地分为三类：type, dir 和 proto。</p>

<ul>
  <li>type 区分报文的类型，主要由 host（主机）, net（网络，支持 CIDR） 和 port(支持范围，如 portrange 21-23) 组成。</li>
  <li>dir 区分方向，主要由 src 和 dst 组成。</li>
  <li>proto 区分协议支持 tcp、udp 、icmp 等。</li>
</ul>

<p>下面说几个 filter 表达式。</p>

<p>proto[x:y] start at offset x into the proto header and read y bytes</p>

<p>[x] abbreviation for [x:1]</p>

<p>注意：单位是字节，不是位！</p>

<p>打印特定 TCP Flag 的数据包</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TCP Flags 在 tcpdump 抓取的报文中的体现：
[S]：SYN（开始连接）
[.]: 没有 Flag
[P]: PSH（推送数据）
[F]: FIN （结束连接）
[R]: RST（重置连接）
[S.] SYN-ACK，就是 SYN 报文的应答报文。

tcpdump 'tcp[13] &amp; 16!=0'
# 等价于
tcpdump 'tcp[tcpflags] == tcp-ack'
</code></pre></div></div>

<h3 id="http-server-三次握手四次挥手">HTTP Server （三次握手，四次挥手）</h3>

<p>简单的搭建一个<code class="highlighter-rouge">http server</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@0384b25d7893 ~]# cat nchttp.sh
PORT=$1
while true; do ( echo "HTTP/1.0 200 Ok"; echo; echo "TEST TASK" ) | nc -l $PORT; done
</code></pre></div></div>

<p>启动脚本</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@0384b25d7893 ~]# sh nchttp.sh 8000

</code></pre></div></div>

<p>检查端口8000  一个IPV4, 一个IPV6 监听文件描述符</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@0384b25d7893 myphp]# netstat -nalp |grep 8000
tcp        0      0 0.0.0.0:8000            0.0.0.0:*               LISTEN      8832/nc
tcp6       0      0 :::8000                 :::*                    LISTEN      8832/nc
[root@0384b25d7893 myphp]#
</code></pre></div></div>

<p>运行curl 请求</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@0384b25d7893 myphp]# curl http://localhost:8000/?a=b
</code></pre></div></div>

<p>服务端连接断开(过2MSL 周期自动断开)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@0384b25d7893 myphp]# netstat -nalp |grep 8000
tcp        0      0 0.0.0.0:8000            0.0.0.0:*               LISTEN      8844/nc
tcp        0      0 127.0.0.1:8000          127.0.0.1:36512         TIME_WAIT   -
tcp6       0      0 :::8000                 :::*                    LISTEN      8844/nc
</code></pre></div></div>

<p><code class="highlighter-rouge">tcpdump</code> 抓到的数据包</p>

<p><img src="/assets/media/WX20200226-133908.png" alt="tcpdump package" /></p>

<p>数据解读</p>

<ul>
  <li>[S] (SYN)</li>
  <li>[S.] (SYN ACK)</li>
  <li>[F] (FIN)</li>
  <li>[F.] (FIN ACK)</li>
  <li>[P.] (PUSH ACK)</li>
</ul>

<p>第一列 用于标识行</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 06:38:46.052767 IP localhost.36258 &gt; localhost.irdmi: Flags [S], seq 3125423480, win 43690, options [mss 65495,sackOK,TS val 3395569 ecr 0,nop,wscale 7], length 0
2 05:38:46.052809 IP localhost.irdmi &gt; localhost.36258: Flags [S.], seq 4241729365, ack 3125423481, win 43690, options [mss 65495,sackOK,TS val 3395569 ecr 3395569,nop,wscale 7], length 0
3 05:38:46.052847 IP localhost.36258 &gt; localhost.irdmi: Flags [.], ack 1, win 342, options [nop,nop,TS val 3395569 ecr 3395569], length 0

4 05:38:46.053017 IP localhost.irdmi &gt; localhost.36258: Flags [P.], seq 1:28, ack 1, win 342, options [nop,nop,TS val 3395570 ecr 3395569], length 27

5 05:38:46.053056 IP localhost.irdmi &gt; localhost.36258: Flags [F.], seq 28, ack 1, win 342, options [nop,nop,TS val 3395570 ecr 3395569], length 0

6 05:38:46.054869 IP localhost.36258 &gt; localhost.irdmi: Flags [.], ack 28, win 342, options [nop,nop,TS val 3395570 ecr 3395570], length 0
7 05:38:46.055778 IP localhost.36258 &gt; localhost.irdmi: Flags [P.], seq 1:83, ack 29, win 342, options [nop,nop,TS val 3395570 ecr 3395570], length 82

8 05:38:46.055870 IP localhost.irdmi &gt; localhost.36258: Flags [.], ack 83, win 342, options [nop,nop,TS val 3395570 ecr 3395570], length 0
9 05:38:46.058091 IP localhost.36258 &gt; localhost.irdmi: Flags [F.], seq 83, ack 29, win 342, options [nop,nop,TS val 3395570 ecr 3395570], length 0
10 05:38:46.058153 IP localhost.irdmi &gt; localhost.36258: Flags [.], ack 84, win 342, options [nop,nop,TS val 3395570 ecr 3395570], length 0
</code></pre></div></div>

<p>localhost.36258(定为客户端)
localhost.irdmi(定为服务端)</p>

<h4 id="三次握手">三次握手</h4>

<p>Line 1 客户端发起连接请求 Flags[S] seq 3125423480 win 43690</p>

<p>Line 2 服务端发起连接请求，并应答客户端连接请求  Flags[S.] seq 4241729365 ack 3125423481 (Line 1 seq + 1 = ack) win 43690</p>

<p>Line 3 客户端应答服务端连接请求 Flags[.] ack 1 win 342</p>

<h4 id="四次挥手">四次挥手</h4>

<p>Line 5 服务端主动关闭连接 Flags[F.]</p>

<p>Line 6-8 传输数据 服务端不在主动发数据，等待客户端ack确认</p>

<p>Line 9 客户端关闭连接 Flags[F.] 确认服务端ACK</p>

<p>Line 10 服务端给客户但发送 ACK</p>

<h2 id="实际应用场景">实际应用场景</h2>

<h3 id="参考">参考</h3>

<ul>
  <li><a href="https://baike.baidu.com/item/TCP%2FIP%E5%8D%8F%E8%AE%AE/212915?fromtitle=tcp%2Fip&amp;fromid=214077">TCP/IP协议</a></li>
  <li><a href="https://juejin.im/post/5a069b6d51882509e5432656">一篇文章带你熟悉 TCP/IP 协议（网络协议篇二）</a></li>
  <li><a href="https://item.jd.com/65489151254.html">Linux C编程一站式学习</a></li>
  <li><a href="https://datatracker.ietf.org/doc/rfc894/">rfc894</a></li>
  <li><a href="http://www.kancloud.cn:8080/lifei6671/tcp-ip">TCP/IP协议详解卷一</a></li>
  <li><a href="https://segmentfault.com/a/1190000015044878">从tcpdump抓包看TCP/IP协议</a></li>
</ul>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    February
    24th,
    
    2020
  </span>

  <h2>
    <a href="/php/2020/02/24/supervisor-script-suspended-animation.html">supervisor 运行的PHP脚本假死排查</a>
  </h2>

  <div>
    
    <p>supervisor status</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ ~]$ sudo supervisorctl -c /etc/supervisord.conf status
....bigdata-lodgeunit-state_01   RUNNING   pid 27801, uptime 47 days, 0:50:00
....prepare_09                   RUNNING   pid 5159, uptime 20 days, 11:13:15
</code></pre></div></div>

<p>strace 命令查看一下系统调用情况</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[]$ strace -p 27801
Process 27801 attached
restart_syscall(&lt;... resuming interrupted call ...&gt;) = 0
rt_sigaction(SIGPIPE, NULL, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, 8) = 0
rt_sigaction(SIGPIPE, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, NULL, 8) = 0
poll([{fd=19, events=POLLIN|POLLPRI|POLLRDNORM|POLLRDBAND}], 1, 0) = 0 (Timeout)
rt_sigaction(SIGPIPE, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, NULL, 8) = 0
poll([{fd=19, events=POLLIN}], 1, 1000) = 0 (Timeout)
rt_sigaction(SIGPIPE, NULL, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, 8) = 0
rt_sigaction(SIGPIPE, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, NULL, 8) = 0
poll([{fd=19, events=POLLIN|POLLPRI|POLLRDNORM|POLLRDBAND}], 1, 0) = 0 (Timeout)
rt_sigaction(SIGPIPE, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, NULL, 8) = 0
poll([{fd=19, events=POLLIN}], 1, 1000) = 0 (Timeout)
rt_sigaction(SIGPIPE, NULL, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, 8) = 0
rt_sigaction(SIGPIPE, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, NULL, 8) = 0
poll([{fd=19, events=POLLIN|POLLPRI|POLLRDNORM|POLLRDBAND}], 1, 0) = 0 (Timeout)
rt_sigaction(SIGPIPE, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, NULL, 8) = 0
poll([{fd=19, events=POLLIN}], 1, 1000) = 0 (Timeout)
rt_sigaction(SIGPIPE, NULL, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, 8) = 0
rt_sigaction(SIGPIPE, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, NULL, 8) = 0
poll([{fd=19, events=POLLIN|POLLPRI|POLLRDNORM|POLLRDBAND}], 1, 0) = 0 (Timeout)
rt_sigaction(SIGPIPE, {SIG_IGN, [PIPE], SA_RESTORER|SA_RESTART, 0x7ffff4a56670}, NULL, 8) = 0
poll([{fd=19, events=POLLIN}], 1, 1000^CProcess 27801 detached
 &lt;detached ...&gt;
 )
</code></pre></div></div>

<p>lsof 查看一下文件下运行的服务(socket)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[]$ lsof -d 19 |grep 27801
php     27801  www   19u     IPv4          430131931      0t0       TCP localhost:9411-&gt;localhost:9411 (ESTABLISHED)
</code></pre></div></div>

<p>gdb查看一下</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
[]$ gdb -p 27801
.....
.....
Loaded symbols for /lib64/libnss_dns.so.2
0x00007ffff4b0cbb0 in __poll_nocancel () from /lib64/libc.so.6
Missing separate debuginfos, use: debuginfo-install cyrus-sasl-lib-2.1.26-19.2.el7.x86_64 freetype-2.4.11-11.el7.x86_64 glibc-2.17-105.el7.x86_64 gmp-6.0.0-11.el7.x86_64 keyutils-libs-1.5.8-3.el7.x86_64 krb5-libs-1.13.2-10.el7.x86_64 libcom_err-1.42.9-7.el7.x86_64 libgcc-4.8.5-4.el7.x86_64 libjpeg-turbo-1.2.90-5.el7.x86_64 libpng-1.5.13-5.el7.x86_64 libselinux-2.2.2-6.el7.x86_64 libstdc++-4.8.5-4.el7.x86_64 libxml2-2.9.1-5.el7_1.2.x86_64 nspr-4.10.8-2.el7_1.x86_64 nss-3.19.1-18.el7.x86_64 nss-softokn-freebl-3.16.2.3-13.el7_1.x86_64 nss-util-3.19.1-4.el7_1.x86_64 openldap-2.4.40-8.el7.x86_64 openssl-libs-1.0.1e-42.el7.9.x86_64 pcre-8.32-15.el7.x86_64 xz-libs-5.1.2-12alpha.el7.x86_64 zlib-1.2.7-15.el7.x86_64
(gdb) bt
#0  0x00007ffff4b0cbb0 in __poll_nocancel () from /lib64/libc.so.6
#1  0x00007ffff5db3d49 in Curl_poll () from /usr/local/xzsoft/curl/lib/libcurl.so.4
#2  0x00007ffff5daf0c0 in curl_multi_wait () from /usr/local/xzsoft/curl/lib/libcurl.so.4
#3  0x00007ffff5da942c in curl_easy_perform () from /usr/local/xzsoft/curl/lib/libcurl.so.4
#4  0x0000000000585b49 in zif_curl_exec (execute_data=&lt;optimized out&gt;, return_value=0x7ffff2a14ed0) at /home/xzapps/zhaopeng/php-7.1.15/ext/curl/interface.c:3043
#5  0x000000000083ea80 in ZEND_DO_FCALL_SPEC_RETVAL_USED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:1099
#6  0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#7  0x000000000083ed95 in ZEND_DO_FCALL_SPEC_RETVAL_UNUSED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:949
#8  0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#9  0x000000000083e915 in ZEND_DO_FCALL_SPEC_RETVAL_USED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:1076
#10 0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#11 0x000000000083ed95 in ZEND_DO_FCALL_SPEC_RETVAL_UNUSED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:949
#12 0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#13 0x000000000083ed95 in ZEND_DO_FCALL_SPEC_RETVAL_UNUSED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:949
#14 0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#15 0x000000000083e915 in ZEND_DO_FCALL_SPEC_RETVAL_USED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:1076
#16 0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#17 0x000000000083e915 in ZEND_DO_FCALL_SPEC_RETVAL_USED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:1076
#18 0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#19 0x000000000083e915 in ZEND_DO_FCALL_SPEC_RETVAL_USED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:1076
#20 0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#21 0x000000000083e915 in ZEND_DO_FCALL_SPEC_RETVAL_USED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:1076
#22 0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#23 0x000000000083e915 in ZEND_DO_FCALL_SPEC_RETVAL_USED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:1076
#24 0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#25 0x000000000083dccf in ZEND_CALL_TRAMPOLINE_SPEC_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:1991
#26 0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#27 0x000000000083e915 in ZEND_DO_FCALL_SPEC_RETVAL_USED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:1076
#28 0x00000000007edd9b in execute_ex (ex=&lt;optimized out&gt;) at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:429
#29 0x000000000083e915 in ZEND_DO_FCALL_SPEC_RETVAL_USED_HANDLER () at /home/xzapps/zhaopeng/php-7.1.15/Zend/zend_vm_execute.h:1076

</code></pre></div></div>

<p>代码搜索</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[]$ grep 'localhost:9411' -r .
./vendor/xiaozhu/tracker/src/Tracker.php:            $host = getenv('ZIP_KIN_HOST') ?: 'localhost:9411';
^C
[]$

</code></pre></div></div>

<p>curl 超时缺少设置</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$host = getenv('ZIP_KIN_HOST') ?: 'localhost:9411';
$ch   = curl_init("http://".$host."/api/v2/spans");
$body = json_encode($spans);
curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type:application/json']);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$result = curl_exec($ch);
curl_close($ch);
</code></pre></div></div>

<p>新增超时配置项</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 在尝试连接时等待的秒数
curl_setopt($curl, CURLOPT_CONNECTTIMEOUT , 120);
// 最大执行时间
curl_setopt($curl, CURLOPT_TIMEOUT, 120);
</code></pre></div></div>

    
  </div>

</article>


<article class="home">

  <span class="post-date">
    
    February
    24th,
    
    2020
  </span>

  <h2>
    <a href="/linux/load/2020/02/24/high-machine-load.html">机器高负载排查</a>
  </h2>

  <div>
    
    <h3 id="可以查询机器负载的命令">可以查询机器负载的命令</h3>

<p>三个命令：<code class="highlighter-rouge">w</code>, <code class="highlighter-rouge">uptime</code>, <code class="highlighter-rouge">top</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[www@cloud-test-env79 ~]$ w
 16:36:59 up  2:23,  1 user,  load average: 19.02, 18.69, 18.31
 USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
 www      pts/1    10.3.2.67        16:36    2.00s  0.00s  0.00s w


[www@cloud-test-env79 ~]$ uptime
 16:40:56 up  2:27,  1 user,  load average: 18.40, 18.24, 18.20


top - 16:41:09 up  2:27,  1 user,  load average: 18.25, 18.21, 18.19

</code></pre></div></div>

<h3 id="什么是机器负载load-平均负载-load-average">什么是机器负载Load? 平均负载 Load Average</h3>

<p>Load 就是对计算机干活多少的度量（WikiPedia：the system Load is a measure of the amount of work that a compute system is doing）简单的说是进程队列的长度。Load Average 就是一段时间（1分钟、5分钟、15分钟）内平均Load</p>

<h3 id="如何判断over-load">如何判断Over Load</h3>

<p>一般来说，根据CPU数量判断，如果平均负载始终再<code class="highlighter-rouge">1.2</code>以下，机器是<code class="highlighter-rouge">2</code>颗 <code class="highlighter-rouge">CPU</code>。那么基本不会出现CPU不够用的情况。
也就是Load平均要小于CPU的数量，一般会根据15分钟那个load的平均值。</p>

<p>一般而言，服务器的合理负载是<code class="highlighter-rouge">CPU核数*2</code>。也就是说对于8核的CPU，负载在16以内表明机器运行很稳定流畅。如果负载超过16了，就说明服务器的运行有一定的压力了。</p>

<h3 id="我们如何排查机器高负载">我们如何排查机器高负载</h3>

<h4 id="vmstat是virtual-meomory-statistics虚拟内存统计的缩写可实时动态监视操作系统的虚拟内存进程cpu活动">vmstat是Virtual Meomory Statistics（虚拟内存统计）的缩写，可实时动态监视操作系统的虚拟内存、进程、CPU活动。</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 18  0  16640 221116      0 1426276    0    1   133   195 2053  591 78 14  7  0  0
 23  0  16640 245128      0 1426836    0    0     0    66 4208 1059 86 14  0  0  0
 19  0  16640 227160      0 1427340    0    0     0    37 4144 1040 85 15  0  0  0
 16  0  16640 259528      0 1428076    0    0     0   329 4090 1001 85 15  0  0  0
 13  0  16640 261376      0 1428476    0    0     0     0 4087 1042 84 16  0  0  0
</code></pre></div></div>

<p>字段说明</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Procs（进程）:
    r: 运行队列中进程数量 (如果长期大于1，说明cpu不足，需要增加cpu。)
    b: 等待IO的进程数量 (比如正在等待I/O、或者内存交换等。)
    Memory（内存）:
    swpd: 使用虚拟内存大小
    free: 可用内存大小
    buff: 用作缓冲的内存大小
    cache: 用作缓存的内存大小
Swap:
    si: 每秒从交换区写到内存的大小
    so: 每秒写入交换区的内存大小
IO：（现在的Linux版本块的大小为1024bytes）
    bi: 每秒读取的块数
    bo: 每秒写入的块数
system：
    in: 每秒中断数，包括时钟中断
    cs: 每秒上下文切换数
CPU（以百分比表示）
    us: 用户进程执行时间(user time)
    sy: 系统进程执行时间(system time)
    id: 空闲时间(包括IO等待时间)
    wa: 等待IO时间
</code></pre></div></div>

<h4 id="iostat-查看io负载">iostat 查看IO负载</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[www@cloud-test-env79 ~]$ iostat 1 1
Linux 3.10.0-957.21.3.el7.x86_64 (cloud-test-env79)     02/24/2020      _x86_64_        (2 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
          79.06    0.00   14.45    0.04    0.00    6.46

Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               1.29        24.13         4.30     255262      45469
sdb              22.42       216.43       362.11    2289445    3830471
dm-0              0.87        21.18         1.65     224015      17504
dm-1              0.74         0.58         2.45       6156      25904
</code></pre></div></div>

<p>avg-cpu: 总体cpu使用情况统计信息，对于多核cpu，这里为所有cpu的平均值</p>
<ul>
  <li>%user: 在用户级别运行所使用的CPU的百分比.</li>
  <li>%nice: nice操作所使用的CPU的百分比.</li>
  <li>%sys: 在系统级别(kernel)运行所使用CPU的百分比.</li>
  <li>%iowait: CPU等待硬件I/O时,所占用CPU百分比.</li>
  <li>%idle: CPU空闲时间的百分比.</li>
</ul>

<p>Device段:各磁盘设备的IO统计信息</p>
<ul>
  <li>tps: 每秒钟发送到的I/O请求数.</li>
  <li>Blk_read /s: 每秒读取的block数.</li>
  <li>Blk_wrtn/s: 每秒写入的block数.</li>
  <li>Blk_read: 读入的block总数.</li>
  <li>Blk_wrtn: 写入的block总数.</li>
</ul>

<h4 id="sar-找出系统瓶颈的利器">sar 找出系统瓶颈的利器</h4>

<p>查看CPU使用率 <code class="highlighter-rouge">sar -u</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
02:13:57 PM       LINUX RESTART

02:20:01 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
02:30:01 PM     all     38.17      0.00      6.64      0.02      0.00     55.17
02:40:02 PM     all     84.96      0.00     15.01      0.00      0.00      0.03
02:50:01 PM     all     84.93      0.00     15.03      0.00      0.00      0.04
03:00:01 PM     all     84.69      0.00     15.27      0.00      0.00      0.04
03:10:01 PM     all     84.62      0.00     15.35      0.00      0.00      0.04
03:20:01 PM     all     83.92      0.00     16.05      0.00      0.00      0.03
03:30:01 PM     all     84.98      0.00     14.98      0.00      0.00      0.04
03:40:02 PM     all     84.88      0.00     15.07      0.00      0.00      0.05
03:50:01 PM     all     84.63      0.00     15.34      0.00      0.00      0.03
04:00:02 PM     all     84.86      0.00     15.09      0.00      0.00      0.04
04:10:02 PM     all     84.56      0.00     15.41      0.00      0.00      0.04
04:20:01 PM     all     83.73      0.00     16.24      0.00      0.00      0.03
04:30:02 PM     all     83.97      0.00     15.99      0.00      0.00      0.04
04:40:01 PM     all     83.84      0.00     16.13      0.00      0.00      0.03
04:50:02 PM     all     84.77      0.00     15.22      0.00      0.00      0.01
Average:        all     81.44      0.00     14.86      0.00      0.00      3.71

</code></pre></div></div>
<p>可以看到这台机器使用了虚拟化技术，有相应的时间消耗； 各列的指标分别是:</p>

<ul>
  <li>%user 用户模式下消耗的CPU时间的比例；</li>
  <li>%nice 通过nice改变了进程调度优先级的进程，在用户模式下消耗的CPU时间的比例</li>
  <li>%system 系统模式下消耗的CPU时间的比例；</li>
  <li>%iowait CPU等待磁盘I/O导致空闲状态消耗的时间比例；</li>
  <li>%steal 利用Xen等操作系统虚拟化技术，等待其它虚拟CPU计算占用的时间比例；</li>
  <li>%idle CPU空闲时间比例；</li>
</ul>

<p>查看平均负载(sar -q)</p>

<p>指定-q后，就能查看运行队列中的进程数、系统上的进程大小、平均负载等；与其它命令相比，它能查看各项指标随时间变化的情况；</p>

<ul>
  <li>runq-sz：运行队列的长度（等待运行的进程数）</li>
  <li>plist-sz：进程列表中进程（processes）和线程（threads）的数量</li>
  <li>ldavg-1：最后1分钟的系统平均负载 ldavg-5：过去5分钟的系统平均负载</li>
  <li>ldavg-15：过去15分钟的系统平均负载</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>02:13:57 PM       LINUX RESTART

02:20:01 PM   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked
02:30:01 PM        23       215     18.70     10.79      4.67         0
02:40:02 PM        15       204     18.32     17.53     11.33         0
02:50:01 PM        17       202     17.31     17.35     14.18         0
03:00:01 PM         5       202     17.28     17.45     15.75         0
03:10:01 PM        15       201     16.86     17.47     16.60         0
03:20:01 PM        18       201     17.40     17.73     17.32         0
03:30:01 PM        17       202     17.98     17.60     17.43         0
03:40:02 PM        18       199     16.85     17.40     17.45         0
03:50:01 PM        19       205     18.94     18.30     17.80         0
04:00:02 PM        18       204     17.58     17.65     17.68         0
04:10:02 PM        19       208     18.68     18.29     18.00         1
04:20:01 PM        19       200     17.22     18.03     18.09         0
04:30:02 PM        21       211     18.28     17.87     17.96         0
04:40:01 PM        16       205     17.54     18.13     18.17         0
04:50:02 PM        17       202     17.72     17.79     18.01         0
Average:           17       204     17.78     17.29     16.03         0
</code></pre></div></div>

<p>查看内存使用状况(sar -r)</p>

<p>字段注解：</p>
<ul>
  <li>kbmemfree：这个值和free命令中的free值基本一致,所以它不包括buffer和cache的空间.</li>
  <li>kbmemused：这个值和free命令中的used值基本一致,所以它包括buffer和cache的空间.</li>
  <li>%memused：物理内存使用率，这个值是kbmemused和内存总量(不包括swap)的一个百分比.</li>
  <li>kbbuffers和kbcached：这两个值就是free命令中的buffer和cache.</li>
  <li>kbcommit：保证当前系统所需要的内存,即为了确保不溢出而需要的内存(RAM+swap).</li>
  <li>%commit：这个值是kbcommit与内存总量(包括swap)的一个百分比.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>02:13:57 PM       LINUX RESTART

02:20:01 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
02:30:01 PM    449916   3430448     88.41       948    925236   3204692     53.61   1564160    727752     74388
02:40:02 PM    250496   3629868     93.54        76    642292   3434756     57.46   1918776    577624      2896
02:50:01 PM    217472   3662892     94.40        76    646180   3468536     58.03   1874572    655268      1220
03:00:01 PM    200560   3679804     94.83        76    645484   3483892     58.28   1869832    677108      1400
03:10:01 PM    232804   3647560     94.00        36    687240   3407608     57.01   1824896    690028      1812
03:20:01 PM    237268   3643096     93.89         0    658572   3502412     58.59   1764740    801092      2316
03:30:01 PM    285796   3594568     92.63         0    674780   3493840     58.45   1752620    832220      2832
03:40:02 PM    297988   3582376     92.32         0    744884   3409472     57.04   1748868    820916      1592
03:50:01 PM    193656   3686708     95.01         0    929264   3597268     60.18   1823876   1070348      3652
04:00:02 PM    168556   3711808     95.66         0    944632   3562620     59.60   1847804   1070788       856
04:10:02 PM    170684   3709680     95.60         0    964628   3529120     59.04   1829056   1059360      2620
04:20:01 PM    251432   3628932     93.52         0    911876   3475648     58.15   1772392   1034332      2792
04:30:02 PM    276664   3603700     92.87         0    929752   3433156     57.43   1746496   1030228      3652
04:40:01 PM    353412   3526952     90.89         0    848160   3414616     57.12   1687536    993700       944
04:50:02 PM    244372   3635992     93.70         0    914408   3458112     57.85   1802704    986708       620
Average:       255405   3624959     93.42        81    804493   3458383     57.86   1788555    868498      6906

</code></pre></div></div>

<p>查看页面交换发生状况(sar -W)</p>

<p>页面发生交换时，服务器的吞吐量会大幅下降；服务器状况不良时，如果怀疑因为内存不足而导致了页面交换的发生，可以使用这个命令来确认是否发生了大量的交换；</p>

<ul>
  <li>pswpin/s：每秒系统换入的交换页面（swap page）数量</li>
  <li>pswpout/s：每秒系统换出的交换页面（swap page）数量</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>02:13:57 PM       LINUX RESTART

02:20:01 PM  pswpin/s pswpout/s
02:30:01 PM      0.00      0.00
02:40:02 PM      0.00      0.03
02:50:01 PM      0.04      0.65
03:00:01 PM      0.08      0.83
03:10:01 PM      0.09      0.20
03:20:01 PM      0.25      0.45
03:30:01 PM      0.12      0.39
03:40:02 PM      0.07      0.00
03:50:01 PM      0.24      0.84
04:00:02 PM      0.04      0.30
04:10:02 PM      0.16      0.74
04:20:01 PM      0.31      1.20
04:30:02 PM      0.08      0.84
04:40:01 PM      0.33      2.06
04:50:02 PM      0.07      0.00
Average:         0.13      0.57
</code></pre></div></div>

<p>要判断系统瓶颈问题，有时需几个 sar 命令选项结合起来；</p>

<ul>
  <li>怀疑CPU存在瓶颈，可用 sar -u 和 sar -q 等来查看</li>
  <li>怀疑内存存在瓶颈，可用sar -B、sar -r 和 sar -W 等来查看</li>
  <li>怀疑I/O存在瓶颈，可用 sar -b、sar -u 和 sar -d 等来查看</li>
</ul>


    
  </div>

</article>

<hr/>

<ul class="pager"> 

  
  <li class="previous disabled">
    <a>&larr; Newer</a>
  </li>
  
  
  <li>
    <span class="page_number">Page: 1 of 3</span>
  </li>

  
  <li class="next">
    <a href="/page2">Older &rarr;</a>
  </li>
  

</ul>




		<footer>
			<hr/>
			<p>
				&copy; 2020 JY with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



